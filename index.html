<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MediQueue - Login</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: linear-gradient(to bottom right, #f8fafc, #e0e7ff);
            min-height: 100vh;
        }
    </style>
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            setPersistence,
            browserLocalPersistence,
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            updateProfile
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore,
            doc,
            setDoc
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- App Configuration ---
        const firebaseConfig = {
          apiKey: "AIzaSyDqdSzRr29kDUH-eDwXTSg_dImTOqyYCiU",
          authDomain: "main-8c336.firebaseapp.com",
          projectId: "main-8c336",
          storageBucket: "main-8c336.firebasestorage.app",
          messagingSenderId: "507656529909",
          appId: "1:507656529909:web:ccea008f4a1178bf0da2bc",
          measurementId: "G-RX4KHQRQMJ"
        };
        const appId = firebaseConfig.projectId;
        const ADMIN_EMAIL = "prajansanjayko@gmail.com";

        // --- Initialization ---
        window.onload = async () => {
            // DOM Elements
            let db, auth;

            // Login
            let loginTitle, authForm, nameFieldContainer, authName, authEmail, authPassword, authError, authSubmitBtn, authToggleText, authToggleBtn;

            // Global Utilities
            let modal, modalMessage, modalCloseBtn;

            // App State
            let isLoginMode = true;

            // --- Initialize Firebase ---
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                await setPersistence(auth, browserLocalPersistence);
            } catch (error) {
                console.error("Firebase Init Error:", error);
                showModal("Error initializing app. Please check your Firebase config and refresh.");
                return;
            }

            // --- Get All DOM Elements ---
            loginTitle = document.getElementById('login-title');
            authForm = document.getElementById('auth-form');
            nameFieldContainer = document.getElementById('name-field-container');
            authName = document.getElementById('auth-name');
            authEmail = document.getElementById('auth-email');
            authPassword = document.getElementById('auth-password');
            authError = document.getElementById('auth-error');
            authSubmitBtn = document.getElementById('auth-submit-btn');
            authToggleText = document.getElementById('auth-toggle-text');
            authToggleBtn = document.getElementById('auth-toggle-btn');
            
            modal = document.getElementById('modal');
            modalMessage = document.getElementById('modal-message');
            modalCloseBtn = document.getElementById('modal-close-btn');

            // --- Authentication Logic ---

            function toggleAuthMode() {
                isLoginMode = !isLoginMode;
                if (authError) authError.style.display = 'none';
                if (isLoginMode) {
                    if (loginTitle) loginTitle.textContent = 'Log In to Your Account';
                    if (nameFieldContainer) nameFieldContainer.style.display = 'none';
                    if (authSubmitBtn) authSubmitBtn.textContent = 'Login';
                    if (authToggleText) authToggleText.textContent = "Don't have an account?";
                    if (authToggleBtn) authToggleBtn.textContent = 'Sign Up';
                } else {
                    if (loginTitle) loginTitle.textContent = 'Create a New Account';
                    if (nameFieldContainer) nameFieldContainer.style.display = 'flex';
                    if (authSubmitBtn) authSubmitBtn.textContent = 'Create Account';
                    if (authToggleText) authToggleText.textContent = 'Already have an account?';
                    if (authToggleBtn) authToggleBtn.textContent = 'Login';
                }
            }

            async function handleAuthSubmit(e) {
                e.preventDefault();
                const name = authName.value;
                const email = authEmail.value;
                const password = authPassword.value;

                if (!email || !password) {
                    if (authError) {
                        authError.textContent = 'Please enter both email and password.';
                        authError.style.display = 'block';
                    }
                    return;
                }

                if (!isLoginMode && !name) {
                    if (authError) {
                        authError.textContent = 'Please enter your name.';
                        authError.style.display = 'block';
                    }
                    return;
                }

                if (authSubmitBtn) {
                    authSubmitBtn.disabled = true;
                    authSubmitBtn.textContent = isLoginMode ? 'Logging in...' : 'Creating...';
                }
                if (authError) authError.style.display = 'none';

                try {
                    if (isLoginMode) {
                        await signInWithEmailAndPassword(auth, email, password);
                        // onAuthStateChanged will handle the redirect
                    } else {
                        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                        await updateProfile(userCredential.user, { displayName: name });
                        const profileRef = doc(db, `artifacts/${appId}/users/${userCredential.user.uid}/profile/details`);
                        await setDoc(profileRef, {
                            name: name,
                            mobile: ''
                        });
                        // onAuthStateChanged will handle the redirect
                    }
                } catch (error) {
                    console.error("Auth Error:", error);
                    if (authError) {
                        authError.textContent = error.message;
                        authError.style.display = 'block';
                    }
                    if (authSubmitBtn) {
                        authSubmitBtn.disabled = false;
                        authSubmitBtn.textContent = isLoginMode ? 'Login' : 'Create Account';
                    }
                }
            }

            // --- Global Utilities ---
            function showModal(message) {
                if (modalMessage) modalMessage.textContent = message;
                if (modal) modal.style.display = 'flex';
            }

            function closeModal() {
                if (modal) modal.style.display = 'none';
            }

            // --- Add Event Listeners ---
            if (authForm) authForm.addEventListener('submit', handleAuthSubmit);
            if (authToggleBtn) authToggleBtn.addEventListener('click', toggleAuthMode);
            if (modalCloseBtn) modalCloseBtn.addEventListener('click', closeModal);

            // --- NEW Auth State Change Listener (Redirection) ---
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    // User is logged in, decide where to send them
                    if (user.email === ADMIN_EMAIL) {
                        window.location.href = 'doctor.html'; // Redirect to doctor page
                    } else {
                        window.location.href = 'patient.html'; // Redirect to patient page
                    }
                } else {
                    // User is logged out, show the login view
                    // Since this is the only page, we just make sure the form is ready
                    console.log("User is logged out, showing login view.");
                    document.getElementById('login-view').style.display = 'flex';
                }
            });

        }; // <-- End of window.onload
    </script>
</head>
<body class="bg-gray-100 font-sans">

    <main>
        <div id="login-view" class="min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8" style="display: none;">
            <div class="max-w-md w-full space-y-8 bg-white p-10 rounded-lg shadow-xl">
                <div>
                    <h2 id="login-title" class="mt-6 text-center text-3xl font-extrabold text-gray-900">
                        Log In to Your Account
                    </h2>
                </div>
                <form id="auth-form" class="mt-8 space-y-6">
                    <input type="hidden" name="remember" value="true">
                    <div class="rounded-md shadow-sm -space-y-px">
                        <div id="name-field-container" class="flex-col" style="display: none;">
                            <label for="auth-name" class="sr-only">Name</label>
                            <input id="auth-name" name="name" type="text" autocomplete="name" class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-t-md focus:outline-none focus:ring-[hsl(149_52%_46%)] focus:border-[hsl(149_52%_46%)] focus:z-10 sm:text-sm" placeholder="Your Name">
                        </div>
                        <div>
                            <label for="auth-email" class="sr-only">Email address</label>
                            <input id="auth-email" name="email" type="email" autocomplete="email" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-t-md focus:outline-none focus:ring-[hsl(149_52%_46%)] focus:border-[hsl(149_52%_46%)] focus:z-10 sm:text-sm" placeholder="Email address">
                        </div>
                        <div>
                            <label for="auth-password" class="sr-only">Password</label>
                            <input id="auth-password" name="password" type="password" autocomplete="current-password" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-b-md focus:outline-none focus:ring-[hsl(149_52%_46%)] focus:border-[hsl(149_52%_46%)] focus:z-10 sm:text-sm" placeholder="Password">
                        </div>
                    </div>

                    <div id="auth-error" class="text-red-500 text-sm" style="display: none;"></div>

                    <div>
                        <button id="auth-submit-btn" type="submit" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-[hsl(149_52%_46%)] hover:bg-[hsl(149_52%_40%)] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[hsl(149_52%_46%)]">
                            Login
                        </button>
                    </div>
                </form>
                <div class="text-sm text-center">
                    <span id="auth-toggle-text">Don't have an account?</span>
                    <button id="auth-toggle-btn" class="font-medium text-[hsl(149_52%_46%)] hover:text-[hsl(149_52%_40%)]">
                        Sign Up
                    </button>
                </div>
            </div>
        </div>

        <div id="modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
            <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full mx-4">
                <h3 class="text-lg font-medium text-gray-900">Notification</h3>
                <p id="modal-message" class="mt-2 text-sm text-gray-600">This is an alert message.</p>
                <div class="mt-4 text-right">
                    <button id="modal-close-btn" type="button" class="inline-flex justify-center px-4 py-2 text-sm font-medium text-white bg-[hsl(149_52%_46%)] border border-transparent rounded-md hover:bg-[hsl(149_52%_40%)] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[hsl(149_52%_46%)]">
                        OK
                    </button>
                </div>
            </div>
        </div>
    </main>

</body>
</html>