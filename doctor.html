<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MediQueue - Doctor Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: linear-gradient(to bottom, #3b82f6, #8b5cf6);
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(to bottom, #2563eb, #7c3aed);
        }
        body {
            background: linear-gradient(to bottom right, #f8fafc, #e0e7ff);
            min-height: 100vh;
        }
    </style>
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            setPersistence,
            browserLocalPersistence,
            onAuthStateChanged,
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore,
            collection,
            addDoc,
            query,
            where,
            onSnapshot,
            serverTimestamp,
            doc,
            updateDoc,
            setDoc,
            getDoc,
            getDocs,
            orderBy,
            Timestamp,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- App Configuration ---
        const firebaseConfig = {
          apiKey: "AIzaSyDqdSzRr29kDUH-eDwXTSg_dImTOqyYCiU",
          authDomain: "main-8c336.firebaseapp.com",
          projectId: "main-8c336",
          storageBucket: "main-8c336.firebasestorage.app",
          messagingSenderId: "507656529909",
          appId: "1:507656529909:web:ccea008f4a1178bf0da2bc",
          measurementId: "G-RX4KHQRQMJ"
        };
        const appId = firebaseConfig.projectId;
        const ADMIN_EMAIL = "prajansanjayko@gmail.com";

        // --- Initialization ---
        window.onload = async () => {

            // DOM Elements
            let app, db, auth;

            // Views / Pages
            let doctorApp;
            let doctorPages = {};

            // Navbar
            let mainNav, patientNav, doctorNav, authControls, userDisplay, logoutBtn;
            let doctorNavDashboard, doctorNavCall, doctorNavExport, doctorNavAppointments, doctorNavFinancials, doctorNavSettings;
            let mobileMenu, mobileMenuBtn, mobileAuthControls, mobileUserDisplay, mobileLogoutBtn;
            let mobilePatientNav, mobileDoctorNav;

            // Doctor: Dashboard
            let welcomeMsg, liveDate, liveTime;
            let dailyLimitInput, saveLimitBtn, limitSaveStatus;
            
            // --- NEW MODERN DASHBOARD VARIABLES ---
            let waitingCountEl, seenCountEl, revenueEl;
            let upNextPatientCard, callPatientBtn;
            let aptList, aptMsg;
            // ------------------------------------
            
            // Doctor: Settings
            let settingsLatInput, settingsLonInput, settingsMaxDistanceInput, settingsSaveBtn, settingsStatusMsg;
            
            // Doctor: Financials
            let financialsTodayBtn, financialsWeekBtn, financialsMonthBtn, financialsCustomBtn;
            let financialsStartDateInput, financialsEndDateInput, financialsTotalRevenueEl, financialsAvgRevenueEl;
            let financialsTransactionCountEl, financialsTransactionsList, financialsExportBtn;

            // Doctor: Call Patient
            let doctorQueueList, doctorMessageEl;

            // Doctor: Notes Modal
            let notesModal, notesForm, notesText, notesSubmitBtn, notesCancelBtn;
            let notesFeeInput;
            let currentPatientForNotes = null;

            // Doctor: Export
            let exportBtn, exportDateInput;

            // Doctor: Appointments
            let docAptDateInput, docAptList, docAptMsg;

            // Global Utilities
            let loadingOverlay, modal, modalMessage, modalCloseBtn;

            // App State
            let currentUserId = null;
            let currentUserEmail = null;
            let currentUserDisplayName = null;
            let isAuthReady = false;
            let isAdmin = false; // Will be true in this file

            let doctorQueueUnsubscribe = null;
            let dashboardUnsubscribe = null;
            let timeUpdateInterval = null;

            // --- STATE FOR FINANCIALS FIX ---
            let currentFinancialsData = []; 

            // --- Initialize Firebase ---
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('Debug');
                await setPersistence(auth, browserLocalPersistence);
            } catch (error) {
                console.error("Firebase Init Error:", error);
                showModal("Error initializing app. Please check your Firebase config and refresh.");
                return;
            }

            // --- 2. Authentication Logic ---
            async function handleLogout() {
                await signOut(auth);
                window.location.href = 'index.html'; // Redirect to login page
            }

            // --- 3. Page Navigation Logic ---

            function showDoctorView(pageId) {
                if (!doctorApp) return;
                doctorApp.style.display = 'block';

                Object.values(doctorPages).forEach(page => page.style.display = 'none');
                if (doctorPages[pageId]) {
                    doctorPages[pageId].style.display = 'block';
                }

                [doctorNavDashboard, doctorNavCall, doctorNavExport, doctorNavAppointments, doctorNavFinancials, doctorNavSettings].forEach(btn => btn?.classList.remove('bg-gray-700', 'text-white'));

                if (dashboardUnsubscribe) dashboardUnsubscribe();
                if (doctorQueueUnsubscribe) doctorQueueUnsubscribe();
                if (timeUpdateInterval) clearInterval(timeUpdateInterval);

                if (pageId === 'dashboard') {
                    document.getElementById('doctor-nav-dashboard')?.classList.add('bg-gray-700', 'text-white');
                    updateTime();
                    timeUpdateInterval = setInterval(updateTime, 1000);
                    attachDashboardListeners();
                } else if (pageId === 'call') {
                    document.getElementById('doctor-nav-call')?.classList.add('bg-gray-700', 'text-white');
                    attachDoctorQueueListener();
                } else if (pageId === 'export') {
                    document.getElementById('doctor-nav-export')?.classList.add('bg-gray-700', 'text-white');
                    if(exportDateInput) exportDateInput.valueAsDate = new Date();
                } else if (pageId === 'appointments') {
                    document.getElementById('doctor-nav-appointments')?.classList.add('bg-gray-700', 'text-white');
                    if(docAptDateInput) docAptDateInput.valueAsDate = new Date();
                    loadDoctorAppointments();
                } else if (pageId === 'financials') {
                    document.getElementById('doctor-nav-financials')?.classList.add('bg-gray-700', 'text-white');
                    setTimeout(() => {
                        setupFinancialsButtons();
                        if (typeof updateFinancialsButtonStyle === 'function') {
                            updateFinancialsButtonStyle('today');
                        }
                        if (typeof loadFinancials === 'function') {
                            loadFinancials('today');
                        }
                    }, 200);
                } else if (pageId === 'settings') {
                    document.getElementById('doctor-nav-settings')?.classList.add('bg-gray-700', 'text-white');
                    loadSettingsIntoForm();
                }
            }

            // --- Settings Logic ---
            async function loadSettingsIntoForm() {
                if (!db) return;
                try {
                    const settingsRef = doc(db, `artifacts/${appId}/public/data/clinicSettings/settings`);
                    const settingsDoc = await getDoc(settingsRef);
                    if (settingsDoc.exists()) {
                        const data = settingsDoc.data();
                        if (settingsLatInput) settingsLatInput.value = data.latitude;
                        if (settingsLonInput) settingsLonInput.value = data.longitude;
                        if (settingsMaxDistanceInput) settingsMaxDistanceInput.value = data.maxDistanceMeters;
                    } else {
                        // Load defaults if doc doesn't exist
                        if (settingsLatInput) settingsLatInput.value = 12.94320783333333;
                        if (settingsLonInput) settingsLonInput.value = 80.15839316666666;
                        if (settingsMaxDistanceInput) settingsMaxDistanceInput.value = 100000;
                    }
                } catch (error) {
                    console.error("Error loading settings into form:", error);
                }
            }

            async function saveClinicSettings() {
                if (!db || !isAdmin) {
                    showModal("Only administrators can save clinic settings.");
                    return;
                }
                if (!settingsLatInput || !settingsLonInput || !settingsMaxDistanceInput) return;
                
                const lat = parseFloat(settingsLatInput.value);
                const lon = parseFloat(settingsLonInput.value);
                const maxDist = parseInt(settingsMaxDistanceInput.value);
                
                if (isNaN(lat) || isNaN(lon) || isNaN(maxDist) || lat < -90 || lat > 90 || lon < -180 || lon > 180 || maxDist < 0) {
                    showModal("Please enter valid coordinates and distance.");
                    return;
                }
                
                try {
                    const settingsRef = doc(db, `artifacts/${appId}/public/data/clinicSettings/settings`);
                    await setDoc(settingsRef, {
                        latitude: lat,
                        longitude: lon,
                        maxDistanceMeters: maxDist,
                        updatedAt: serverTimestamp()
                    });
                    
                    if (settingsStatusMsg) {
                        settingsStatusMsg.textContent = "Settings saved successfully!";
                        settingsStatusMsg.className = "text-sm text-green-600 mt-2";
                        settingsStatusMsg.style.display = 'block';
                    }
                    setTimeout(() => { if (settingsStatusMsg) settingsStatusMsg.style.display = 'none'; }, 3000);
                } catch (error) {
                    console.error("Error saving clinic settings:", error);
                    if (settingsStatusMsg) {
                        settingsStatusMsg.textContent = "Error saving settings.";
                        settingsStatusMsg.className = "text-sm text-red-600 mt-2";
                        settingsStatusMsg.style.display = 'block';
                    }
                }
            }

            
            // --- Financials Logic (with fixes) ---
			async function loadFinancials(range) {
			   if (!db) {
			      console.error("Database not initialized");
			      showModal("Database not initialized. Please refresh the page.");
			      return;
			   }
			   
			   // Show loading state
			   if (financialsTransactionsList) {
			      financialsTransactionsList.innerHTML = '<li class="text-center text-gray-500 py-8"><div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mb-3"></div><p class="text-gray-500">Loading financial data...</p></li>';
			   }
			   
			   let startDate, endDate;
			   const now = new Date();
			   now.setHours(23, 59, 59, 999);
			   
			   if (range === 'today') {
			      startDate = new Date(now);
			      startDate.setHours(0, 0, 0, 0);
			      endDate = now;
			   } else if (range === 'week') {
			      startDate = new Date(now);
			      startDate.setDate(startDate.getDate() - 6);
			      startDate.setHours(0, 0, 0, 0);
			      endDate = now;
			   } else if (range === 'month') {
			      startDate = new Date(now);
			      startDate.setDate(1);
			      startDate.setHours(0, 0, 0, 0);
			      endDate = now;
			   } else if (range === 'custom') {
			      if (!financialsStartDateInput || !financialsEndDateInput) {
			         showModal("Date inputs not found. Please refresh the page.");
			         return;
			      }
			      if (!financialsStartDateInput.value || !financialsEndDateInput.value) {
			         showModal("Please select both start and end dates.");
			         return;
			      }
			      startDate = new Date(financialsStartDateInput.value);
			      startDate.setHours(0, 0, 0, 0);
			      endDate = new Date(financialsEndDateInput.value);
			      endDate.setHours(23, 59, 59, 999);
			      
			      if (startDate > endDate) {
			         showModal("Start date cannot be after end date.");
			         return;
			      }
			   } else {
			      console.error("Invalid range:", range);
			      return;
			   }
			   
			   try {
			      console.log("Loading financials for range:", range, "from", startDate, "to", endDate);
			      
			      const q = query(collection(db, `artifacts/${appId}/public/data/queue`),
			                     where("status", "==", "seen"),
			                     where("completedAt", ">=", Timestamp.fromDate(startDate)),
			                     where("completedAt", "<=", Timestamp.fromDate(endDate)),
			                     orderBy("completedAt", "desc")
			                    );
			      const querySnapshot = await getDocs(q);
			      
			      console.log("Query returned", querySnapshot.size, "documents");
			      
			      let totalRevenue = 0;
			      let transactions = [];
			      
			      querySnapshot.forEach(docSnap => {
			         const data = docSnap.data();
			         const fee = parseFloat(data.fee || 0);
			         if (fee > 0) {
			            totalRevenue += fee;
			            transactions.push({
			               id: docSnap.id,
			               name: data.name || 'Unknown',
			               mobile: data.mobile || 'N/A',
			               fee: fee,
			               completedAt: data.completedAt?.toDate() || new Date(),
			               notes: data.notes || ''
			            });
			         }
			      });
			
			      // --- THIS IS THE FIX ---
			      currentFinancialsData = transactions; 
			      // ----------------------
			      
			      const transactionCount = transactions.length;
			      const avgRevenue = transactionCount > 0 ? totalRevenue / transactionCount : 0;
			      
			      console.log("Processed transactions:", transactionCount, "Total revenue:", totalRevenue);
			      
			      // Update UI
			      if (financialsTotalRevenueEl) financialsTotalRevenueEl.textContent = `₹${totalRevenue.toFixed(2)}`;
			      if (financialsAvgRevenueEl) financialsAvgRevenueEl.textContent = `₹${avgRevenue.toFixed(2)}`;
			      if (financialsTransactionCountEl) financialsTransactionCountEl.textContent = transactionCount;
			      
			      // Update transaction list
			      if (financialsTransactionsList) {
			         financialsTransactionsList.innerHTML = '';
			         if (transactions.length === 0) {
			            financialsTransactionsList.innerHTML = '<li class="text-center text-gray-500 py-12"><svg class="mx-auto h-12 w-12 text-gray-400 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg><p class="text-gray-500">No transactions found for this period.</p></li>';
			         } else {
			            transactions.forEach((txn, index) => {
			               const li = document.createElement('li');
			               li.className = 'bg-gradient-to-r from-white to-gray-50 hover:from-blue-50 hover:to-indigo-50 shadow-md hover:shadow-xl rounded-xl p-4 sm:p-5 border border-gray-200 hover:border-blue-300 transition-all duration-200 transform hover:-translate-y-1';
			               const dateStr = txn.completedAt.toLocaleDateString('en-US', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' });
			               const timeStr = txn.completedAt.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
			               li.innerHTML = `
			                  <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3">
			                     <div class="flex-1">
			                        <div class="flex items-center gap-2 mb-1">
			                           <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center text-white font-bold text-sm">
			                              ${txn.name.charAt(0).toUpperCase()}
			                           </div>
			                           <div>
			                              <p class="font-bold text-gray-800 text-base sm:text-lg">${txn.name}</p>
			                              <p class="text-xs sm:text-sm text-gray-500">${txn.mobile}</p>
			                           </div>
			                        </div>
			                        <p class="text-xs sm:text-sm text-gray-500 mt-1.5 ml-12 sm:ml-0"><span class="inline-flex items-center gap-1"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>${dateStr}</span> <span class="ml-2">${timeStr}</span></p>
			                     </div>
			                     <div class="ml-12 sm:ml-0">
			                        <p class="font-extrabold text-emerald-600 text-2xl sm:text-3xl">₹${txn.fee.toFixed(2)}</p>
			                        <p class="text-xs text-gray-400 text-right mt-0.5">Payment</p>
			                     </div>
			                  </div>
			               `;
			               financialsTransactionsList.appendChild(li);
			            });
			         }
			      }
			   } catch (error) {
			      console.error("Error loading financials:", error);
			      if (financialsTransactionsList) {
			         financialsTransactionsList.innerHTML = '<li class="text-center text-red-500 py-8"><p class="font-semibold">Error loading financial data</p><p class="text-sm text-gray-500 mt-2">' + error.message + '</p></li>';
			      }
			      if (error.code === 'failed-precondition') {
			         showModal("Database index missing for financials query. Please create the required index in Firebase. Check the browser console (F12) for the index creation link.");
			      } else if (error.code === 'permission-denied') {
			         showModal("Permission denied. Please check your Firebase rules and ensure you're logged in as admin.");
			      } else {
			         showModal("Error loading financials: " + error.message);
			      }
			   }
			}
            
            async function exportFinancialsCSV() {
                // --- THIS IS THE NEW, FIXED FUNCTION ---
                if (currentFinancialsData.length === 0) {
                    showModal("No transactions to export.");
                    return;
                }
                
                let csvContent = "Date,Time,Patient Name,Mobile,Fee (INR),Notes\r\n";
                
                currentFinancialsData.forEach(txn => {
                    const dateStr = txn.completedAt.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
                    const timeStr = txn.completedAt.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    
                    const name = (txn.name || '').replace(/"/g, '""');
                    const mobile = (txn.mobile || '').replace(/"/g, '""');
                    const fee = txn.fee.toFixed(2);
                    const notes = (txn.notes || '').replace(/"/g, '""').replace(/\r?\n|\r/g, ' '); // Sanitize

                    csvContent += `"${dateStr}","${timeStr}","${name}","${mobile}","${fee}","${notes}"\r\n`;
                });
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `financials_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            // --- 8. Doctor: Dashboard Logic ---

            function updateTime() {
                const now = new Date();
                if (liveDate) liveDate.textContent = now.toLocaleDateString(undefined, {
                    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
                });
                if (liveTime) liveTime.textContent = now.toLocaleTimeString();
            }

            async function handleSaveLimit() {
                if (!dailyLimitInput) return;
                const limit = parseInt(dailyLimitInput.value);
                if (isNaN(limit) || limit < 0) {
                    showModal("Please enter a valid positive number for the limit.");
                    return;
                }

                const statusRef = doc(db, `artifacts/${appId}/public/data/clinicStatus/status`);
                try {
                    await Tone.start();
                    await setDoc(statusRef, { dailyLimit: limit });
                    if (limitSaveStatus) {
                        limitSaveStatus.textContent = "Limit saved successfully!";
                        limitSaveStatus.className = "text-sm text-green-600 mt-2";
                        limitSaveStatus.style.display = 'block';
                    }
                    setTimeout(() => { if (limitSaveStatus) limitSaveStatus.style.display = 'none'; }, 3000);
                } catch (error) {
                    console.error("Error saving limit:", error);
                    if (limitSaveStatus) {
                        limitSaveStatus.textContent = "Error saving limit.";
                        limitSaveStatus.className = "text-sm text-red-600 mt-2";
                        limitSaveStatus.style.display = 'block';
                    }
                }
            }

            // --- THIS IS THE NEW, MODERN DASHBOARD FUNCTION ---
            function attachDashboardListeners() {
                if (!isAuthReady || !db) return;
                if (welcomeMsg) welcomeMsg.textContent = `Welcome, ${currentUserDisplayName || 'Doctor'}!`;

                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const tomorrow = new Date(today);
                tomorrow.setDate(tomorrow.getDate() + 1);

                // --- Query 1: Patients WAITING (for KPI card and "Up Next") ---
                const waitingQuery = query(collection(db, `artifacts/${appId}/public/data/queue`),
                                    where("status", "==", "waiting"),
                                    orderBy("joinedAt", "asc"));
                
                const unsubWaiting = onSnapshot(waitingQuery, (querySnapshot) => {
                    if (waitingCountEl) waitingCountEl.textContent = querySnapshot.size;
                    
                    if (querySnapshot.empty) {
                        if (upNextPatientCard) {
                            upNextPatientCard.innerHTML = `
                                <div class="text-center text-gray-500 py-8">
                                    <svg class="w-12 h-12 mx-auto text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7v8a2 2 0 002 2h4M8 7V3a2 2 0 012-2h4a2 2 0 012 2v4a2 2 0 01-2 2h-4A2 2 0 018 7z"></path></svg>
                                    <p class="mt-2 text-sm font-medium">The queue is empty.</p>
                                </div>
                            `;
                        }
                    } else {
                        const nextPatient = querySnapshot.docs[0].data();
                        if (upNextPatientCard) {
                            upNextPatientCard.innerHTML = `
                                <div class="animate-fade-in">
                                    <p class="text-xs font-semibold text-blue-600 uppercase">Next Patient</p>
                                    <p class="text-2xl font-bold text-gray-900 truncate">${nextPatient.name}</p>
                                    <p class="text-sm text-gray-600 mt-1">
                                        <span class="font-medium">Issue:</span> ${nextPatient.issue}
                                    </p>
                                    <p class="text-sm text-gray-500 mt-1">
                                        <span class="font-medium">Mobile:</span> ${nextPatient.mobile}
                                    </p>
                                </div>
                            `;
                        }
                    }
                }, (error) => console.error("Error getting waiting patients:", error));

                // --- Query 2: Patients SEEN (for KPI card and Revenue) ---
                const seenQuery = query(collection(db, `artifacts/${appId}/public/data/queue`),
                                  where("status", "==", "seen"),
                                  where("completedAt", ">=", Timestamp.fromDate(today)),
                                  where("completedAt", "<", Timestamp.fromDate(tomorrow))
                                 );

                const unsubSeen = onSnapshot(seenQuery, (querySnapshot) => {
                    if (seenCountEl) seenCountEl.textContent = querySnapshot.size;
                    
                    let totalRevenue = 0;
                    querySnapshot.forEach(doc => {
                        totalRevenue += parseFloat(doc.data().fee || 0);
                    });
                    if (revenueEl) revenueEl.textContent = `₹${totalRevenue.toFixed(0)}`;

                }, (error) => {
                    console.error("Error getting seen patients:", error);
                    if (error.code === 'failed-precondition') {
                        showModal("Database index missing for Dashboard. Please create the required index in Firebase (check console for link).");
                    }
                });

                // --- Query 3: Load upcoming appointments ---
                const unsubAppts = loadDashboardAppointments(today, tomorrow);

                // --- Query 4: Get Clinic Daily Limit (existing logic) ---
                const statusRef = doc(db, `artifacts/${appId}/public/data/clinicStatus/status`);
                getDoc(statusRef).then((docSnap) => {
                    if (docSnap.exists() && docSnap.data().dailyLimit !== undefined) {
                         if (dailyLimitInput) dailyLimitInput.value = docSnap.data().dailyLimit;
                    } else {
                         if (dailyLimitInput) dailyLimitInput.value = 50;
                    }
                }).catch(error => {
                     console.error("Error getting initial clinic status:", error);
                      if (dailyLimitInput) dailyLimitInput.value = 50;
                });

                // Store all unsubscribe functions to be called later
                dashboardUnsubscribe = () => {
                    unsubWaiting();
                    unsubSeen();
                    unsubAppts();
                };
            }
            // --- END OF NEW DASHBOARD FUNCTION ---

             // --- 9. Doctor: Call Patient Logic ---
            function attachDoctorQueueListener() {
                if (!isAuthReady || !db || !isAdmin) return;
                const queueCollectionPath = `artifacts/${appId}/public/data/queue`;
                const q = query(collection(db, queueCollectionPath),
                                where("status", "==", "waiting"),
                                orderBy("joinedAt", "asc"));

                if (doctorQueueUnsubscribe) doctorQueueUnsubscribe(); 
                doctorQueueUnsubscribe = onSnapshot(q, (querySnapshot) => {
                    if (!isAuthReady || !isAdmin) return; 
                    if (!doctorQueueList) return;
                    doctorQueueList.innerHTML = ''; 

                    if (querySnapshot.empty) {
                        if (doctorMessageEl) doctorMessageEl.style.display = 'block';
                    } else {
                        if (doctorMessageEl) doctorMessageEl.style.display = 'none';
                        let index = 0; 
                        querySnapshot.forEach((doc) => { 
                            const data = doc.data();
                            const queueNumber = index + 1; 
                            const li = document.createElement('li');
                            li.className = `p-4 rounded-lg shadow ${index === 0 ? 'bg-[hsl(149_52%_90%)] border-[hsl(149_52%_60%)] border-2' : 'bg-white'}`;
                            li.innerHTML = `
                                <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center">
                                    <span class="text-2xl font-bold text-[hsl(149_52%_30%)]">#${queueNumber}</span>
                                    <span class="text-lg font-semibold mt-1 sm:mt-0">${data.name || 'N/A'}</span>
                                    <span class="text-gray-600 mt-1 sm:mt-0">${data.mobile || 'N/A'}</span>
                                </div>
                                <p class="text-gray-700 mt-2"><b>Issue:</b> ${data.issue || 'N/A'}</p>
                                ${index === 0 ?
                                    '<button class="call-next-btn mt-3 w-full bg-[hsl(149_52%_46%)] text-white px-4 py-2 rounded-lg font-semibold hover:bg-[hsl(149_52%_40%)] focus:outline-none focus:ring-2 focus:ring-[hsl(149_52%_46%)] focus:ring-offset-2">Add Notes & Call Next</button>'
                                    : ''}
                            `;

                            if (index === 0) {
                                const callNextBtn = li.querySelector('.call-next-btn');
                                if (callNextBtn) {
                                    callNextBtn.addEventListener('click', () => {
                                        Tone.start(); 
                                        currentPatientForNotes = {
                                            id: doc.id,
                                            patientId: data.patientId,
                                            name: data.name,
                                            mobile: data.mobile,
                                            issue: data.issue
                                        };
                                        showNotesModal();
                                    });
                                }
                            }
                            doctorQueueList.appendChild(li);
                            index++; 
                        });
                    }
                }, (error) => {
                    console.error("[Doctor] Error with doctor queue snapshot:", error);
                    if (error.code === 'failed-precondition') {
                        showModal("Database index missing. Please check the Developer Console (F12) for a link to create the required index in Firebase, then refresh.");
                    } else if (error.code === 'permission-denied') {
                        showModal("Permission denied. Ensure Firestore rules allow reading the queue. Please check rules and refresh.");
                    } else {
                        showModal("Error connecting to the patient queue. Please refresh the page.");
                    }
                    if (doctorMessageEl) doctorMessageEl.style.display = 'block';
                    if (doctorQueueList) doctorQueueList.innerHTML = '';
                });
            }

            // --- 10. Doctor: Notes Modal Logic ---
            function showNotesModal() {
                if (notesText) notesText.value = '';
                if (notesFeeInput) notesFeeInput.value = ''; 
                if (notesModal) notesModal.style.display = 'flex';
                if (notesText) notesText.focus();
            }

            function closeNotesModal() {
                if (notesModal) notesModal.style.display = 'none';
                currentPatientForNotes = null;
                if (notesFeeInput) notesFeeInput.value = '';
            }

            async function handleNotesSubmit(e) {
                e.preventDefault();
                if (!currentPatientForNotes || !notesText || !notesFeeInput) return; 

                const notes = notesText.value.trim();
                const fee = notesFeeInput.value; 

                if (!notes || !fee) {
                    showModal("Please add notes and enter the consultation fee.");
                    return;
                }
                
                const feeAmount = parseFloat(fee);
                if (isNaN(feeAmount) || feeAmount < 0) {
                     showModal("Please enter a valid, non-negative fee.");
                     return;
                }

                if (notesSubmitBtn) {
                    notesSubmitBtn.disabled = true;
                    notesSubmitBtn.textContent = 'Saving...';
                }

                try {
                    const visitCollectionPath = `artifacts/${appId}/users/${currentPatientForNotes.patientId}/visits`;
                    await addDoc(collection(db, visitCollectionPath), {
                        name: currentPatientForNotes.name,
                        mobile: currentPatientForNotes.mobile,
                        issue: currentPatientForNotes.issue,
                        notes: notes,
                        fee: feeAmount, 
                        visitedAt: serverTimestamp()
                    });

                    const queueDocRef = doc(db, `artifacts/${appId}/public/data/queue`, currentPatientForNotes.id);
                    await updateDoc(queueDocRef, {
                        status: 'seen',
                        fee: feeAmount, 
                        completedAt: serverTimestamp(), 
                        notes: notes 
                    });

                    closeNotesModal();

                } catch (error) {
                    console.error("Error saving notes or updating queue:", error);
                    showModal("Could not save notes. Please try again.");
                } finally {
                    if (notesSubmitBtn) {
                        notesSubmitBtn.disabled = false;
                        notesSubmitBtn.textContent = 'Save Notes & Dismiss';
                    }
                }
            }

            // --- 11. Doctor: Export Logic ---
            async function exportToCSV() {
                if(!exportDateInput){
                     showModal("Date input not found.");
                     return;
                }
                if (exportBtn) {
                    exportBtn.disabled = true;
                    exportBtn.textContent = 'Generating...';
                }

                try {
                    const selectedDate = new Date(exportDateInput.value);
                     if (isNaN(selectedDate.getTime())) {
                         showModal("Please select a valid date for export.");
                          if (exportBtn) {
                             exportBtn.disabled = false;
                             exportBtn.textContent = 'Export Patients to CSV';
                         }
                         return;
                     }

                    const startOfDay = new Date(selectedDate);
                    startOfDay.setHours(0, 0, 0, 0);
                    const endOfDay = new Date(selectedDate);
                    endOfDay.setHours(23, 59, 59, 999);

                    const q = query(collection(db, `artifacts/${appId}/public/data/queue`),
                                    where("joinedAt", ">=", Timestamp.fromDate(startOfDay)),
                                    where("joinedAt", "<=", Timestamp.fromDate(endOfDay))
                                   );
                    const querySnapshot = await getDocs(q);

                    if (querySnapshot.empty) {
                        showModal("No patient data found for the selected date.");
                        if (exportBtn) {
                            exportBtn.disabled = false;
                            exportBtn.textContent = 'Export Patients to CSV';
                        }
                        return;
                    }

                    let csvContent = "data:text/csv;charset=utf-8,";
                    csvContent += "Patient Name,Mobile,Issue,Status,Fee (INR),Joined At\r\n";
                    querySnapshot.forEach(doc => {
                        const data = doc.data();
                        const joinedAt = data.joinedAt?.toDate().toLocaleString() || "N/A";
                        const name = data.name ? data.name.replace(/"/g, '""') : "";
                        const mobile = data.mobile ? data.mobile.replace(/"/g, '""') : "";
                        const issue = data.issue ? data.issue.replace(/"/g, '""') : "";
                        const status = data.status ? data.status.replace(/"/g, '""') : "";
                        const fee = data.fee ? parseFloat(data.fee).toFixed(2) : "0.00"; 
                        csvContent += `"${name}","${mobile}","${issue}","${status}","${fee}","${joinedAt}"\r\n`;
                    });

                    const encodedUri = encodeURI(csvContent);
                    const link = document.createElement("a");
                    link.setAttribute("href", encodedUri);
                    link.setAttribute("download", `medique_export_${exportDateInput.value}.csv`);
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                } catch (error) {
                    console.error("Error exporting CSV:", error);
                    showModal("Error generating CSV: " + error.message);
                } finally {
                    if (exportBtn) {
                        exportBtn.disabled = false;
                        exportBtn.textContent = 'Export Patients to CSV';
                    }
                }
            }

            // --- 12. Doctor: Appointments Logic ---
            async function loadDoctorAppointments() {
                if (!isAuthReady || !db || !docAptDateInput) return;
                 if(!docAptDateInput.value){
                     if (docAptMsg) docAptMsg.textContent = 'Please select a date.';
                     if (docAptMsg) docAptMsg.style.display = 'block';
                     if (docAptList) docAptList.innerHTML = '';
                     return;
                 }

                const selectedDate = new Date(docAptDateInput.value);
                const startOfDay = new Date(selectedDate);
                startOfDay.setHours(0, 0, 0, 0);
                const endOfDay = new Date(selectedDate);
                endOfDay.setHours(23, 59, 59, 999);

                if (docAptList) docAptList.innerHTML = '';
                if (docAptMsg) docAptMsg.textContent = 'Loading...';
                if (docAptMsg) docAptMsg.style.display = 'block';

                try {
                    const q = query(collection(db, "appointments"),
                                    where("appointmentAt", ">=", Timestamp.fromDate(startOfDay)),
                                    where("appointmentAt", "<=", Timestamp.fromDate(endOfDay)), 
                                    orderBy("appointmentAt", "asc")
                                   );

                    const querySnapshot = await getDocs(q);

                    if (querySnapshot.empty) {
                        if (docAptMsg) docAptMsg.textContent = 'No appointments found for this date.';
                    } else {
                        if (docAptMsg) docAptMsg.style.display = 'none';
                        querySnapshot.forEach(doc => {
                            const apt = doc.data();
                            const aptTime = apt.appointmentAt?.toDate().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) || 'Unknown Time';
                            const li = document.createElement('li');
                            li.className = 'bg-white shadow-md rounded-lg p-4 mb-4';
                            li.innerHTML = `
                                <div class="flex justify-between items-center">
                                    <span class="text-xl font-bold text-[hsl(149_52%_46%)]">${aptTime}</span>
                                    <span class="text-lg font-semibold">${apt.patientName || 'Unknown Patient'}</span>
                                </div>
                                <p class="text-gray-600 mt-2"><span class="font-medium">Reason:</span> ${apt.reason || 'N/A'}</p>
                            `;
                            if (docAptList) docAptList.appendChild(li);
                        });
                    }
                } catch (error) {
                    console.error("Error loading doctor appointments:", error);
                      if (error.code === 'failed-precondition' && error.message.includes('index')) {
                          showModal("Database index missing for appointments. Check the Developer Console (F12) for a link to create the required index in Firebase, then refresh.");
                      } else {
                          if (docAptMsg) docAptMsg.textContent = 'Error loading appointments. Check rules/index.';
                      }
                    if (docAptMsg) docAptMsg.style.display = 'block'; 
                }
            }

            // --- NEW HELPER FUNCTION FOR DASHBOARD ---
            function loadDashboardAppointments(startOfDay, endOfDay) {
                if (!isAuthReady || !db) return () => {};
                
                const q = query(collection(db, "appointments"),
                                where("appointmentAt", ">=", Timestamp.fromDate(startOfDay)),
                                where("appointmentAt", "<=", Timestamp.fromDate(endOfDay)),
                                orderBy("appointmentAt", "asc")
                               );

                const unsubscribe = onSnapshot(q, (querySnapshot) => {
                    if (aptList) aptList.innerHTML = '';
                    if (querySnapshot.empty) {
                        if (aptMsg) aptMsg.style.display = 'block';
                    } else {
                        if (aptMsg) aptMsg.style.display = 'none';
                        querySnapshot.forEach(doc => {
                            const apt = doc.data();
                            const aptTime = apt.appointmentAt?.toDate().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) || 'Unknown Time';
                            const li = document.createElement('li');
                            li.className = 'flex items-center gap-3 p-3 bg-gray-50/80 rounded-xl border border-gray-200 animate-fade-in';
                            li.innerHTML = `
                                <div class="flex-shrink-0 w-11 h-11 rounded-lg bg-gradient-to-br from-blue-100 to-indigo-200 flex items-center justify-center">
                                    <span class="font-bold text-lg text-blue-700">${aptTime.split(' ')[0].split(':')[0]}</span>
                                </div>
                                <div>
                                    <p class="font-semibold text-gray-800">${apt.patientName || 'Unknown Patient'}</p>
                                    <p class="text-sm text-gray-600">${apt.reason || 'N/A'}</p>
                                </div>
                                <span class="ml-auto text-sm font-medium text-gray-700 bg-white px-2 py-1 rounded-md shadow-sm border border-gray-200">${aptTime}</span>
                            `;
                            if (aptList) aptList.appendChild(li);
                        });
                    }
                }, (error) => {
                    console.error("Error loading dashboard appointments:", error);
                    if (aptMsg) {
                        aptMsg.textContent = 'Error loading appointments.';
                        aptMsg.style.display = 'block';
                    }
                    if (error.code === 'failed-precondition') {
                        showModal("Database index missing for Appointments. Please create the required index in Firebase (check console for link).");
                    }
                });
                
                return unsubscribe; // Return the unsubscribe function
            }
            // --- END OF NEW FUNCTION ---

            // --- 13. Global Utilities ---
            function showModal(message) {
                if (modalMessage) modalMessage.textContent = message;
                if (modal) modal.style.display = 'flex';
            }

            function closeModal() {
                if (modal) modal.style.display = 'none';
            }

            // --- Get All DOM Elements ---
            doctorApp = document.getElementById('doctor-app');

            doctorPages['dashboard'] = document.getElementById('doctor-page-dashboard');
            doctorPages['call'] = document.getElementById('doctor-page-call');
            doctorPages['export'] = document.getElementById('doctor-page-export');
            doctorPages['appointments'] = document.getElementById('doctor-page-appointments');
            doctorPages['financials'] = document.getElementById('doctor-page-financials');
            doctorPages['settings'] = document.getElementById('doctor-page-settings');

            // Navbar
            mainNav = document.getElementById('main-nav');
            patientNav = document.getElementById('patient-nav'); // To hide it
            doctorNav = document.getElementById('doctor-nav'); // To show it
            authControls = document.getElementById('auth-controls');
            userDisplay = document.getElementById('user-display');
            logoutBtn = document.getElementById('logout-btn');
            
            doctorNavDashboard = document.getElementById('doctor-nav-dashboard');
            doctorNavCall = document.getElementById('doctor-nav-call');
            doctorNavExport = document.getElementById('doctor-nav-export');
            doctorNavAppointments = document.getElementById('doctor-nav-appointments');
            doctorNavFinancials = document.getElementById('doctor-nav-financials');
            doctorNavSettings = document.getElementById('doctor-nav-settings');

            // Mobile Nav
            mobileMenu = document.getElementById('mobile-menu');
            mobileMenuBtn = document.getElementById('mobile-menu-btn');
            mobileAuthControls = document.getElementById('mobile-auth-controls');
            mobileUserDisplay = document.getElementById('mobile-user-display');
            mobileLogoutBtn = document.getElementById('mobile-logout-btn');
            mobilePatientNav = document.getElementById('mobile-patient-nav'); // To hide it
            mobileDoctorNav = document.getElementById('mobile-doctor-nav'); // To show it

            // Doctor: Dashboard
            welcomeMsg = document.getElementById('welcome-msg');
            liveDate = document.getElementById('live-date');
            liveTime = document.getElementById('live-time');
            dailyLimitInput = document.getElementById('daily-limit-input');
            saveLimitBtn = document.getElementById('save-limit-btn');
            limitSaveStatus = document.getElementById('limit-save-status');

            // --- NEW MODERN DASHBOARD ELEMENT GETTERS ---
            waitingCountEl = document.getElementById('dashboard-waiting-count');
            seenCountEl = document.getElementById('dashboard-seen-count');
            revenueEl = document.getElementById('dashboard-total-revenue');
            upNextPatientCard = document.getElementById('dashboard-up-next-patient');
            callPatientBtn = document.getElementById('dashboard-call-patient-btn');
            aptList = document.getElementById('dashboard-appointments-list');
            aptMsg = document.getElementById('dashboard-appointments-msg');
            // -------------------------------------------
            
            // Doctor: Settings
            settingsLatInput = document.getElementById('settings-lat-input');
            settingsLonInput = document.getElementById('settings-lon-input');
            settingsMaxDistanceInput = document.getElementById('settings-max-distance-input');
            settingsSaveBtn = document.getElementById('settings-save-btn');
            settingsStatusMsg = document.getElementById('settings-status-msg');
            
            // Doctor: Financials
            financialsTodayBtn = document.getElementById('financials-today-btn');
            financialsWeekBtn = document.getElementById('financials-week-btn');
            financialsMonthBtn = document.getElementById('financials-month-btn');
            financialsCustomBtn = document.getElementById('financials-custom-btn');
            financialsStartDateInput = document.getElementById('financials-start-date');
            financialsEndDateInput = document.getElementById('financials-end-date');
            financialsTotalRevenueEl = document.getElementById('financials-total-revenue');
            financialsAvgRevenueEl = document.getElementById('financials-avg-revenue');
            financialsTransactionCountEl = document.getElementById('financials-transaction-count');
            financialsTransactionsList = document.getElementById('financials-transactions-list');
            financialsExportBtn = document.getElementById('financials-export-btn');

            // Doctor: Call
            doctorQueueList = document.getElementById('doctor-queue-list');
            doctorMessageEl = document.getElementById('doctor-message');

            // Doctor: Notes Modal
            notesModal = document.getElementById('notes-modal');
            notesForm = document.getElementById('notes-form');
            notesText = document.getElementById('notes-text');
            notesFeeInput = document.getElementById('consultation-fee');
            notesSubmitBtn = document.getElementById('notes-submit-btn');
            notesCancelBtn = document.getElementById('notes-cancel-btn');

            // Doctor: Export
            exportBtn = document.getElementById('export-btn');
            exportDateInput = document.getElementById('export-date');

            // Doctor: Appointments
            docAptDateInput = document.getElementById('doc-apt-date');
            docAptList = document.getElementById('doc-apt-list');
            docAptMsg = document.getElementById('doc-apt-msg');

            // Global
            loadingOverlay = document.getElementById('loading-overlay');
            modal = document.getElementById('modal');
            modalMessage = document.getElementById('modal-message');
            modalCloseBtn = document.getElementById('modal-close-btn');

            // --- Add Event Listeners ---
            if (logoutBtn) logoutBtn.addEventListener('click', handleLogout);
            if (mobileLogoutBtn) mobileLogoutBtn.addEventListener('click', handleLogout);

            if (saveLimitBtn) saveLimitBtn.addEventListener('click', handleSaveLimit);

            // --- NEW DASHBOARD BUTTON LISTENER ---
            if (callPatientBtn) callPatientBtn.addEventListener('click', () => showDoctorView('call'));
            // -------------------------------------

            if (notesForm) notesForm.addEventListener('submit', handleNotesSubmit);
            if (notesCancelBtn) notesCancelBtn.addEventListener('click', closeNotesModal);

            if (exportBtn) exportBtn.addEventListener('click', exportToCSV);

            if (docAptDateInput) docAptDateInput.addEventListener('change', loadDoctorAppointments);
            
            if (settingsSaveBtn) settingsSaveBtn.addEventListener('click', saveClinicSettings);
            
            // Financials button style update function
            function updateFinancialsButtonStyle(activeBtn) {
                const buttons = [
                    { btn: financialsTodayBtn, id: 'today' },
                    { btn: financialsWeekBtn, id: 'week' },
                    { btn: financialsMonthBtn, id: 'month' },
                    { btn: financialsCustomBtn, id: 'custom' }
                ];
                buttons.forEach(({ btn, id }) => {
                    if (!btn) return;
                    if (id === activeBtn) {
                        btn.className = 'px-4 py-2.5 text-sm font-medium text-white bg-gradient-to-r from-blue-600 to-blue-700 border border-transparent rounded-xl hover:from-blue-700 hover:to-blue-800 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-all duration-200 shadow-md hover:shadow-lg transform hover:-translate-y-0.5';
                    } else {
                        btn.className = 'px-4 py-2.5 text-sm font-medium text-gray-700 bg-gray-100 border border-gray-200 rounded-xl hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 transition-all duration-200';
                    }
                });
            }
            
            function setupFinancialsButtons() {
                // This setup uses event listeners directly
                if (financialsTodayBtn) {
                    financialsTodayBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        const customRange = document.getElementById('financials-custom-range');
                        if (customRange) customRange.style.display = 'none';
                        updateFinancialsButtonStyle('today');
                        loadFinancials('today');
                    });
                }
                if (financialsWeekBtn) {
                    financialsWeekBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        const customRange = document.getElementById('financials-custom-range');
                        if (customRange) customRange.style.display = 'none';
                        updateFinancialsButtonStyle('week');
                        loadFinancials('week');
                    });
                }
                if (financialsMonthBtn) {
                    financialsMonthBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        const customRange = document.getElementById('financials-custom-range');
                        if (customRange) customRange.style.display = 'none';
                        updateFinancialsButtonStyle('month');
                        loadFinancials('month');
                    });
                }
                if (financialsCustomBtn) {
                    financialsCustomBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        const customRange = document.getElementById('financials-custom-range');
                        const isVisible = customRange && customRange.style.display !== 'none' && customRange.style.display !== '';
                        if (customRange) customRange.style.display = isVisible ? 'none' : 'flex';
                        if (!isVisible) {
                            updateFinancialsButtonStyle('custom');
                            if (financialsStartDateInput && financialsEndDateInput && financialsStartDateInput.value && financialsEndDateInput.value) {
                                loadFinancials('custom');
                            }
                        }
                    });
                }
                if (financialsStartDateInput) {
                    financialsStartDateInput.addEventListener('change', () => {
                        if (financialsStartDateInput.value && financialsEndDateInput && financialsEndDateInput.value) {
                            updateFinancialsButtonStyle('custom');
                            loadFinancials('custom');
                        }
                    });
                }
                if (financialsEndDateInput) {
                    financialsEndDateInput.addEventListener('change', () => {
                        if (financialsStartDateInput && financialsStartDateInput.value && financialsEndDateInput.value) {
                            updateFinancialsButtonStyle('custom');
                            loadFinancials('custom');
                        }
                    });
                }
                if (financialsExportBtn) financialsExportBtn.addEventListener('click', exportFinancialsCSV);
            }
            
            setupFinancialsButtons(); // Call the setup

            if (modalCloseBtn) modalCloseBtn.addEventListener('click', closeModal);
            if (mobileMenuBtn) mobileMenuBtn.addEventListener('click', () => {
                if (mobileMenu) mobileMenu.classList.toggle('hidden');
            });

            // Page Navigation Listeners
            if (doctorNavDashboard) doctorNavDashboard.addEventListener('click', () => showDoctorView('dashboard'));
            if (doctorNavCall) doctorNavCall.addEventListener('click', () => showDoctorView('call'));
            if (doctorNavExport) doctorNavExport.addEventListener('click', () => showDoctorView('export'));
            if (doctorNavAppointments) doctorNavAppointments.addEventListener('click', () => showDoctorView('appointments'));
            if (doctorNavFinancials) doctorNavFinancials.addEventListener('click', () => { 
                showDoctorView('financials'); 
                updateFinancialsButtonStyle('today');
                loadFinancials('today'); 
            });
            if (doctorNavSettings) doctorNavSettings.addEventListener('click', () => { showDoctorView('settings'); loadSettingsIntoForm(); }); // Added loadSettings
            document.getElementById('mobile-doctor-nav-dashboard')?.addEventListener('click', () => { showDoctorView('dashboard'); if (mobileMenu) mobileMenu.classList.add('hidden'); });
            document.getElementById('mobile-doctor-nav-call')?.addEventListener('click', () => { showDoctorView('call'); if (mobileMenu) mobileMenu.classList.add('hidden'); });
            document.getElementById('mobile-doctor-nav-export')?.addEventListener('click', () => { showDoctorView('export'); if (mobileMenu) mobileMenu.classList.add('hidden'); });
            document.getElementById('mobile-doctor-nav-appointments')?.addEventListener('click', () => { showDoctorView('appointments'); if (mobileMenu) mobileMenu.classList.add('hidden'); });
            document.getElementById('mobile-doctor-nav-financials')?.addEventListener('click', () => { 
                showDoctorView('financials'); 
                updateFinancialsButtonStyle('today');
                loadFinancials('today'); 
                if (mobileMenu) mobileMenu.classList.add('hidden'); 
            });
            document.getElementById('mobile-doctor-nav-settings')?.addEventListener('click', () => { showDoctorView('settings'); loadSettingsIntoForm(); if (mobileMenu) mobileMenu.classList.add('hidden'); }); // Added loadSettings

            // --- Auth State Change Listener (Auth Guard) ---
            onAuthStateChanged(auth, async (user) => {
                isAuthReady = true;
                if (user) {
                    // User is logged in. Check if they are admin.
                    if (user.email === ADMIN_EMAIL) {
                        // --- This is the admin, run doctor logic ---
                        isAdmin = true;
                        currentUserId = user.uid;
                        currentUserEmail = user.email;
                        currentUserDisplayName = user.displayName;

                        if (userDisplay) userDisplay.textContent = user.displayName || user.email;
                        if (mobileUserDisplay) mobileUserDisplay.textContent = user.displayName || user.email;
                        if (authControls) authControls.style.display = 'flex';
                        if (mobileAuthControls) mobileAuthControls.style.display = 'flex';
                        if (mainNav) mainNav.style.display = 'flex';

                        // Show doctor nav, hide patient nav
                        if (patientNav) patientNav.style.display = 'none';
                        if (doctorNav) doctorNav.style.display = 'flex';
                        if (mobilePatientNav) mobilePatientNav.style.display = 'none';
                        if (mobileDoctorNav) mobileDoctorNav.style.display = 'block';

                        showDoctorView('dashboard'); // Show default doctor view
                        // --- End of doctor logic ---

                    } else {
                        // This is a patient, send them to the patient page
                        isAdmin = false;
                        window.location.href = 'patient.html';
                        return; // Stop execution
                    }
                } else {
                    // User is NOT logged in. Redirect to login page.
                    currentUserId = null;
                    currentUserEmail = null;
                    currentUserDisplayName = null;
                    isAdmin = false;
                    window.location.href = 'index.html'; // Redirect to login
                }
            });

        }; // <-- Correct closing brace and semicolon for window.onload
    </script>
</head>
<body class="bg-gray-100 font-sans">

    <nav class="bg-[hsl(149_52%_46%)] shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div id="main-nav" class="flex items-center justify-between h-16" style="display: none;">
                <div class="flex-shrink-0">
                    <img class="h-8 w-auto" src="/logo.jpg" alt="MediQueue Logo">
                </div>

                <div id="patient-nav" class="hidden md:flex" style="display: none;">
                </div>

                <div id="doctor-nav" class="hidden md:flex bg-gray-800 rounded-md" style="display: none;">
                    <div class="ml-10 flex items-baseline space-x-4">
                        <button id="doctor-nav-dashboard" class="text-gray-300 hover:bg-gray-700 hover:text-white px-3 py-2 rounded-md text-sm font-medium">Dashboard</button>
                        <button id="doctor-nav-call" class="text-gray-300 hover:bg-gray-700 hover:text-white px-3 py-2 rounded-md text-sm font-medium">Call Patient</button>
                        <button id="doctor-nav-financials" class="text-gray-300 hover:bg-gray-700 hover:text-white px-3 py-2 rounded-md text-sm font-medium">Financials</button>
                        <button id="doctor-nav-appointments" class="text-gray-300 hover:bg-gray-700 hover:text-white px-3 py-2 rounded-md text-sm font-medium">Appointments</button>
                        <button id="doctor-nav-export" class="text-gray-300 hover:bg-gray-700 hover:text-white px-3 py-2 rounded-md text-sm font-medium">Export</button>
                        <button id="doctor-nav-settings" class="text-gray-300 hover:bg-gray-700 hover:text-white px-3 py-2 rounded-md text-sm font-medium">Settings</button>
                    </div>
                </div>

                <div id="auth-controls" class="hidden md:flex items-center" style="display: none;">
                    <span id="user-display" class="text-white text-sm font-medium mr-4">user@example.com</span>
                    <button id="logout-btn" class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-md text-sm font-medium">Logout</button>
                </div>

                <div class="-mr-2 flex md:hidden">
                    <button id="mobile-menu-btn" type="button" class="bg-[hsl(149_52%_46%)] inline-flex items-center justify-center p-2 rounded-md text-gray-400 hover:text-white hover:bg-[hsl(149_52%_40%)] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-[hsl(149_52%_46%)] focus:ring-white" aria-controls="mobile-menu" aria-expanded="false">
                        <span class="sr-only">Open main menu</span>
                        <svg class="block h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                        </svg>
                        <svg class="hidden h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <div class="md:hidden hidden" id="mobile-menu">
            <div id="mobile-patient-nav" class="px-2 pt-2 pb-3 space-y-1 sm:px-3" style="display: none;">
            </div>
            <div id="mobile-doctor-nav" class="px-2 pt-2 pb-3 space-y-1 sm:px-3" style="display: none;">
                <button id="mobile-doctor-nav-dashboard" class="text-gray-300 hover:bg-gray-700 hover:text-white block px-3 py-2 rounded-md text-base font-medium">Dashboard</button>
                <button id="mobile-doctor-nav-call" class="text-gray-300 hover:bg-gray-700 hover:text-white block px-3 py-2 rounded-md text-base font-medium">Call Patient</button>
                <button id="mobile-doctor-nav-financials" class="text-gray-300 hover:bg-gray-700 hover:text-white block px-3 py-2 rounded-md text-base font-medium">Financials</button>
                <button id="mobile-doctor-nav-appointments" class="text-gray-300 hover:bg-gray-700 hover:text-white block px-3 py-2 rounded-md text-base font-medium">Appointments</button>
                <button id="mobile-doctor-nav-export" class="text-gray-300 hover:bg-gray-700 hover:text-white block px-3 py-2 rounded-md text-base font-medium">Export</button>
                <button id="mobile-doctor-nav-settings" class="text-gray-300 hover:bg-gray-700 hover:text-white block px-3 py-2 rounded-md text-base font-medium">Settings</button>
            </div>
            <div id="mobile-auth-controls" class="pt-4 pb-3 border-t border-[hsl(149_52%_40%)]" style="display: none;">
                <div class="flex items-center px-5">
                    <div class="ml-3">
                        <div id="mobile-user-display" class="text-base font-medium leading-none text-white">user@example.com</div>
                    </div>
                </div>
                <div class="mt-3 px-2 space-y-1">
                    <button id="mobile-logout-btn" class="block w-full text-left px-3 py-2 rounded-md text-base font-medium text-gray-300 hover:text-white hover:bg-[hsl(149_52%_40%)]">Logout</button>
                </div>
            </div>
        </div>
    </nav>

    <main>
        <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">

            <div id="doctor-app" style="display: none;">
                
                <div id="doctor-page-dashboard" style="display: none;" class="space-y-6">
                    
                    <div>
                        <h1 id="welcome-msg" class="text-3xl sm:text-4xl font-bold bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent mb-1">Welcome, Doctor!</h1>
                        <div class="flex flex-wrap items-center text-gray-500 gap-2 sm:gap-4">
                            <p id="live-date" class="text-sm sm:text-base">November 1, 2025</p>
                            <span class="hidden sm:block text-gray-300">|</span>
                            <p id="live-time" class="text-sm sm:text-base font-medium">11:28:27 AM</p>
                        </div>
                    </div>
                
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-5">
                        <div class="bg-white/80 backdrop-blur-sm p-5 rounded-2xl shadow-xl border border-gray-100 flex items-center gap-4 transition-all hover:shadow-2xl">
                            <div class="flex-shrink-0 w-14 h-14 rounded-xl bg-gradient-to-br from-orange-500 to-pink-500 flex items-center justify-center shadow-lg">
                                <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-500 uppercase">Waiting in Queue</p>
                                <p id="dashboard-waiting-count" class="text-3xl font-extrabold text-gray-900">0</p>
                            </div>
                        </div>
                        
                        <div class="bg-white/80 backdrop-blur-sm p-5 rounded-2xl shadow-xl border border-gray-100 flex items-center gap-4 transition-all hover:shadow-2xl">
                            <div class="flex-shrink-0 w-14 h-14 rounded-xl bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center shadow-lg">
                                <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-500 uppercase">Patients Seen Today</p>
                                <p id="dashboard-seen-count" class="text-3xl font-extrabold text-gray-900">0</p>
                            </div>
                        </div>
                
                        <div class="bg-white/80 backdrop-blur-sm p-5 rounded-2xl shadow-xl border border-gray-100 flex items-center gap-4 transition-all hover:shadow-2xl">
                            <div class="flex-shrink-0 w-14 h-14 rounded-xl bg-gradient-to-br from-emerald-500 to-teal-600 flex items-center justify-center shadow-lg">
                                <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-500 uppercase">Today's Revenue</p>
                                <p id="dashboard-total-revenue" class="text-3xl font-extrabold text-gray-900">₹0</p>
                            </div>
                        </div>
                    </div>
                
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        
                        <div class="lg:col-span-1 space-y-6">
                            <div class="bg-white/80 backdrop-blur-sm p-5 rounded-2xl shadow-xl border border-gray-100">
                                <h2 class="text-xl font-bold text-gray-800 mb-4">Up Next in Queue</h2>
                                <div id="dashboard-up-next-patient">
                                    <div class="text-center text-gray-500 py-8">
                                        <svg class="w-12 h-12 mx-auto text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7v8a2 2 0 002 2h4M8 7V3a2 2 0 012-2h4a2 2 0 012 2v4a2 2 0 01-2 2h-4A2 2 0 018 7z"></path></svg>
                                        <p class="mt-2 text-sm font-medium">The queue is empty.</p>
                                    </div>
                                </div>
                                <button id="dashboard-call-patient-btn" class="mt-4 w-full px-6 py-3 text-base font-semibold text-white bg-gradient-to-r from-blue-600 to-indigo-600 border border-transparent rounded-xl hover:from-blue-700 hover:to-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all duration-200 shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
                                    Go to Patient Queue
                                </button>
                            </div>
                
                            <div class="bg-white/80 backdrop-blur-sm p-5 rounded-2xl shadow-xl border border-gray-100">
                                <h2 class="text-xl font-bold text-gray-800 mb-4">Queue Settings</h2>
                                <div>
                                    <label for="daily-limit-input" class="block text-sm font-semibold text-gray-700 mb-2">Set Daily Patient Limit</label>
                                    <div class="flex flex-col sm:flex-row gap-3">
                                        <input type="number" id="daily-limit-input" min="0" step="1" class="flex-1 px-4 py-3 border-2 border-gray-200 rounded-xl shadow-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm sm:text-base transition-all duration-200" placeholder="Enter limit">
                                        <button id="save-limit-btn" class="px-5 py-3 text-sm font-semibold text-white bg-gradient-to-r from-blue-600 to-indigo-600 border border-transparent rounded-xl hover:from-blue-700 hover:to-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all duration-200 shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
                                            Save
                                        </button>
                                    </div>
                                    <p id="limit-save-status" class="text-sm text-green-600 mt-3" style="display: none;"></p>
                                </div>
                            </div>
                        </div>
                
                        <div class="lg:col-span-2 bg-white/80 backdrop-blur-sm p-5 rounded-2xl shadow-xl border border-gray-100">
                            <h2 class="text-xl font-bold text-gray-800 mb-4">Upcoming Appointments Today</h2>
                            <div id="dashboard-appointments-msg" class="text-center text-gray-500 py-12" style="display: none;">
                                <svg class="w-12 h-12 mx-auto text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                <p class="mt-2 text-sm font-medium">No more appointments scheduled for today.</p>
                            </div>
                            <ul id="dashboard-appointments-list" class="space-y-3 max-h-[450px] overflow-y-auto custom-scrollbar">
                                </ul>
                        </div>
                
                    </div>
                </div>
                <div id="doctor-page-call" style="display: none;">
                    <h1 class="text-3xl font-bold text-gray-900 mb-4">Patient Queue</h1>
                    <div id="doctor-message" class="text-center p-6 bg-white text-gray-700 rounded-lg shadow-lg" style="display: none;">
                        The queue is currently empty.
                    </div>
                    <ul id="doctor-queue-list" class="space-y-4">
                        </ul>
                </div>
                
                <div id="doctor-page-appointments" style="display: none;">
                    <h1 class="text-3xl font-bold text-gray-900 mb-4">View Appointments</h1>
                    <div class="bg-white p-6 rounded-lg shadow-lg max-w-2xl mx-auto">
                        <label for="doc-apt-date" class="block text-sm font-medium text-gray-700">Select Date to View</label>
                        <input type="date" id="doc-apt-date" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-[hsl(149_52%_46%)] focus:border-[hsl(149_52%_46%)] sm:text-sm" required>
                        
                        <div id="doc-apt-msg" class="text-center p-4 bg-gray-100 text-gray-700 rounded-lg mt-6" style="display: none;">
                            Loading...
                        </div>
                        <ul id="doc-apt-list" class="space-y-4 mt-6 max-h-96 overflow-y-auto">
                            </ul>
                    </div>
                </div>

                <div id="doctor-page-export" style="display: none;">
                    <h1 class="text-3xl font-bold text-gray-900 mb-4">Export Patient Data</h1>
                    <div class="bg-white p-6 rounded-lg shadow-lg max-w-lg mx-auto text-center">
                        <p class="text-gray-600 mb-4">Select a date to export all live queue patient data (waiting and seen) to a CSV file.</p>
                        <input type="date" id="export-date" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-[hsl(149_52%_46%)] focus:border-[hsl(149_52%_46%)] sm:text-sm mb-4" required>
                        <button id="export-btn" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-[hsl(149_52%_46%)] hover:bg-[hsl(149_52%_40%)] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[hsl(149_52%_46%)]">
                            Export Patients to CSV
                        </button>
                    </div>
                </div>
                
                <div id="doctor-page-financials" style="display: none;">
                    <div class="mb-6">
                        <h1 class="text-3xl sm:text-4xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent mb-2">Financial Analytics</h1>
                        <p class="text-gray-600 text-sm sm:text-base">Track and analyze your clinic's revenue performance</p>
                    </div>
                    
                    <div class="bg-white/80 backdrop-blur-sm p-4 sm:p-6 rounded-2xl shadow-xl border border-gray-100 mb-6">
                        <h2 class="text-lg sm:text-xl font-semibold text-gray-800 mb-4">Select Date Range</h2>
                        <div class="flex flex-wrap items-center gap-2 sm:gap-3 mb-4">
                            <button id="financials-today-btn" type="button" class="px-4 py-2.5 text-sm font-medium text-white bg-gradient-to-r from-blue-600 to-blue-700 border border-transparent rounded-xl hover:from-blue-700 hover:to-blue-800 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-all duration-200 shadow-md hover:shadow-lg transform hover:-translate-y-0.5 cursor-pointer">Today</button>
                            <button id="financials-week-btn" type="button" class="px-4 py-2.5 text-sm font-medium text-gray-700 bg-gray-100 border border-gray-200 rounded-xl hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 transition-all duration-200 cursor-pointer">This Week</button>
                            <button id="financials-month-btn" type="button" class="px-4 py-2.5 text-sm font-medium text-gray-700 bg-gray-100 border border-gray-200 rounded-xl hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 transition-all duration-200 cursor-pointer">This Month</button>
                            <button id="financials-custom-btn" type="button" class="px-4 py-2.5 text-sm font-medium text-gray-700 bg-gray-100 border border-gray-200 rounded-xl hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 transition-all duration-200 cursor-pointer">Custom Range</button>
                        </div>
                        <div id="financials-custom-range" class="flex flex-col sm:flex-row flex-wrap items-stretch sm:items-end gap-3 sm:gap-4 animate-fade-in" style="display: none;">
                            <div class="flex-1 min-w-[140px]">
                                <label for="financials-start-date" class="block text-sm font-medium text-gray-700 mb-1.5">Start Date</label>
                                <input type="date" id="financials-start-date" class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm transition-all duration-200">
                            </div>
                            <div class="flex-1 min-w-[140px]">
                                <label for="financials-end-date" class="block text-sm font-medium text-gray-700 mb-1.5">End Date</label>
                                <input type="date" id="financials-end-date" class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm transition-all duration-200">
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6 mb-6">
                        <div class="bg-gradient-to-br from-emerald-500 via-emerald-600 to-teal-600 text-white shadow-xl rounded-2xl p-5 sm:p-6 text-center transform hover:scale-105 transition-transform duration-200">
                            <div class="flex items-center justify-center mb-2">
                                <svg class="w-8 h-8 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <h2 class="text-sm sm:text-base font-medium text-emerald-50 uppercase tracking-wider mb-2">Total Revenue</h2>
                            <p id="financials-total-revenue" class="text-4xl sm:text-5xl font-extrabold">₹0.00</p>
                        </div>
                        <div class="bg-gradient-to-br from-blue-500 via-blue-600 to-indigo-600 text-white shadow-xl rounded-2xl p-5 sm:p-6 text-center transform hover:scale-105 transition-transform duration-200">
                            <div class="flex items-center justify-center mb-2">
                                <svg class="w-8 h-8 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                </svg>
                            </div>
                            <h2 class="text-sm sm:text-base font-medium text-blue-50 uppercase tracking-wider mb-2">Avg per Patient</h2>
                            <p id="financials-avg-revenue" class="text-4xl sm:text-5xl font-extrabold">₹0.00</p>
                        </div>
                        <div class="bg-gradient-to-br from-purple-500 via-purple-600 to-pink-600 text-white shadow-xl rounded-2xl p-5 sm:p-6 text-center transform hover:scale-105 transition-transform duration-200 sm:col-span-2 lg:col-span-1">
                            <div class="flex items-center justify-center mb-2">
                                <svg class="w-8 h-8 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                                </svg>
                            </div>
                            <h2 class="text-sm sm:text-base font-medium text-purple-50 uppercase tracking-wider mb-2">Transactions</h2>
                            <p id="financials-transaction-count" class="text-4xl sm:text-5xl font-extrabold">0</p>
                        </div>
                    </div>
                    
                    <div class="bg-white/80 backdrop-blur-sm shadow-xl rounded-2xl p-4 sm:p-6 border border-gray-100">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-4">
                            <h2 class="text-xl sm:text-2xl font-bold text-gray-800">Transaction History</h2>
                            <button id="financials-export-btn" class="w-full sm:w-auto px-5 py-2.5 text-sm font-medium text-white bg-gradient-to-r from-emerald-600 to-teal-600 border border-transparent rounded-xl hover:from-emerald-700 hover:to-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500 transition-all duration-200 shadow-md hover:shadow-lg transform hover:-translate-y-0.5 flex items-center justify-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                Export CSV
                            </button>
                        </div>
                        <ul id="financials-transactions-list" class="space-y-3 max-h-[60vh] overflow-y-auto custom-scrollbar">
                            <li class="text-center text-gray-500 py-8 text-sm sm:text-base">Select a date range to view transactions.</li>
                        </ul>
                    </div>
                </div>
                
                <div id="doctor-page-settings" style="display: none;">
                    <div class="mb-6">
                        <h1 class="text-3xl sm:text-4xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent mb-2">Clinic Settings</h1>
                        <p class="text-gray-600 text-sm sm:text-base">Configure your clinic's location and access parameters</p>
                    </div>
                    <div class="bg-white/80 backdrop-blur-sm p-4 sm:p-6 lg:p-8 rounded-2xl shadow-xl border border-gray-100 max-w-3xl mx-auto">
                        <div class="flex items-center gap-3 mb-6">
                            <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center">
                                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>
                            </div>
                            <div>
                                <h2 class="text-xl sm:text-2xl font-bold text-gray-800">Location Configuration</h2>
                                <p class="text-sm text-gray-500">Set your clinic's geographic coordinates</p>
                            </div>
                        </div>
                        <p class="text-gray-600 mb-6 text-sm sm:text-base">Configure the clinic's location coordinates and maximum distance for patient queue joining. Patients must be within this distance to join the live queue.</p>
                        
                        <div class="space-y-5">
                            <div>
                                <label for="settings-lat-input" class="block text-sm font-semibold text-gray-700 mb-2">Clinic Latitude</label>
                                <input type="number" id="settings-lat-input" step="any" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm sm:text-base transition-all duration-200" placeholder="e.g., 12.9432">
                                <p class="mt-2 text-xs text-gray-500 flex items-center gap-1">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                    Enter latitude between -90 and 90
                                </p>
                            </div>
                            <div>
                                <label for="settings-lon-input" class="block text-sm font-semibold text-gray-700 mb-2">Clinic Longitude</label>
                                <input type="number" id="settings-lon-input" step="any" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm sm:text-base transition-all duration-200" placeholder="e.g., 80.1584">
                                <p class="mt-2 text-xs text-gray-500 flex items-center gap-1">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                    Enter longitude between -180 and 180
                                </p>
                            </div>
                            <div>
                                <label for="settings-max-distance-input" class="block text-sm font-semibold text-gray-700 mb-2">Maximum Distance (meters)</label>
                                <input type="number" id="settings-max-distance-input" min="0" step="1" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm sm:text-base transition-all duration-200" placeholder="e.g., 100000">
                                <p class="mt-2 text-xs text-gray-500 flex items-center gap-1">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                    Maximum distance in meters from clinic location
                                </p>
                            </div>
                            <div>
                                <button id="settings-save-btn" class="w-full flex justify-center items-center gap-2 py-3.5 px-6 border border-transparent rounded-xl shadow-lg text-sm sm:text-base font-semibold text-white bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all duration-200 transform hover:-translate-y-0.5 hover:shadow-xl">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                    </svg>
                                    Save Settings
                                </button>
                                <p id="settings-status-msg" class="text-sm text-center mt-3" style="display: none;"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-white"></div>
    </div>

    <div id="modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full mx-4">
            <h3 class="text-lg font-medium text-gray-900">Notification</h3>
            <p id="modal-message" class="mt-2 text-sm text-gray-600">This is an alert message.</p>
            <div class="mt-4 text-right">
                <button id="modal-close-btn" type="button" class="inline-flex justify-center px-4 py-2 text-sm font-medium text-white bg-[hsl(149_52%_46%)] border border-transparent rounded-md hover:bg-[hsl(149_52%_40%)] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[hsl(149_52%_46%)]">
                    OK
                </button>
            </div>
        </div>
    </div>

    <div id="notes-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 p-4" style="display: none;">
        <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full overflow-hidden">
            <div class="bg-gradient-to-r from-blue-600 to-indigo-600 px-6 py-5">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 rounded-full bg-white/20 flex items-center justify-center">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-xl sm:text-2xl font-bold text-white">Complete Patient Visit</h3>
                        <p class="text-sm text-blue-100 mt-0.5">Add notes and fee to finalize consultation</p>
                    </div>
                </div>
                </div>

            <form id="notes-form" class="p-6 sm:p-8">
                <div class="space-y-5">
                <div>
                        <label for="consultation-fee" class="block text-sm font-semibold text-gray-700 mb-2">
                            <span class="flex items-center gap-2">
                                <svg class="w-4 h-4 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                Consultation Fee (INR)
                            </span>
                        </label>
                        <input type="number" id="consultation-fee" min="0" step="0.01" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-base transition-all duration-200" placeholder="e.g., 500" required>
                        <p class="mt-1.5 text-xs text-gray-500">Enter the fee charged for this consultation</p>
                </div>

                    <div>
                        <label for="notes-text" class="block text-sm font-semibold text-gray-700 mb-2">
                            <span class="flex items-center gap-2">
                                <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                Visit Notes
                            </span>
                        </label>
                        <textarea id="notes-text" rows="6" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-base transition-all duration-200 resize-none" placeholder="Enter diagnosis, prescription, or visit summary..." required></textarea>
                        <p class="mt-1.5 text-xs text-gray-500">These notes will be saved to the patient's history</p>
                    </div>
                </div>
                
                <div class="mt-8 flex flex-col sm:flex-row justify-end gap-3 pt-6 border-t border-gray-200">
                    <button id="notes-cancel-btn" type="button" class="w-full sm:w-auto px-6 py-3 text-sm font-semibold text-gray-700 bg-gray-100 border-2 border-gray-200 rounded-xl hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 transition-all duration-200">
                        Cancel
                    </button>
                    <button id="notes-submit-btn" type="submit" class="w-full sm:w-auto px-6 py-3 text-sm font-semibold text-white bg-gradient-to-r from-blue-600 to-indigo-600 border border-transparent rounded-xl hover:from-blue-700 hover:to-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all duration-200 shadow-md hover:shadow-lg transform hover:-translate-y-0.5 flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        Complete & Dismiss
                    </button>
                </div>
            </form>
        </div>
    </div>

</body>
</html>