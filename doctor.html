<!DOCTYPE html>

<html lang="en">

<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- PWA Tags -->

    <meta name="theme-color" content="#4f46e5" />

    <link rel="manifest" href="/manifest.json">

    <link rel="apple-touch-icon" href="/icon-192x192.png">

    <title>MediQueue - Doctor Admin</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>

    <!-- QR Code Library -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

    <style>

        @keyframes fadeIn {

            from { opacity: 0; transform: translateY(-10px); }

            to { opacity: 1; transform: translateY(0); }

        }

        @keyframes spin {

            from { transform: rotate(0deg); }

            to { transform: rotate(360deg); }

        }

        .animate-fade-in {

            animation: fadeIn 0.3s ease-out;

        }

        .animate-spin-fast {

            animation: spin 0.8s linear infinite;

        }

        .custom-scrollbar::-webkit-scrollbar { width: 8px; }

        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }

        .custom-scrollbar::-webkit-scrollbar-thumb { background: linear-gradient(to bottom, #3b82f6, #8b5cf6); border-radius: 10px; }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: linear-gradient(to bottom, #2563eb, #7c3aed); }

        

        body {

            background-color: #f8fafc; /* Light clean gray */

            min-height: 100vh;

        }

        input[type="number"],

        input[type="date"],

        textarea,

        select {

            font-size: 16px !important;

        }



        /* --- Mobile App-like Optimizations --- */

        body, html {

            overscroll-behavior-y: contain;

        }

        button,

        a[role="button"],

        button[type="submit"] {

            -webkit-tap-highlight-color: transparent;

            user-select: none;

            -webkit-user-select: none; /* Safari */

        }



        /* --- Active Nav Button States --- */

        .nav-btn-active {

            background-color: #4f46e5 !important; /* Indigo-600 */

            color: white !important;

        }

        .mobile-nav-btn-active {

            color: #4f46e5 !important;

            border-bottom-width: 2px;

            border-color: #4f46e5;

        }

        /* --- Finance Tab Button States --- */

        .tab-btn-active {

            border-color: #4f46e5;

            color: #4f46e5;

            background-color: #eef2ff;

        }

    </style>

    <script type="module">

        // Firebase Imports

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";

        import {

            getAuth,

            setPersistence,

            browserLocalPersistence,

            onAuthStateChanged,

            signOut

        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        import {

            getFirestore,

            collection,

            addDoc,

            query,

            where,

            onSnapshot,

            serverTimestamp,

            doc,

            updateDoc,

            setDoc,

            getDoc,

            getDocs,

            orderBy,

            Timestamp,

            collectionGroup,

            limit 

        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";



        // --- App Configuration ---

        const firebaseConfig = {

          apiKey: "",

          authDomain: "main-8c336.firebaseapp.com",

          projectId: "main-8c336",

          storageBucket: "main-8c336.firebasestorage.app",

          messagingSenderId: "507656529909",

          appId: "1:507656529909:web:ccea008f4a1178bf0da2bc",

          measurementId: "G-RX4KHQRQMJ"

        };

        const appId = firebaseConfig.projectId;

        const ADMIN_EMAIL = "prajansanjayko@gmail.com";



        // --- Initialization ---

        window.onload = async () => {



            // --- PWA Service Worker Registration ---

            if ('serviceWorker' in navigator) {

                try {

                    await navigator.serviceWorker.register('/sw.js'); // Use absolute path

                    console.log('Service Worker registered successfully');

                } catch (err) {

                    console.error('Service Worker registration failed:', err);

                }

            }

            // --- PWA Install Prompt ---

            let deferredInstallPrompt = null;



            // DOM Elements

            let app, db, auth;

            let doctorApp;

            let doctorPages = {};



            // Navbar

            let mainNav, patientNav, doctorNav, authControls, userDisplay, logoutBtn;

            // FIX: Added all nav buttons

            let doctorNavDashboard, doctorNavCall, doctorNavAppointments, doctorNavFinance, doctorNavSettings, doctorNavExport, doctorNavExpenses;

            let mobileMenu, mobileMenuBtn, mobileAuthControls, mobileUserDisplay, mobileLogoutBtn;

            let mobilePatientNav, mobileDoctorNav;

            let mobileNavDashboard, mobileNavCall, mobileNavAppointments, mobileNavFinance, mobileNavSettings, mobileNavExport, mobileNavExpenses;



            // Doctor: Dashboard

            let welcomeMsg, liveDate, liveTime;

            let waitingCountEl, seenCountEl, revenueEl;

            let upNextPatientCard, callPatientBtn;

            let aptList, aptMsg;

            

            // Doctor: Settings

            let settingsLatInput, settingsLonInput, settingsMaxDistanceInput, settingsSaveBtn, settingsStatusMsg;

            let settingsGetLocationBtn, installPwaBtn; 

            let dailyLimitInput, saveLimitBtn, limitSaveStatus;

            let qrCodeCanvas, dailyPasscodeEl, remotePasscodeInput, savePasscodeBtn, passcodeSaveStatus; 

            

            // --- NEW: Finance Page (Combined) ---

            let financeRevenueTabBtn, financeExpensesTabBtn, financeRevenuePage, financeExpensesPage;

            

            // Finance (Revenue)

            let financialsTodayBtn, financialsWeekBtn, financialsMonthBtn, financialsCustomBtn;

            let financialsStartDateInput, financialsEndDateInput, financialsTotalRevenueEl, financialsAvgRevenueEl;

            let financialsTransactionCountEl, financialsTransactionsList, financialsExportBtn;



            // Finance (Expenses)

            let expenseForm, expenseDate, expenseCategory, expenseAmount, expenseDescription, saveExpenseBtn, expenseStatusMsg;

            let expenseList, expenseListMsg;

            

            // Doctor: Call Patient

            let doctorQueueList, doctorMessageEl, preRegisteredList, preRegisteredMsg; // <-- NEW



            // Doctor: Notes Modal

            let notesModal, notesForm, notesText, notesSubmitBtn, notesCancelBtn;

            let notesFeeInput, nextVisitDateInput;

            let previousHistoryList, previousHistoryMsg; 

            let currentPatientForNotes = null;



            // Doctor: Appointments

            let docAptDateInput, docAptList, docAptMsg;



            // Doctor: Export (Added elements)

            let exportPage, exportDateInput, exportBtn;



            // Global Utilities

            let loadingOverlay, modal, modalMessage, modalCloseBtn;



            // App State

            let currentUserId = null;

            let currentUserEmail = null;

            let currentUserDisplayName = null;

            let isAuthReady = false;

            let isAdmin = false; 



            let doctorQueueUnsubscribe = null;

            let dashboardUnsubscribe = null;

            let settingsUnsubscribe = null; 

            let expensesUnsubscribe = null; 

            let timeUpdateInterval = null;



            let currentFinancialsData = []; 



            // --- Initialize Firebase ---

            try {

                app = initializeApp(firebaseConfig);

                db = getFirestore(app);

                auth = getAuth(app);

                await setPersistence(auth, browserLocalPersistence);

            } catch (error) {

                console.error("Firebase Init Error:", error);

                showModal("Error initializing app. Please check your Firebase config and refresh.");

                return;

            }



            // --- 2. Authentication Logic ---

            async function handleLogout() {

                await signOut(auth);

                window.location.href = '/index.html'; // FIX: Absolute path

            }



            // --- Financials Button Styler ---

            function updateFinancialsButtonStyle(activeBtn) {

                const buttons = [

                    { btn: financialsTodayBtn, id: 'today' },

                    { btn: financialsWeekBtn, id: 'week' },

                    { btn: financialsMonthBtn, id: 'month' },

                    { btn: financialsCustomBtn, id: 'custom' }

                ];

                buttons.forEach(({ btn, id }) => {

                    if (!btn) return;

                    if (id === activeBtn) {

                        btn.className = 'px-4 py-2.5 text-sm font-medium text-white bg-gradient-to-r from-blue-600 to-blue-700 border border-transparent rounded-xl hover:from-blue-700 hover:to-blue-800 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-all duration-200 shadow-md hover:shadow-lg transform hover:-translate-y-0.5';

                    } else {

                        btn.className = 'px-4 py-2.5 text-sm font-medium text-gray-700 bg-gray-100 border border-gray-200 rounded-xl hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 transition-all duration-200';

                    }

                });

            }



            // --- NEW: Finance Tab Changer ---

            function showFinanceTab(tabId) {

                if (tabId === 'revenue') {

                    if (financeRevenuePage) financeRevenuePage.style.display = 'block';

                    if (financeExpensesPage) financeExpensesPage.style.display = 'none';

                    if (financeRevenueTabBtn) financeRevenueTabBtn.classList.add('tab-btn-active');

                    if (financeExpensesTabBtn) financeExpensesTabBtn.classList.remove('tab-btn-active');

                    // Load financials data

                    setupFinancialsButtons();

                    updateFinancialsButtonStyle('today'); 

                    loadFinancials('today'); 

                } else if (tabId === 'expenses') {

                    if (financeRevenuePage) financeRevenuePage.style.display = 'none';

                    if (financeExpensesPage) financeExpensesPage.style.display = 'block';

                    if (financeRevenueTabBtn) financeRevenueTabBtn.classList.remove('tab-btn-active');

                    if (financeExpensesTabBtn) financeExpensesTabBtn.classList.add('tab-btn-active');

                    // Load expenses data

                    loadExpenseDefaults();

                    attachExpensesListener();

                }

            }



            // --- 3. Page Navigation Logic ---

            function showDoctorView(pageId) {

                if (!doctorApp) return;

                doctorApp.style.display = 'block';



                Object.values(doctorPages).forEach(page => {

                    if (page) { 

                        page.style.display = 'none';

                    }

                });

                if (doctorPages[pageId]) {

                    doctorPages[pageId].style.display = 'block';

                }



                // FIX: Use corrected variable names

                const allNavButtons = [

                    doctorNavDashboard, doctorNavCall, doctorNavAppointments, doctorNavFinance, doctorNavSettings, doctorNavExport, doctorNavExpenses,

                    mobileNavDashboard, mobileNavCall, mobileNavAppointments, mobileNavFinance, mobileNavSettings, mobileNavExport, mobileNavExpenses

                ];

                allNavButtons.forEach(btn => {

                    btn?.classList.remove('nav-btn-active', 'mobile-nav-btn-active');

                });

                

                // Stop all listeners

                if (dashboardUnsubscribe) dashboardUnsubscribe();

                if (doctorQueueUnsubscribe) doctorQueueUnsubscribe();

                if (settingsUnsubscribe) settingsUnsubscribe(); 

                if (expensesUnsubscribe) expensesUnsubscribe(); 

                if (timeUpdateInterval) clearInterval(timeUpdateInterval);

                

                if (pageId === 'dashboard') {

                    doctorNavDashboard?.classList.add('nav-btn-active');

                    mobileNavDashboard?.classList.add('mobile-nav-btn-active');

                    updateTime();

                    timeUpdateInterval = setInterval(updateTime, 1000);

                    attachDashboardListeners(); 

                } else if (pageId === 'call') {

                    doctorNavCall?.classList.add('nav-btn-active');

                    mobileNavCall?.classList.add('mobile-nav-btn-active');

                    attachDoctorQueueListener(); 

                } else if (pageId === 'appointments') {

                    doctorNavAppointments?.classList.add('nav-btn-active');

                    mobileNavAppointments?.classList.add('mobile-nav-btn-active');

                    if(docAptDateInput) docAptDateInput.valueAsDate = new Date();

                    loadDoctorAppointments(); 

                } else if (pageId === 'finance') { // <-- UPDATED

                    doctorNavFinance?.classList.add('nav-btn-active');

                    mobileNavFinance?.classList.add('mobile-nav-btn-active');

                    showFinanceTab('revenue'); // Default to revenue

                } else if (pageId === 'settings') {

                    doctorNavSettings?.classList.add('nav-btn-active');

                    mobileNavSettings?.classList.add('mobile-nav-btn-active');

                    attachSettingsListener(); 

                } else if (pageId === 'export') {

                    doctorNavExport?.classList.add('nav-btn-active');

                    mobileNavExport?.classList.add('mobile-nav-btn-active');

                    if(exportDateInput) exportDateInput.valueAsDate = new Date();

                }

                // Note: 'expenses' page is now *inside* the 'finance' page, so it doesn't need a top-level nav item

            }



            // --- Settings Logic (Combined) ---

            function attachSettingsListener() {

                if (!db) return;

                

                if (settingsUnsubscribe) settingsUnsubscribe();



                // Listener for settings

                const settingsRef = doc(db, `artifacts/${appId}/public/data/clinicSettings/settings`);

                const unsubSettings = onSnapshot(settingsRef, (docSnap) => {

                    if (docSnap.exists()) {

                        const data = docSnap.data();

                        if (settingsLatInput) settingsLatInput.value = data.latitude;

                        if (settingsLonInput) settingsLonInput.value = data.longitude;

                        if (settingsMaxDistanceInput) settingsMaxDistanceInput.value = data.maxDistanceMeters;

                    } else {

                        if (settingsLatInput) settingsLatInput.value = 12.94320783333333;

                        if (settingsLonInput) settingsLonInput.value = 80.15839316666666;

                        if (settingsMaxDistanceInput) settingsMaxDistanceInput.value = 100000;

                    }

                }, (error) => {

                    console.error("Error loading settings:", error);

                });



                // Listener for status (limit + passcode)

                const statusRef = doc(db, `artifacts/${appId}/public/data/clinicStatus/status`);

                const unsubStatus = onSnapshot(statusRef, (docSnap) => {

                    let currentPasscode = "ABCD"; // Default

                    if (docSnap.exists()) {

                        const data = docSnap.data();

                        if (data.dailyLimit !== undefined) {

                            if (dailyLimitInput) dailyLimitInput.value = data.dailyLimit;

                        } else {

                            if (dailyLimitInput) dailyLimitInput.value = 50; // Default

                        }

                        if (data.remotePasscode) {

                            currentPasscode = data.remotePasscode;

                            if (remotePasscodeInput) remotePasscodeInput.value = data.remotePasscode;

                            if (dailyPasscodeEl) dailyPasscodeEl.textContent = data.remotePasscode;

                        }

                    } else {

                         if (dailyLimitInput) dailyLimitInput.value = 50;

                    }

                    generateQRCode(currentPasscode); // Generate QR for the current code

                }, (error) => {

                     console.error("Error getting real-time clinic status:", error);

                      if (dailyLimitInput) dailyLimitInput.value = 50;

                      generateQRCode("ABCD"); // Generate default QR on error

                });



                settingsUnsubscribe = () => {

                    unsubSettings();

                    unsubStatus();

                };

            }



            async function saveClinicSettings() {

                if (!db || !isAdmin) return;

                if (!settingsLatInput || !settingsLonInput || !settingsMaxDistanceInput) return;

                

                const lat = parseFloat(settingsLatInput.value);

                const lon = parseFloat(settingsLonInput.value);

                const maxDist = parseInt(settingsMaxDistanceInput.value);

                

                if (isNaN(lat) || isNaN(lon) || isNaN(maxDist) || lat < -90 || lat > 90 || lon < -180 || lon > 180 || maxDist < 0) {

                    showModal("Please enter valid coordinates and distance.");

                    return;

                }

                

                try {

                    const settingsRef = doc(db, `artifacts/${appId}/public/data/clinicSettings/settings`);

                    await setDoc(settingsRef, {

                        latitude: lat,

                        longitude: lon,

                        maxDistanceMeters: maxDist,

                        updatedAt: serverTimestamp()

                    }, { merge: true }); 

                    

                    if (settingsStatusMsg) {

                        settingsStatusMsg.textContent = "Location settings saved!";

                        settingsStatusMsg.className = "text-sm text-green-600 mt-2";

                        settingsStatusMsg.style.display = 'block';

                    }

                    setTimeout(() => { if (settingsStatusMsg) settingsStatusMsg.style.display = 'none'; }, 3000);

                } catch (error) {

                    console.error("Error saving clinic settings:", error);

                    if (settingsStatusMsg) {

                        settingsStatusMsg.textContent = "Error saving location settings.";

                        settingsStatusMsg.className = "text-sm text-red-600 mt-2";

                        settingsStatusMsg.style.display = 'block';

                    }

                }

            }



            function handleGetDoctorLocation() {

                if (!navigator.geolocation) {

                    showModal("Geolocation is not supported by your browser.");

                    return;

                }

                navigator.geolocation.getCurrentPosition(

                    (position) => {

                        const { latitude, longitude } = position.coords;

                        if (settingsLatInput) settingsLatInput.value = latitude.toFixed(8);

                        if (settingsLonInput) settingsLonInput.value = longitude.toFixed(8);

                        showModal("Current location populated. Click 'Save Settings' to confirm.");

                    },

                    (error) => {

                        showModal(`Error getting location: ${error.message}`);

                    },

                    { enableHighAccuracy: true }

                );

            }

            

            // --- Finance (Revenue) Logic ---

			async function loadFinancials(range) {

			   if (!db) return;

			   

			   if (financialsTransactionsList) {

			      financialsTransactionsList.innerHTML = '<li class="text-center text-gray-500 py-8"><div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mb-3"></div><p class="text-gray-500">Loading financial data...</p></li>';

			   }

			   

			   let startDate, endDate;

			   const now = new Date();

			   now.setHours(23, 59, 59, 999);

			   

			   if (range === 'today') {

			      startDate = new Date(now);

			      startDate.setHours(0, 0, 0, 0);

			      endDate = now;

			   } else if (range === 'week') {

			      startDate = new Date(now);

			      startDate.setDate(startDate.getDate() - 6);

			      startDate.setHours(0, 0, 0, 0);

			      endDate = now;

			   } else if (range === 'month') {

			      startDate = new Date(now);

			      startDate.setDate(1);

			      startDate.setHours(0, 0, 0, 0);

			      endDate = now;

			   } else if (range === 'custom') {

			      if (!financialsStartDateInput.value || !financialsEndDateInput.value) {

			         showModal("Please select both start and end dates.");

			         return;

			      }

			      startDate = new Date(financialsStartDateInput.value);

			      startDate.setHours(0, 0, 0, 0);

			      endDate = new Date(financialsEndDateInput.value);

			      endDate.setHours(23, 59, 59, 999);

			      

			      if (startDate > endDate) {

			         showModal("Start date cannot be after end date.");

			         return;

			      }

			   }

			   

			   try {

			      const q = query(collection(db, `artifacts/${appId}/public/data/queue`),

			                     where("status", "==", "seen"),

			                     where("completedAt", ">=", Timestamp.fromDate(startDate)),

			                     where("completedAt", "<=", Timestamp.fromDate(endDate)),

			                     orderBy("completedAt", "desc")

			                    );

			      const querySnapshot = await getDocs(q);

			      

			      let totalRevenue = 0;

			      let transactions = [];

			      

			      querySnapshot.forEach(docSnap => {

			         const data = docSnap.data();

			         const fee = parseFloat(data.fee || 0);

			         if (fee > 0) {

			            totalRevenue += fee;

			            transactions.push({

			               id: docSnap.id,

			               name: data.name || 'Unknown',

			               mobile: data.mobile || 'N/A',

			               fee: fee,

			               completedAt: data.completedAt?.toDate() || new Date(),

			               notes: data.notes || ''

			            });

			         }

			      });

			

			      currentFinancialsData = transactions; 

			      

			      const transactionCount = transactions.length;

			      const avgRevenue = transactionCount > 0 ? totalRevenue / transactionCount : 0;

			      

			      if (financialsTotalRevenueEl) financialsTotalRevenueEl.textContent = `₹${totalRevenue.toFixed(2)}`;

			      if (financialsAvgRevenueEl) financialsAvgRevenueEl.textContent = `₹${avgRevenue.toFixed(2)}`;

			      if (financialsTransactionCountEl) financialsTransactionCountEl.textContent = transactionCount;

			      

			      if (financialsTransactionsList) {

			         financialsTransactionsList.innerHTML = '';

			         if (transactions.length === 0) {

			            financialsTransactionsList.innerHTML = '<li class="text-center text-gray-500 py-12"><svg class="mx-auto h-12 w-12 text-gray-400 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg><p class="text-gray-500">No transactions found for this period.</p></li>';

			         } else {

			            transactions.forEach((txn, index) => {

			               const li = document.createElement('li');

			               li.className = 'bg-gradient-to-r from-white to-gray-50 hover:from-blue-50 hover:to-indigo-50 shadow-md hover:shadow-xl rounded-xl p-4 sm:p-5 border border-gray-200 hover:border-blue-300 transition-all duration-200 transform hover:-translate-y-1';

			               const dateStr = txn.completedAt.toLocaleDateString('en-US', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' });

			               const timeStr = txn.completedAt.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

			               li.innerHTML = `

			                  <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3">

			                     <div class="flex-1">

			                        <div class="flex items-center gap-2 mb-1">

			                           <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center text-white font-bold text-sm">

			                              ${txn.name.charAt(0).toUpperCase()}

			                           </div>

			                           <div>

			                              <p class="font-bold text-gray-800 text-base sm:text-lg">${txn.name}</p>

			                              <p class="text-xs sm:text-sm text-gray-500">${txn.mobile}</p>

			                           </div>

			                        </div>

			                        <p class="text-xs sm:text-sm text-gray-500 mt-1.5 ml-12 sm:ml-0"><span class="inline-flex items-center gap-1"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>${dateStr}</span> <span class="ml-2">${timeStr}</span></p>

			                     </div>

			                     <div class="ml-12 sm:ml-0">

			                        <p class="font-extrabold text-emerald-600 text-2xl sm:text-3xl">₹${txn.fee.toFixed(2)}</p>

			                        <p class="text-xs text-gray-400 text-right mt-0.5">Payment</p>

			                     </div>

			                  </div>

			               `;

			               financialsTransactionsList.appendChild(li);

			            });

			         }

			      }

			   } catch (error) {

			      console.error("Error loading financials:", error);

			      if (financialsTransactionsList) {

			         financialsTransactionsList.innerHTML = '<li class="text-center text-red-500 py-8"><p class="font-semibold">Error loading financial data</p><p class="text-sm text-gray-500 mt-2">' + error.message + '</p></li>';

			      }

			      if (error.code === 'failed-precondition') {

			         showModal("Database index missing for financials query. Please create the required index in Firebase. Check the browser console (F12) for the index creation link.");

			      } else if (error.code === 'permission-denied') {

			         showModal("Permission denied. Please check your Firebase rules and ensure you're logged in as admin.");

			      } else {

			         showModal("Error loading financials: " + error.message);

			      }

			   }

			}

            

            async function exportFinancialsCSV() {

                if (currentFinancialsData.length === 0) {

                    showModal("No transactions to export.");

                    return;

                }

                

                let csvContent = "Date,Time,Patient Name,Mobile,Fee (INR),Notes\r\n";

                

                currentFinancialsData.forEach(txn => {

                    const dateStr = txn.completedAt.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });

                    const timeStr = txn.completedAt.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                    

                    const name = (txn.name || '').replace(/"/g, '""');

                    const mobile = (txn.mobile || '').replace(/"/g, '""');

                    const fee = txn.fee.toFixed(2);

                    const notes = (txn.notes || '').replace(/"/g, '""').replace(/\r?\n|\r/g, ' '); // Sanitize



                    csvContent += `"${dateStr}","${timeStr}","${name}","${mobile}","${fee}","${notes}"\r\n`;

                });

                

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });

                const link = document.createElement('a');

                const url = URL.createObjectURL(blob);

                link.setAttribute('href', url);

                link.setAttribute('download', `financials_${new Date().toISOString().split('T')[0]}.csv`);

                link.style.visibility = 'hidden';

                document.body.appendChild(link);

                link.click();

                document.body.removeChild(link);

            }



            // --- 8. Doctor: Dashboard Logic (UPDATED for Passcode) ---

            function updateTime() {

                const now = new Date();

                if (liveDate) liveDate.textContent = now.toLocaleDateString(undefined, {

                    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'

                });

                if (liveTime) liveTime.textContent = now.toLocaleTimeString();

            }



            async function handleSaveLimit() {

                if (!dailyLimitInput) return;

                const limit = parseInt(dailyLimitInput.value);

                if (isNaN(limit) || limit < 0) {

                    showModal("Please enter a valid positive number for the limit.");

                    return;

                }



                const statusRef = doc(db, `artifacts/${appId}/public/data/clinicStatus/status`);

                try {

                    await Tone.start();

                    await setDoc(statusRef, { dailyLimit: limit }, { merge: true }); 

                    if (limitSaveStatus) {

                        limitSaveStatus.textContent = "Limit saved successfully!";

                        limitSaveStatus.className = "text-sm text-green-600 mt-2";

                        limitSaveStatus.style.display = 'block';

                    }

                    setTimeout(() => { if (limitSaveStatus) limitSaveStatus.style.display = 'none'; }, 3000);

                } catch (error) {

                    console.error("Error saving limit:", error);

                    if (limitSaveStatus) {

                        limitSaveStatus.textContent = "Error saving limit.";

                        limitSaveStatus.className = "text-sm text-red-600 mt-2";

                        limitSaveStatus.style.display = 'block';

                    }

                }

            }



            // --- NEW: Function to save the remote passcode ---

            async function handleSavePasscode() {

                if (!remotePasscodeInput) return;

                const newPasscode = remotePasscodeInput.value.trim().toUpperCase();

                

                if (newPasscode.length < 4) {

                    showModal("Passcode must be at least 4 characters long.");

                    return;

                }



                const statusRef = doc(db, `artifacts/${appId}/public/data/clinicStatus/status`);

                try {

                    await setDoc(statusRef, { remotePasscode: newPasscode }, { merge: true });

                    if (passcodeSaveStatus) {

                        passcodeSaveStatus.textContent = "Passcode saved successfully!";

                        passcodeSaveStatus.className = "text-sm text-green-600 mt-2";

                        passcodeSaveStatus.style.display = 'block';

                    }

                    generateQRCode(newPasscode); // Re-generate QR code

                    setTimeout(() => { if (passcodeSaveStatus) passcodeSaveStatus.style.display = 'none'; }, 3000);

                } catch (error) {

                    console.error("Error saving passcode:", error);

                    if (passcodeSaveStatus) {

                        passcodeSaveStatus.textContent = "Error saving passcode.";

                        passcodeSaveStatus.className = "text-sm text-red-600 mt-2";

                        passcodeSaveStatus.style.display = 'block';

                    }

                }

            }



            // --- NEW: Function to generate QR code ---

            function generateQRCode(passcode) {

                if (!qrCodeCanvas) return;

                // --- FIX: Get the URL for patient.html ---

                const pageUrl = window.location.href.replace('doctor.html', 'patient.html');

                const fullUrl = `${pageUrl}?pass=${passcode}`;

                

                new QRious({

                    element: qrCodeCanvas,

                    value: fullUrl,

                    size: 200,

                    padding: 10,

                    level: 'H'

                });

            }



            function attachDashboardListeners() {

                if (!isAuthReady || !db) return;

                if (welcomeMsg) welcomeMsg.textContent = `Welcome, ${currentUserDisplayName || 'Doctor'}!`;



                const today = new Date();

                today.setHours(0, 0, 0, 0);

                const tomorrow = new Date(today);

                tomorrow.setDate(tomorrow.getDate() + 1);



                // --- Query 1: Patients WAITING ---

                const waitingQuery = query(collection(db, `artifacts/${appId}/public/data/queue`),

                                    where("status", "==", "waiting"),

                                    orderBy("joinedAt", "asc"));

                

                const unsubWaiting = onSnapshot(waitingQuery, (querySnapshot) => {

                    if (waitingCountEl) waitingCountEl.textContent = querySnapshot.size;

                    

                    if (querySnapshot.empty) {

                        if (upNextPatientCard) {

                            upNextPatientCard.innerHTML = `

                                <div class="text-center text-gray-500 py-8">

                                    <svg class="w-12 h-12 mx-auto text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7v8a2 2 0 002 2h4M8 7V3a2 2 0 012-2h4a2 2 0 012 2v4a2 2 0 01-2 2h-4A2 2 0 018 7z"></path></svg>

                                    <p class="mt-2 text-sm font-medium">The queue is empty.</p>

                                </div>

                            `;

                        }

                    } else {

                        const nextPatient = querySnapshot.docs[0].data();

                        if (upNextPatientCard) {

                            upNextPatientCard.innerHTML = `

                                <div class="animate-fade-in">

                                    <p class="text-xs font-semibold text-blue-600 uppercase">Next Patient</p>

                                    <p class="text-2xl font-bold text-gray-900 truncate">${nextPatient.name}</p>

                                    <p class="text-sm text-gray-600 mt-1">

                                        <span class="font-medium">Issue:</span> ${nextPatient.issue}

                                    </p>

                                    <p class="text-sm text-gray-500 mt-1">

                                        <span class="font-medium">Mobile:</span> ${nextPatient.mobile}

                                    </p>

                                </div>

                            `;

                        }

                    }

                }, (error) => console.error("Error getting waiting patients:", error));



                // --- Query 2: Patients SEEN ---

                const seenQuery = query(collection(db, `artifacts/${appId}/public/data/queue`),

                                  where("status", "==", "seen"),

                                  where("completedAt", ">=", Timestamp.fromDate(today)),

                                  where("completedAt", "<", Timestamp.fromDate(tomorrow))

                                 );



                const unsubSeen = onSnapshot(seenQuery, (querySnapshot) => {

                    if (seenCountEl) seenCountEl.textContent = querySnapshot.size;

                    

                    let totalRevenue = 0;

                    querySnapshot.forEach(doc => {

                        totalRevenue += parseFloat(doc.data().fee || 0);

                    });

                    if (revenueEl) revenueEl.textContent = `₹${totalRevenue.toFixed(0)}`;



                }, (error) => {

                    console.error("Error getting seen patients:", error);

                    if (error.code === 'failed-precondition') {

                        showModal("Database index missing for Dashboard. Please create the required index in Firebase (check console for link).");

                    }

                });



                // --- Query 3: Load upcoming appointments ---

                const unsubAppts = loadDashboardAppointments(today, tomorrow);



                // --- Query 4: Get Clinic Status (Limit & Passcode) ---

                // This listener is now in attachSettingsListener, which is called on the Settings page.

                // We'll call it here *once* for the dashboard values.

                const statusRef = doc(db, `artifacts/${appId}/public/data/clinicStatus/status`);

                const unsubStatus = onSnapshot(statusRef, (docSnap) => {

                    let currentPasscode = "ABCD"; // Default

                    if (docSnap.exists()) {

                        const data = docSnap.data();

                        if (data.dailyLimit !== undefined) {

                            if (dailyLimitInput) dailyLimitInput.value = data.dailyLimit;

                        } else {

                            if (dailyLimitInput) dailyLimitInput.value = 50; // Default

                        }

                        if (data.remotePasscode) {

                            currentPasscode = data.remotePasscode;

                            if (remotePasscodeInput) remotePasscodeInput.value = data.remotePasscode;

                            if (dailyPasscodeEl) dailyPasscodeEl.textContent = data.remotePasscode;

                        }

                    } else {

                         if (dailyLimitInput) dailyLimitInput.value = 50;

                    }

                    generateQRCode(currentPasscode); // Generate QR for the current code

                }, (error) => {

                     console.error("Error getting real-time clinic status:", error);

                      if (dailyLimitInput) dailyLimitInput.value = 50;

                      generateQRCode("ABCD"); // Generate default QR on error

                });





                dashboardUnsubscribe = () => {

                    unsubWaiting();

                    unsubSeen();

                    unsubAppts();

                    unsubStatus(); 

                };

            }



             // --- 9. Doctor: Call Patient Logic (UPDATED) ---

            function attachDoctorQueueListener() {

                if (!isAuthReady || !db || !isAdmin) return;

                

                if (doctorQueueUnsubscribe) doctorQueueUnsubscribe(); 



                const queueCollectionPath = `artifacts/${appId}/public/data/queue`;

                

                // --- Query for "waiting" and "pre_registered" patients ---

                const q = query(collection(db, queueCollectionPath),

                                where("status", "in", ["waiting", "pre_registered"]),

                                orderBy("joinedAt", "asc"));



                doctorQueueUnsubscribe = onSnapshot(q, (querySnapshot) => {

                    if (!isAuthReady || !isAdmin) return; 

                    if (!doctorQueueList || !preRegisteredList) return;

                    

                    doctorQueueList.innerHTML = ''; 

                    preRegisteredList.innerHTML = ''; 

                    

                    // Show empty messages by default

                    if (doctorMessageEl) doctorMessageEl.style.display = 'block';

                    if (preRegisteredMsg) preRegisteredMsg.style.display = 'block';



                    if (querySnapshot.empty) {

                        // Both lists are confirmed empty

                        return;

                    } 

                    

                    let waitingIndex = 0; 

                    

                    querySnapshot.forEach((doc) => { 

                        const data = doc.data();

                        const li = document.createElement('li');

                        

                        // --- Sort into "waiting" or "pre_registered" lists ---

                        if (data.status === 'waiting') {

                            if (doctorMessageEl) doctorMessageEl.style.display = 'none'; // Hide empty msg

                            const queueNumber = waitingIndex + 1; 

                            li.className = `p-4 rounded-lg shadow ${waitingIndex === 0 ? 'bg-emerald-100 border-emerald-400 border-2' : 'bg-white'}`;

                            li.innerHTML = `

                                <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center">

                                    <span class="text-2xl font-bold text-emerald-700">#${queueNumber}</span>

                                    <span class="text-lg font-semibold mt-1 sm:mt-0">${data.name || 'N/A'}</span>

                                    <span class="text-gray-600 mt-1 sm:mt-0">${data.mobile || 'N/A'}</span>

                                </div>

                                <p class="text-gray-700 mt-2"><b>Issue:</b> ${data.issue || 'N/A'}</p>

                                ${waitingIndex === 0 ?

                                    '<button class="call-next-btn mt-3 w-full bg-emerald-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-2">Add Notes & Call Next</button>'

                                    : ''}

                            `;



                            if (waitingIndex === 0) {

                                li.querySelector('.call-next-btn')?.addEventListener('click', () => {

                                    Tone.start(); 

                                    currentPatientForNotes = { id: doc.id, ...data };

                                    showNotesModal(data.patientId);

                                });

                            }

                            doctorQueueList.appendChild(li);

                            waitingIndex++; 



                        } else if (data.status === 'pre_registered') {

                            if (preRegisteredMsg) preRegisteredMsg.style.display = 'none'; // Hide empty msg

                            li.className = 'p-4 rounded-lg shadow bg-purple-100 border border-purple-300';

                            li.innerHTML = `

                                <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center">

                                    <div>

                                        <span class="text-lg font-semibold">${data.name || 'N/A'}</span>

                                        <span class="text-purple-700 text-sm font-medium ml-2">(En Route)</span>

                                    </div>

                                    <span class="text-gray-600 mt-1 sm:mt-0">${data.mobile || 'N/A'}</span>

                                </div>

                                <p class="text-gray-700 mt-2"><b>Issue:</b> ${data.issue || 'N/A'}</p>

                                <button class="check-in-btn mt-3 w-full bg-purple-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2">Mark as Arrived</button>

                            `;

                            

                            li.querySelector('.check-in-btn')?.addEventListener('click', () => checkInPatient(doc.id));

                            preRegisteredList.appendChild(li);

                        }

                    });

                }, (error) => {

                    console.error("[Doctor] Error with doctor queue snapshot:", error);

                    if (error.code === 'failed-precondition') {

                        showModal("Database index missing. Please check the Developer Console (F12) for a link to create the required index in Firebase, then refresh.");

                    } else if (error.code === 'permission-denied') {

                        showModal("Permission denied. Ensure Firestore rules allow reading the queue. Please check rules and refresh.");

                    } else {

                        showModal("Error connecting to the patient queue. Please refresh the page.");

                    }

                    if (doctorMessageEl) doctorMessageEl.style.display = 'block';

                    if (preRegisteredMsg) preRegisteredMsg.style.display = 'block';

                    if (doctorQueueList) doctorQueueList.innerHTML = '';

                    if (preRegisteredList) preRegisteredList.innerHTML = '';

                });

            }



            // --- NEW: Check-in patient function ---

            async function checkInPatient(patientDocId) {

                if (!db || !patientDocId) return;

                try {

                    const patientDocRef = doc(db, `artifacts/${appId}/public/data/queue`, patientDocId);

                    await updateDoc(patientDocRef, { 

                        status: 'waiting',

                        joinedAt: serverTimestamp() // This moves them to the end of the 'waiting' queue

                    });

                    showModal("Patient checked in successfully.");

                } catch (err) {

                    console.error("Error checking in patient:", err);

                    showModal("Could not check in patient.");

                }

            }





            // --- 10. Doctor: Notes Modal Logic ---

            async function loadPatientHistoryForModal(patientId) {

                if (!patientId || !db) return;

                

                if (previousHistoryList) previousHistoryList.innerHTML = '';

                if (previousHistoryMsg) previousHistoryMsg.style.display = 'block'; 

                if (previousHistoryMsg) previousHistoryMsg.textContent = 'Loading history...';



                const historyCollectionPath = `artifacts/${appId}/users/${patientId}/visits`;

                const q = query(collection(db, historyCollectionPath), orderBy("visitedAt", "desc"));

                

                try {

                    const querySnapshot = await getDocs(q);

                    if (querySnapshot.empty) {

                        if (previousHistoryMsg) previousHistoryMsg.textContent = 'No previous visit history found for this patient.';

                    } else {

                        if (previousHistoryMsg) previousHistoryMsg.style.display = 'none';

                        querySnapshot.forEach(doc => {

                            const visit = doc.data();

                            const visitDate = visit.visitedAt?.toDate().toLocaleDateString('en-US', { dateStyle: 'medium' }) || 'Unknown Date';

                            const li = document.createElement('li');

                            li.className = 'border-b border-gray-200 pb-3 mb-3 last:border-b-0';

                            li.innerHTML = `

                                <div class="flex justify-between items-center mb-1">

                                    <p class="text-sm font-semibold text-blue-600">${visitDate}</p>

                                    ${visit.fee ? `<p class="text-sm font-bold text-emerald-600">₹${parseFloat(visit.fee).toFixed(2)}</p>` : ''}

                                </div>

                                <p class="text-sm text-gray-700 whitespace-pre-wrap">${visit.notes || 'No notes.'}</p>

                                ${visit.nextVisitDate ? `<p class="text-sm font-medium text-purple-600 mt-2">Next Visit Suggested: ${visit.nextVisitDate.toDate().toLocaleDateString('en-US', { dateStyle: 'medium' })}</p>` : ''}

                            `;

                            if (previousHistoryList) previousHistoryList.appendChild(li);

                        });

                    }

                } catch (error) {

                    console.error("Error loading patient history:", error);

                    if (previousHistoryMsg) previousHistoryMsg.textContent = 'Error loading history.';

                }

            }



            function showNotesModal(patientId) {

                if (notesText) notesText.value = '';

                if (notesFeeInput) notesFeeInput.value = ''; 

                if (nextVisitDateInput) nextVisitDateInput.value = ''; 

                if (nextVisitDateInput) nextVisitDateInput.min = new Date().toISOString().split('T')[0];

                

                loadPatientHistoryForModal(patientId);



                if (notesModal) notesModal.style.display = 'flex';

                if (notesText) notesText.focus();

            }



            function closeNotesModal() {

                if (notesModal) notesModal.style.display = 'none';

                currentPatientForNotes = null;

                if (notesFeeInput) notesFeeInput.value = '';

                if (notesText) notesText.value = '';

                if (nextVisitDateInput) nextVisitDateInput.value = '';

                if (previousHistoryList) previousHistoryList.innerHTML = '';

                if (previousHistoryMsg) previousHistoryMsg.style.display = 'none';

            }



            async function handleNotesSubmit(e) {

                e.preventDefault();

                if (!currentPatientForNotes || !notesText || !notesFeeInput) return; 



                const notes = notesText.value.trim();

                const fee = notesFeeInput.value; 

                const nextVisit = nextVisitDateInput.value; 



                if (!notes || !fee) {

                    showModal("Please add notes and enter the consultation fee.");

                    return;

                }

                

                const feeAmount = parseFloat(fee);

                if (isNaN(feeAmount) || feeAmount < 0) {

                     showModal("Please enter a valid, non-negative fee.");

                     return;

                }



                if (notesSubmitBtn) {

                    notesSubmitBtn.disabled = true;

                    notesSubmitBtn.textContent = 'Saving...';

                }



                try {

                    const visitData = {

                        name: currentPatientForNotes.name,

                        mobile: currentPatientForNotes.mobile,

                        issue: currentPatientForNotes.issue,

                        notes: notes,

                        fee: feeAmount, 

                        visitedAt: serverTimestamp(),

                        clinicId: "main-8c336" 

                    };



                    if (nextVisit) {

                        const nextVisitDate = new Date(nextVisit);

                        nextVisitDate.setHours(12, 0, 0, 0); 

                        visitData.nextVisitDate = Timestamp.fromDate(nextVisitDate);

                    }

                    

                    const visitCollectionPath = `artifacts/${appId}/users/${currentPatientForNotes.patientId}/visits`;

                    await addDoc(collection(db, visitCollectionPath), visitData); 



                    const queueDocRef = doc(db, `artifacts/${appId}/public/data/queue`, currentPatientForNotes.id);

                    await updateDoc(queueDocRef, {

                        status: 'seen',

                        fee: feeAmount, 

                        completedAt: serverTimestamp(), 

                        notes: notes 

                    });



                    closeNotesModal();



                } catch (error) {

                    console.error("Error saving notes or updating queue:", error);

                    showModal("Could not save notes. Please try again.");

                } finally {

                    if (notesSubmitBtn) {

                        notesSubmitBtn.disabled = false;

                        notesSubmitBtn.textContent = 'Complete & Dismiss';

                    }

                }

            }



            // --- 11. Doctor: Export Logic ---

            async function exportToCSV() {

                if(!exportDateInput){

                     showModal("Date input not found.");

                     return;

                }

                if (exportBtn) {

                    exportBtn.disabled = true;

                    exportBtn.textContent = 'Generating...';

                }



                try {

                    const selectedDate = new Date(exportDateInput.value);

                     if (isNaN(selectedDate.getTime())) {

                         showModal("Please select a valid date for export.");

                          if (exportBtn) {

                             exportBtn.disabled = false;

                             exportBtn.textContent = 'Export Patients to CSV';

                         }

                         return;

                     }



                    const startOfDay = new Date(selectedDate);

                    startOfDay.setHours(0, 0, 0, 0);

                    const endOfDay = new Date(selectedDate);

                    endOfDay.setHours(23, 59, 59, 999);



                    const q = query(collection(db, `artifacts/${appId}/public/data/queue`),

                                    where("joinedAt", ">=", Timestamp.fromDate(startOfDay)),

                                    where("joinedAt", "<=", Timestamp.fromDate(endOfDay))

                                   );

                    const querySnapshot = await getDocs(q);



                    if (querySnapshot.empty) {

                        showModal("No patient data found for the selected date.");

                        if (exportBtn) {

                            exportBtn.disabled = false;

                            exportBtn.textContent = 'Export Patients to CSV';

                        }

                        return;

                    }



                    let csvContent = "data:text/csv;charset=utf-8,";

                    csvContent += "Patient Name,Mobile,Issue,Status,Fee (INR),Joined At\r\n";

                    querySnapshot.forEach(doc => {

                        const data = doc.data();

                        const joinedAt = data.joinedAt?.toDate().toLocaleString() || "N/A";

                        const name = data.name ? data.name.replace(/"/g, '""') : "";

                        const mobile = data.mobile ? data.mobile.replace(/"/g, '""') : "";

                        const issue = data.issue ? data.issue.replace(/"/g, '""') : "";

                        const status = data.status ? data.status.replace(/"/g, '""') : "";

                        const fee = data.fee ? parseFloat(data.fee).toFixed(2) : "0.00"; 

                        csvContent += `"${name}","${mobile}","${issue}","${status}","${fee}","${joinedAt}"\r\n`;

                    });



                    const encodedUri = encodeURI(csvContent);

                    const link = document.createElement("a");

                    link.setAttribute("href", encodedUri);

                    link.setAttribute("download", `medique_export_${exportDateInput.value}.csv`);

                    document.body.appendChild(link);

                    link.click();

                    document.body.removeChild(link);



                } catch (error) {

                    console.error("Error exporting CSV:", error);

                    showModal("Error generating CSV: " + error.message);

                } finally {

                    if (exportBtn) {

                        exportBtn.disabled = false;

                        exportBtn.textContent = 'Export Patients to CSV';

                    }

                }

            }



            // --- 12. Doctor: Appointments Logic ---

            async function loadDoctorAppointments() {

                if (!isAuthReady || !db || !docAptDateInput) return;

                 if(!docAptDateInput.value){

                     if (docAptMsg) docAptMsg.textContent = 'Please select a date.';

                     if (docAptMsg) docAptMsg.style.display = 'block';

                     if (docAptList) docAptList.innerHTML = '';

                     return;

                 }



                const selectedDate = new Date(docAptDateInput.value);

                const startOfDay = new Date(selectedDate);

                startOfDay.setHours(0, 0, 0, 0);

                const endOfDay = new Date(selectedDate);

                endOfDay.setHours(23, 59, 59, 999);



                if (docAptList) docAptList.innerHTML = '';

                if (docAptMsg) docAptMsg.textContent = 'Loading...';

                if (docAptMsg) docAptMsg.style.display = 'block';



                try {

                    const q = query(collectionGroup(db, "appointments"),

                                    where("appointmentAt", ">=", Timestamp.fromDate(startOfDay)),

                                    where("appointmentAt", "<=", Timestamp.fromDate(endOfDay)), 

                                    orderBy("appointmentAt", "asc")

                                   );



                    const querySnapshot = await getDocs(q);



                    if (querySnapshot.empty) {

                        if (docAptMsg) docAptMsg.textContent = 'No appointments found for this date.';

                    } else {

                        if (docAptMsg) docAptMsg.style.display = 'none';

                        querySnapshot.forEach(doc => {

                            const apt = doc.data();

                            const aptTime = apt.appointmentAt?.toDate().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) || 'Unknown Time';

                            const li = document.createElement('li');

                            

                            let statusHTML = '';

                            let buttonHTML = '';

                            

                            if (apt.status === 'pending') {

                                li.className = 'bg-white shadow-md rounded-lg p-4 mb-4 border-l-4 border-yellow-500';

                                statusHTML = `<span class="text-sm font-medium text-yellow-600 bg-yellow-100 px-2 py-0.5 rounded-full">Pending</span>`;

                                buttonHTML = `

                                    <div class="flex gap-2 mt-3">

                                        <button class="approve-apt-btn text-sm font-medium text-white bg-green-500 hover:bg-green-600 px-3 py-1.5 rounded-md" data-path="${doc.ref.path}">Approve</button>

                                        <button class="decline-apt-btn text-sm font-medium text-white bg-red-500 hover:bg-red-600 px-3 py-1.5 rounded-md" data-path="${doc.ref.path}" data-patient-name="${apt.patientName || 'this patient'}">Decline</button>

                                    </div>

                                `;

                            } else if (apt.status === 'confirmed') {

                                li.className = 'bg-white shadow-md rounded-lg p-4 mb-4 border-l-4 border-green-500';

                                statusHTML = `<span class="text-sm font-medium text-green-600 bg-green-100 px-2 py-0.5 rounded-full">Confirmed</span>`;

                            } else if (apt.status === 'declined') {

                                li.className = 'bg-white shadow-md rounded-lg p-4 mb-4 border-l-4 border-red-500 opacity-70';

                                statusHTML = `<span class="text-sm font-medium text-red-600 bg-red-100 px-2 py-0.5 rounded-full">Declined</span>`;

                            }



                            li.innerHTML = `

                                <div class="flex justify-between items-center">

                                    <span class="text-xl font-bold text-blue-600">${aptTime}</span>

                                    <span class="text-lg font-semibold">${apt.patientName || 'Unknown Patient'}</span>

                                </div>

                                <p class="text-gray-600 mt-2"><span class="font-medium">Reason:</span> ${apt.reason || 'N/A'}</p>

                                <div class="flex justify-between items-center mt-3">

                                    ${statusHTML}

                                </div>

                                ${buttonHTML}

                            `;

                            if (docAptList) docAptList.appendChild(li);

                        });

                    }

                } catch (error) {

                    console.error("Error loading doctor appointments:", error);

                      if (error.code === 'failed-precondition' && error.message.includes('index')) {

                          showModal("Database index missing for appointments. Check the Developer Console (F12) for a link to create the required index in Firebase, then refresh.");

                      } else {

                          if (docAptMsg) docAptMsg.textContent = 'Error loading appointments. Check rules/index.';

                      }

                    if (docAptMsg) docAptMsg.style.display = 'block'; 

                }

            }



            async function handleAppointmentAction(e) {

                const target = e.target;

                const aptPath = target.dataset.path;

                if (!aptPath) return;



                if (target.classList.contains('approve-apt-btn')) {

                    await approveAppointment(aptPath);

                } else if (target.classList.contains('decline-apt-btn')) {

                    const patientName = target.dataset.patientName;

                    await declineAppointment(aptPath, patientName);

                }

            }



            async function approveAppointment(aptPath) {

                if (!db || !isAdmin) return;

                const aptRef = doc(db, aptPath);

                try {

                    await updateDoc(aptRef, { status: "confirmed" });

                    loadDoctorAppointments(); // Refresh the list

                } catch (error) {

                    console.error("Error approving appointment:", error);

                    showModal("Could not approve appointment. Check permissions.");

                }

            }



            async function declineAppointment(aptPath, patientName) {

                if (!db || !isAdmin) return;

                

                const reason = prompt(`Please provide a reason for declining the appointment for ${patientName}:`, "Time slot is no longer available.");

                

                if (reason) { 

                    const aptRef = doc(db, aptPath);

                    try {

                        await updateDoc(aptRef, { 

                            status: "declined",

                            declineReason: reason 

                        });

                        loadDoctorAppointments(); // Refresh the list

                    } catch (error) {

                        console.error("Error declining appointment:", error);

                        showModal("Could not decline appointment. Check permissions.");

                    }

                }

            }





            function loadDashboardAppointments(startOfDay, endOfDay) {

                if (!isAuthReady || !db) return () => {};

                

                const q = query(collectionGroup(db, "appointments"),

                                where("appointmentAt", ">=", Timestamp.fromDate(startOfDay)),

                                where("appointmentAt", "<=", Timestamp.fromDate(endOfDay)),

                                where("status", "in", ["pending", "confirmed"]), 

                                orderBy("appointmentAt", "asc")

                               );



                const unsubscribe = onSnapshot(q, (querySnapshot) => {

                    if (aptList) aptList.innerHTML = '';

                    if (querySnapshot.empty) {

                        if (aptMsg) aptMsg.style.display = 'block';

                    } else {

                        if (aptMsg) aptMsg.style.display = 'none';

                        querySnapshot.forEach(doc => {

                            const apt = doc.data();

                            const aptTime = apt.appointmentAt?.toDate().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) || 'Unknown Time';

                            const li = document.createElement('li');

                            

                            let statusStyle = 'bg-white border-gray-200';

                            let statusText = aptTime;

                            if (apt.status === 'pending') {

                                statusStyle = 'bg-yellow-100 border-yellow-300';

                                statusText = 'Pending';

                            }

                            

                            li.className = 'flex items-center gap-3 p-3 bg-gray-50/80 rounded-xl border border-gray-200 animate-fade-in';

                            li.innerHTML = `

                                <div class="flex-shrink-0 w-11 h-11 rounded-lg bg-gradient-to-br from-blue-100 to-indigo-200 flex items-center justify-center">

                                    <span class="font-bold text-lg text-blue-700">${aptTime.split(' ')[0].split(':')[0]}</span>

                                </div>

                                <div>

                                    <p class="font-semibold text-gray-800">${apt.patientName || 'Unknown Patient'}</p>

                                    <p class="text-sm text-gray-600">${apt.reason || 'N/A'}</p>

                                </div>

                                <span class="ml-auto text-sm font-medium text-gray-700 ${statusStyle} px-2 py-1 rounded-md shadow-sm border">${statusText}</span>

                            `;

                            if (aptList) aptList.appendChild(li);

                        });

                    }

                }, (error) => {

                    console.error("Error loading dashboard appointments:", error);

                    if (aptMsg) {

                        aptMsg.textContent = 'Error loading appointments.';

                        aptMsg.style.display = 'block';

                    }

                    if (error.code === 'failed-precondition') {

                        showModal("Database index missing for Appointments. Please create the required index in Firebase (check console for link).");

                    }

                });

                

                return unsubscribe; 

            }

            

            // --- 13. NEW: Expenses Logic ---

            function loadExpenseDefaults() {

                if (expenseDate) expenseDate.valueAsDate = new Date();

                if (expenseForm) expenseForm.reset();

                if (expenseDate) expenseDate.valueAsDate = new Date(); // Re-set date after reset

            }



            async function handleSaveExpense(e) {

                e.preventDefault();

                if (!db || !isAdmin) return;



                const date = expenseDate.value;

                const category = expenseCategory.value;

                const amount = parseFloat(expenseAmount.value);

                const description = expenseDescription.value.trim();



                if (!date || !category || !amount) {

                    showModal("Please fill in the date, category, and amount.");

                    return;

                }

                if (isNaN(amount) || amount <= 0) {

                    showModal("Please enter a valid, positive amount.");

                    return;

                }



                if (saveExpenseBtn) {

                    saveExpenseBtn.disabled = true;

                    saveExpenseBtn.textContent = 'Saving...';

                }



                try {

                    const expenseDateObj = new Date(date);

                    expenseDateObj.setHours(12, 0, 0, 0); // Normalize date



                    const expenseData = {

                        date: Timestamp.fromDate(expenseDateObj),

                        category: category,

                        amount: amount,

                        description: description,

                        enteredAt: serverTimestamp()

                    };



                    const expenseCollectionPath = `artifacts/${appId}/public/data/expenses`;

                    await addDoc(collection(db, expenseCollectionPath), expenseData);



                    if (expenseStatusMsg) {

                        expenseStatusMsg.textContent = "Expense saved successfully!";

                        expenseStatusMsg.className = "text-sm text-green-600 mt-2";

                        expenseStatusMsg.style.display = 'block';

                    }

                    if (expenseForm) expenseForm.reset();

                    if (expenseDate) expenseDate.valueAsDate = new Date(); // Reset date

                    setTimeout(() => { if (expenseStatusMsg) expenseStatusMsg.style.display = 'none'; }, 3000);



                } catch (error) {

                    console.error("Error saving expense:", error);

                    if (expenseStatusMsg) {

                        expenseStatusMsg.textContent = "Error saving expense. Check permissions.";

                        expenseStatusMsg.className = "text-sm text-red-600 mt-2";

                        expenseStatusMsg.style.display = 'block';

                    }

                } finally {

                    if (saveExpenseBtn) {

                        saveExpenseBtn.disabled = false;

                        saveExpenseBtn.textContent = 'Save Expense';

                    }

                }

            }



            function attachExpensesListener() {

                if (!db || !isAdmin) return;

                

                if (expensesUnsubscribe) expensesUnsubscribe();



                const expenseCollectionPath = `artifacts/${appId}/public/data/expenses`;

                const q = query(expenseCollectionPath, orderBy("date", "desc"), limit(20));



                expensesUnsubscribe = onSnapshot(q, (querySnapshot) => {

                    if (expenseList) expenseList.innerHTML = '';

                    if (querySnapshot.empty) {

                        if (expenseListMsg) expenseListMsg.style.display = 'block';

                    } else {

                        if (expenseListMsg) expenseListMsg.style.display = 'none';

                        querySnapshot.forEach(doc => {

                            const data = doc.data();

                            const dateStr = data.date.toDate().toLocaleDateString('en-US', { dateStyle: 'medium' });

                            

                            const li = document.createElement('li');

                            li.className = 'bg-white p-4 rounded-lg shadow-sm border border-gray-200 animate-fade-in';

                            li.innerHTML = `

                                <div class="flex justify-between items-start">

                                    <div>

                                        <p class="text-xs font-medium text-indigo-600 bg-indigo-100 px-2 py-0.5 rounded-full inline-block">${data.category}</p>

                                        <p class="text-sm text-gray-600 mt-2">${data.description || 'No description'}</p>

                                    </div>

                                    <div class="text-right flex-shrink-0 ml-4">

                                        <p class="text-xl font-bold text-red-600">-₹${data.amount.toFixed(2)}</p>

                                        <p class="text-xs text-gray-500">${dateStr}</p>

                                    </div>

                                </div>

                            `;

                            if (expenseList) expenseList.appendChild(li);

                        });

                    }

                }, (error) => {

                    console.error("Error loading expenses:", error);

                    if (expenseListMsg) {

                        expenseListMsg.textContent = 'Error loading expenses. Check Firestore Rules.';

                        expenseListMsg.style.display = 'block';

                    }

                });

            }





            // --- 14. Global Utilities ---

            function showModal(message) {

                if (modalMessage) modalMessage.textContent = message;

                if (modal) modal.style.display = 'flex';

            }



            function closeModal() {

                if (modal) modal.style.display = 'none';

            }



            // --- Get All DOM Elements ---

            doctorApp = document.getElementById('doctor-app');



            doctorPages['dashboard'] = document.getElementById('doctor-page-dashboard');

            doctorPages['call'] = document.getElementById('doctor-page-call');

            doctorPages['appointments'] = document.getElementById('doctor-page-appointments');

            doctorPages['finance'] = document.getElementById('doctor-page-finance'); // <-- UPDATED

            doctorPages['settings'] = document.getElementById('doctor-page-settings');

            doctorPages['export'] = document.getElementById('doctor-page-export');



            // Navbar

            mainNav = document.getElementById('main-nav');

            patientNav = document.getElementById('patient-nav'); 

            doctorNav = document.getElementById('doctor-nav'); 

            authControls = document.getElementById('auth-controls');

            userDisplay = document.getElementById('user-display');

            logoutBtn = document.getElementById('logout-btn');

            

            // FIX: Get all nav buttons

            doctorNavDashboard = document.getElementById('doctor-nav-dashboard');

            doctorNavCall = document.getElementById('doctor-nav-call');

            doctorNavAppointments = document.getElementById('doctor-nav-appointments');

            doctorNavFinance = document.getElementById('doctor-nav-finance'); // <-- UPDATED

            doctorNavExpenses = document.getElementById('doctor-nav-expenses'); // This one is gone from main nav

            doctorNavSettings = document.getElementById('doctor-nav-settings');

            doctorNavExport = document.getElementById('doctor-nav-export');



            // Mobile Nav

            mobileMenu = document.getElementById('mobile-menu');

            mobileMenuBtn = document.getElementById('mobile-menu-btn');

            mobileAuthControls = document.getElementById('mobile-auth-controls');

            mobileUserDisplay = document.getElementById('mobile-user-display');

            mobileLogoutBtn = document.getElementById('mobile-logout-btn');

            mobilePatientNav = document.getElementById('mobile-patient-nav'); 

            mobileDoctorNav = document.getElementById('mobile-doctor-nav'); 

            // FIX: Get all mobile nav buttons

            mobileNavDashboard = document.getElementById('mobile-nav-dashboard');

            mobileNavCall = document.getElementById('mobile-nav-call');

            mobileNavAppointments = document.getElementById('mobile-nav-appointments');

            mobileNavFinance = document.getElementById('mobile-nav-finance');

            mobileNavSettings = document.getElementById('mobile-nav-settings');

            mobileNavExport = document.getElementById('mobile-nav-export');

            mobileNavExpenses = document.getElementById('mobile-nav-expenses'); // This one is gone from main nav



            // Doctor: Dashboard

            welcomeMsg = document.getElementById('welcome-msg');

            liveDate = document.getElementById('live-date');

            liveTime = document.getElementById('live-time');

            waitingCountEl = document.getElementById('dashboard-waiting-count');

            seenCountEl = document.getElementById('dashboard-seen-count');

            revenueEl = document.getElementById('dashboard-total-revenue');

            upNextPatientCard = document.getElementById('dashboard-up-next-patient');

            callPatientBtn = document.getElementById('dashboard-call-patient-btn');

            aptList = document.getElementById('dashboard-appointments-list');

            aptMsg = document.getElementById('dashboard-appointments-msg');

            

            // Doctor: Settings

            settingsLatInput = document.getElementById('settings-lat-input');

            settingsLonInput = document.getElementById('settings-lon-input');

            settingsMaxDistanceInput = document.getElementById('settings-max-distance-input');

            settingsSaveBtn = document.getElementById('settings-save-btn');

            settingsStatusMsg = document.getElementById('settings-status-msg');

            settingsGetLocationBtn = document.getElementById('settings-get-location-btn'); 

            installPwaBtn = document.getElementById('install-pwa-btn'); // <-- PWA

            dailyLimitInput = document.getElementById('daily-limit-input');

            saveLimitBtn = document.getElementById('save-limit-btn');

            limitSaveStatus = document.getElementById('limit-save-status');

            qrCodeCanvas = document.getElementById('qr-code-canvas'); 

            dailyPasscodeEl = document.getElementById('daily-passcode'); 

            remotePasscodeInput = document.getElementById('remote-passcode-input'); 

            savePasscodeBtn = document.getElementById('save-passcode-btn'); 

            passcodeSaveStatus = document.getElementById('passcode-save-status'); 



            // --- NEW: Finance Page Elements ---

            financeRevenueTabBtn = document.getElementById('finance-revenue-tab-btn');

            financeExpensesTabBtn = document.getElementById('finance-expenses-tab-btn');

            financeRevenuePage = document.getElementById('finance-revenue-page');

            financeExpensesPage = document.getElementById('finance-expenses-page');



            // Finance (Revenue)

            financialsTodayBtn = document.getElementById('financials-today-btn');

            financialsWeekBtn = document.getElementById('financials-week-btn');

            financialsMonthBtn = document.getElementById('financials-month-btn');

            financialsCustomBtn = document.getElementById('financials-custom-btn');

            financialsStartDateInput = document.getElementById('financials-start-date');

            financialsEndDateInput = document.getElementById('financials-end-date');

            financialsTotalRevenueEl = document.getElementById('financials-total-revenue');

            financialsAvgRevenueEl = document.getElementById('financials-avg-revenue');

            financialsTransactionCountEl = document.getElementById('financials-transaction-count');

            financialsTransactionsList = document.getElementById('financials-transactions-list');

            financialsExportBtn = document.getElementById('financials-export-btn');



            // Finance (Expenses)

            expenseForm = document.getElementById('expense-form');

            expenseDate = document.getElementById('expense-date');

            expenseCategory = document.getElementById('expense-category');

            expenseAmount = document.getElementById('expense-amount');

            expenseDescription = document.getElementById('expense-description');

            saveExpenseBtn = document.getElementById('save-expense-btn');

            expenseStatusMsg = document.getElementById('expense-status-msg');

            expenseList = document.getElementById('expense-list');

            expenseListMsg = document.getElementById('expense-list-msg');



            // Doctor: Call

            doctorQueueList = document.getElementById('doctor-queue-list');

            doctorMessageEl = document.getElementById('doctor-message');

            preRegisteredList = document.getElementById('pre-registered-list'); // <-- NEW

            preRegisteredMsg = document.getElementById('pre-registered-msg'); // <-- NEW



            // Doctor: Notes Modal

            notesModal = document.getElementById('notes-modal');

            notesForm = document.getElementById('notes-form');

            notesText = document.getElementById('notes-text');

            notesFeeInput = document.getElementById('consultation-fee');

            nextVisitDateInput = document.getElementById('next-visit-date'); 

            notesSubmitBtn = document.getElementById('notes-submit-btn');

            notesCancelBtn = document.getElementById('notes-cancel-btn');

            previousHistoryList = document.getElementById('previous-history-list'); 

            previousHistoryMsg = document.getElementById('previous-history-msg'); 



            // Doctor: Export

            exportPage = document.getElementById('doctor-page-export'); // <-- Get page

            exportBtn = document.getElementById('export-btn');

            exportDateInput = document.getElementById('export-date');



            // Doctor: Appointments

            docAptDateInput = document.getElementById('doc-apt-date');

            docAptList = document.getElementById('doc-apt-list');

            docAptMsg = document.getElementById('doc-apt-msg');



            // Global

            loadingOverlay = document.getElementById('loading-overlay');

            modal = document.getElementById('modal');

            modalMessage = document.getElementById('modal-message');

            modalCloseBtn = document.getElementById('modal-close-btn');



            // --- Add Event Listeners ---

            if (logoutBtn) logoutBtn.addEventListener('click', handleLogout);

            if (mobileLogoutBtn) mobileLogoutBtn.addEventListener('click', handleLogout);



            if (saveLimitBtn) saveLimitBtn.addEventListener('click', handleSaveLimit);

            if (savePasscodeBtn) savePasscodeBtn.addEventListener('click', handleSavePasscode); // <-- NEW



            if (callPatientBtn) callPatientBtn.addEventListener('click', () => showDoctorView('call'));



            if (notesForm) notesForm.addEventListener('submit', handleNotesSubmit);

            if (notesCancelBtn) notesCancelBtn.addEventListener('click', closeNotesModal);



            if (exportBtn) exportBtn.addEventListener('click', exportToCSV);



            if (docAptDateInput) docAptDateInput.addEventListener('change', loadDoctorAppointments);

            if (docAptList) docAptList.addEventListener('click', handleAppointmentAction); 

            

            if (settingsSaveBtn) settingsSaveBtn.addEventListener('click', saveClinicSettings);

            if (settingsGetLocationBtn) settingsGetLocationBtn.addEventListener('click', handleGetDoctorLocation); 

            

            // --- NEW: Finance Tab Listeners ---

            if (financeRevenueTabBtn) financeRevenueTabBtn.addEventListener('click', () => showFinanceTab('revenue'));

            if (financeExpensesTabBtn) financeExpensesTabBtn.addEventListener('click', () => showFinanceTab('expenses'));

            if (expenseForm) expenseForm.addEventListener('submit', handleSaveExpense);



            // --- PWA Install Prompt Logic ---

            window.addEventListener('beforeinstallprompt', (e) => {

                e.preventDefault();

                deferredInstallPrompt = e;

                if (installPwaBtn) {

                    installPwaBtn.classList.remove('hidden');

                }

            });



            if (installPwaBtn) {

                installPwaBtn.addEventListener('click', async () => {

                    if (!deferredInstallPrompt) return;

                    deferredInstallPrompt.prompt();

                    const { outcome } = await deferredInstallPrompt.userChoice;

                    deferredInstallPrompt = null;

                    installPwaBtn.classList.add('hidden');

                });

            }



            window.addEventListener('appinstalled', () => {

                deferredInstallPrompt = null;

                if (installPwaBtn) {

                    installPwaBtn.classList.add('hidden');

                }

            });

            // --- End PWA Logic ---



            function setupFinancialsButtons() {

                if (financialsTodayBtn) {

                    financialsTodayBtn.addEventListener('click', (e) => {

                        e.preventDefault();

                        const customRange = document.getElementById('financials-custom-range');

                        if (customRange) customRange.style.display = 'none';

                        updateFinancialsButtonStyle('today');

                        loadFinancials('today');

                    });

                }

                if (financialsWeekBtn) {

                    financialsWeekBtn.addEventListener('click', (e) => {

                        e.preventDefault();

                        const customRange = document.getElementById('financials-custom-range');

                        if (customRange) customRange.style.display = 'none';

                        updateFinancialsButtonStyle('week');

                        loadFinancials('week');

                    });

                }

                if (financialsMonthBtn) {

                    financialsMonthBtn.addEventListener('click', (e) => {

                        e.preventDefault();

                        const customRange = document.getElementById('financials-custom-range');

                        if (customRange) customRange.style.display = 'none';

                        updateFinancialsButtonStyle('month');

                        loadFinancials('month');

                    });

                }

                if (financialsCustomBtn) {

                    financialsCustomBtn.addEventListener('click', (e) => {

                        e.preventDefault();

                        const customRange = document.getElementById('financials-custom-range');

                        const isVisible = customRange && customRange.style.display !== 'none' && customRange.style.display !== '';

                        if (customRange) customRange.style.display = isVisible ? 'none' : 'flex';

                        if (!isVisible) {

                            updateFinancialsButtonStyle('custom');

                            if (financialsStartDateInput && financialsEndDateInput && financialsStartDateInput.value && financialsEndDateInput.value) {

                                loadFinancials('custom');

                            }

                        }

                    });

                }

                if (financialsStartDateInput) {

                    financialsStartDateInput.addEventListener('change', () => {

                        if (financialsStartDateInput.value && financialsEndDateInput && financialsEndDateInput.value) {

                            updateFinancialsButtonStyle('custom');

                            loadFinancials('custom');

                        }

                    });

                }

                if (financialsEndDateInput) {

                    financialsEndDateInput.addEventListener('change', () => {

                        if (financialsStartDateInput && financialsStartDateInput.value && financialsEndDateInput.value) {

                            updateFinancialsButtonStyle('custom');

                            loadFinancials('custom');

                        }

                    });

                }

                if (financialsExportBtn) financialsExportBtn.addEventListener('click', exportFinancialsCSV);

            }

            

            setupFinancialsButtons(); 



            if (modalCloseBtn) modalCloseBtn.addEventListener('click', closeModal);

            

            // --- NEW: Mobile Nav Button Listeners ---

            if (mobileNavDashboard) mobileNavDashboard.addEventListener('click', () => showDoctorView('dashboard'));

            if (mobileNavCall) mobileNavCall.addEventListener('click', () => showDoctorView('call'));

            if (mobileNavAppointments) mobileNavAppointments.addEventListener('click', () => showDoctorView('appointments'));

            if (mobileNavFinance) mobileNavFinance.addEventListener('click', () => showDoctorView('finance'));

            if (mobileNavSettings) mobileNavSettings.addEventListener('click', () => showDoctorView('settings'));

            // Note: Export is not in the mobile nav



            // --- NEW: Desktop Nav Button Listeners (re-organized) ---

            if (doctorNavDashboard) doctorNavDashboard.addEventListener('click', () => showDoctorView('dashboard'));

            if (doctorNavCall) doctorNavCall.addEventListener('click', () => showDoctorView('call'));

            if (doctorNavAppointments) doctorNavAppointments.addEventListener('click', () => showDoctorView('appointments'));

            if (doctorNavFinance) doctorNavFinance.addEventListener('click', () => showDoctorView('finance')); 

            if (doctorNavSettings) doctorNavSettings.addEventListener('click', () => showDoctorView('settings')); 

            if (doctorNavExport) doctorNavExport.addEventListener('click', () => showDoctorView('export')); 



            // --- Auth State Change Listener (Auth Guard) ---

            onAuthStateChanged(auth, async (user) => {

                isAuthReady = true;

                if (user) {

                    // --- Back to "OG" Admin Check ---

                    if (user.email === ADMIN_EMAIL) {

                        isAdmin = true;

                        currentUserId = user.uid;

                        currentUserEmail = user.email;

                        currentUserDisplayName = user.displayName;



                        if (userDisplay) userDisplay.textContent = user.displayName || user.email;

                        if (mobileUserDisplay) mobileUserDisplay.textContent = user.displayName || user.email;

                        

                        if (mainNav) mainNav.classList.remove('hidden'); 

                        

                        if (patientNav) patientNav.style.display = 'none';

                        if (doctorNav) doctorNav.classList.remove('hidden'); 

                        if (authControls) authControls.classList.remove('hidden'); 

                        

                        if (mobilePatientNav) mobilePatientNav.style.display = 'none';

                        if (mobileDoctorNav) mobileDoctorNav.style.display = 'flex'; // Use flex for mobile nav

                        if (mobileAuthControls) mobileAuthControls.style.display = 'flex';



                        showDoctorView('dashboard'); 



                    } else {

                        // This is a patient

                        isAdmin = false;

                        window.location.href = '/patient.html'; // FIX: Absolute path

                        return; 

                    }

                } else {

                    currentUserId = null;

                    currentUserEmail = null;

                    currentUserDisplayName = null;

                    isAdmin = false;

                    window.location.href = '/index.html'; // FIX: Absolute path

                }

            });



        }; // <-- End of window.onload

    </script>

</head>

<body class="bg-gray-100 font-sans">



    <!-- *** TOP NAVBAR *** -->

    <nav class="bg-white shadow-md sticky top-0 z-50">

        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">

            <div id="main-nav" class="flex items-center justify-between h-16 hidden">

                <div class="flex items-center">

                    <div class="flex-shrink-0">

                        <img class="h-8 w-auto" src="/logo.jpg" alt="MediQueue Logo">

                    </div>

                    <!-- Desktop Nav -->

                    <div id="doctor-nav" class="hidden md:flex ml-10 items-baseline space-x-4">

                        <button id="doctor-nav-dashboard" class="text-gray-700 hover:text-indigo-600 px-3 py-2 rounded-md text-sm font-medium">Dashboard</button>

                        <button id="doctor-nav-call" class="text-gray-700 hover:text-indigo-600 px-3 py-2 rounded-md text-sm font-medium">Queue</button>

                        <button id="doctor-nav-appointments" class="text-gray-700 hover:text-indigo-600 px-3 py-2 rounded-md text-sm font-medium">Bookings</button>

                        <button id="doctor-nav-finance" class="text-gray-700 hover:text-indigo-600 px-3 py-2 rounded-md text-sm font-medium">Finance</button>

                        <button id="doctor-nav-settings" class="text-gray-700 hover:text-indigo-600 px-3 py-2 rounded-md text-sm font-medium">Settings</button>

                        <button id="doctor-nav-export" class="text-gray-700 hover:text-indigo-600 px-3 py-2 rounded-md text-sm font-medium">Export</button>

                    </div>

                </div>

                <div id="auth-controls" class="hidden md:flex items-center">

                    <span id="user-display" class="text-gray-700 text-sm font-medium mr-4">user@example.com</span>

                    <button id="logout-btn" class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-md text-sm font-medium">Logout</button>

                </div>

                <!-- Mobile menu button (no functionality, hidden) -->

                 <div class="-mr-2 flex md:hidden">

                     <span class="text-gray-700 font-bold">Doctor Portal</span>

                </div>

            </div>

        </div>

    </nav>



    <main class="pb-24"> <!-- Added padding for bottom nav -->

        <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">



            <div id="doctor-app" style="display: none;">

                

                <div id="doctor-page-dashboard" style="display: none;" class="space-y-6 px-4 sm:px-0">

                    

                    <div>

                        <h1 id="welcome-msg" class="text-3xl sm:text-4xl font-bold bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent mb-1">Welcome, Doctor!</h1>

                        <div class="flex flex-wrap items-center text-gray-500 gap-2 sm:gap-4">

                            <p id="live-date" class="text-sm sm:text-base">November 1, 2025</p>

                            <span class="hidden sm:block text-gray-300">|</span>

                            <p id="live-time" class="text-sm sm:text-base font-medium">11:28:27 AM</p>

                        </div>

                    </div>

                

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-5">

                        <div class="bg-white/80 backdrop-blur-sm p-5 rounded-2xl shadow-xl border border-gray-100 flex items-center gap-4 transition-all hover:shadow-2xl">

                            <div class="flex-shrink-0 w-14 h-14 rounded-xl bg-gradient-to-br from-orange-500 to-pink-500 flex items-center justify-center shadow-lg">

                                <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>

                            </div>

                            <div>

                                <p class="text-sm font-medium text-gray-500 uppercase">Waiting in Queue</p>

                                <p id="dashboard-waiting-count" class="text-3xl font-extrabold text-gray-900">0</p>

                            </div>

                        </div>

                        

                        <div class="bg-white/80 backdrop-blur-sm p-5 rounded-2xl shadow-xl border border-gray-100 flex items-center gap-4 transition-all hover:shadow-2xl">

                            <div class="flex-shrink-0 w-14 h-14 rounded-xl bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center shadow-lg">

                                <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>

                            </div>

                            <div>

                                <p class="text-sm font-medium text-gray-500 uppercase">Patients Seen Today</p>

                                <p id="dashboard-seen-count" class="text-3xl font-extrabold text-gray-900">0</p>

                            </div>

                        </div>

                

                        <div class="bg-white/80 backdrop-blur-sm p-5 rounded-2xl shadow-xl border border-gray-100 flex items-center gap-4 transition-all hover:shadow-2xl">

                            <div class="flex-shrink-0 w-14 h-14 rounded-xl bg-gradient-to-br from-emerald-500 to-teal-600 flex items-center justify-center shadow-lg">

                                <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>

                            </div>

                            <div>

                                <p class="text-sm font-medium text-gray-500 uppercase">Today's Revenue</p>

                                <p id="dashboard-total-revenue" class="text-3xl font-extrabold text-gray-900">₹0</p>

                            </div>

                        </div>

                    </div>

                

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

                        

                        <div class="lg:col-span-1 space-y-6">

                            <div class="bg-white/80 backdrop-blur-sm p-5 rounded-2xl shadow-xl border border-gray-100">

                                <h2 class="text-xl font-bold text-gray-800 mb-4">Up Next in Queue</h2>

                                <div id="dashboard-up-next-patient">

                                    <div class="text-center text-gray-500 py-8">

                                        <svg class="w-12 h-12 mx-auto text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7v8a2 2 0 002 2h4M8 7V3a2 2 0 012-2h4a2 2 0 012 2v4a2 2 0 01-2 2h-4A2 2 0 018 7z"></path></svg>

                                        <p class="mt-2 text-sm font-medium">The queue is empty.</p>

                                    </div>

                                </div>

                                <button id="dashboard-call-patient-btn" class="mt-4 w-full px-6 py-3 text-base font-semibold text-white bg-gradient-to-r from-blue-600 to-indigo-600 border border-transparent rounded-xl hover:from-blue-700 hover:to-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all duration-200 shadow-md hover:shadow-lg transform hover:-translate-y-0.5">

                                    Go to Patient Queue

                                </button>

                            </div>

                

                            <!-- QR Code Card -->

                            <div class="bg-white/80 backdrop-blur-sm p-5 rounded-2xl shadow-xl border border-gray-100">

                                <h2 class="text-xl font-bold text-gray-800 mb-4">Daily QR Code</h2>

                                <div class="text-center p-4 bg-gray-50 rounded-xl">

                                    <p class="text-sm text-gray-600 mb-2">Patients scan this to check in:</p>

                                    <canvas id="qr-code-canvas" class="mx-auto border border-gray-300 rounded-lg"></canvas>

                                    <p class="text-xl font-bold text-gray-800 mt-2">Passcode: <span id="daily-passcode" class="text-blue-600">...</span></p>

                                </div>

                            </div>

                        </div>

                

                        <div class="lg:col-span-2 bg-white/80 backdrop-blur-sm p-5 rounded-2xl shadow-xl border border-gray-100">

                            <h2 class="text-xl font-bold text-gray-800 mb-4">Upcoming Appointments Today</h2>

                            <div id="dashboard-appointments-msg" class="text-center text-gray-500 py-12" style="display: none;">

                                <svg class="w-12 h-12 mx-auto text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>

                                <p class="mt-2 text-sm font-medium">No more appointments scheduled for today.</p>

                            </div>

                            <ul id="dashboard-appointments-list" class="space-y-3 max-h-[450px] overflow-y-auto custom-scrollbar">

                                </ul>

                        </div>

                

                    </div>

                </div>

                <div id="doctor-page-call" style="display: none;" class="px-4 sm:px-0 space-y-6">

                    <div>

                        <h1 class="text-3xl font-bold text-gray-900 mb-4">In-Clinic Queue (Waiting)</h1>

                        <div id="doctor-message" class="text-center p-6 bg-white text-gray-700 rounded-lg shadow-lg" style="display: none;">

                            The in-clinic queue is currently empty.

                        </div>

                        <ul id="doctor-queue-list" class="space-y-4">

                            </ul>

                    </div>

                    

                    <div>

                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Pre-Registered (En Route)</h2>

                        <div id="pre-registered-msg" class="text-center p-6 bg-white text-gray-700 rounded-lg shadow-lg" style="display: none;">

                            No patients are currently en route.

                        </div>

                        <ul id="pre-registered-list" class="space-y-4">

                            </ul>

                    </div>

                </div>

                

                <div id="doctor-page-appointments" style="display: none;" class="px-4 sm:px-0">

                    <h1 class="text-3xl font-bold text-gray-900 mb-4">View Appointments</h1>

                    <div class="bg-white/80 backdrop-blur-sm p-6 rounded-2xl shadow-xl border border-gray-100 max-w-3xl mx-auto">

                        <label for="doc-apt-date" class="block text-sm font-medium text-gray-700">Select Date to View</label>

                        <input type="date" id="doc-apt-date" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" required>

                        

                        <div id="doc-apt-msg" class="text-center p-4 bg-gray-100 text-gray-700 rounded-lg mt-6" style="display: none;">

                            Loading...

                        </div>

                        <ul id="doc-apt-list" class="space-y-4 mt-6 max-h-96 overflow-y-auto custom-scrollbar">

                            <!-- Appointments will be injected here by JS -->

                        </ul>

                    </div>

                </div>



                <!-- *** NEW FINANCE PAGE (Houses Revenue + Expenses) *** -->

                <div id="doctor-page-finance" style="display: none;" class="px-4 sm:px-0">

                    <div class="mb-6">

                        <h1 class="text-3xl sm:text-4xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent mb-2">Financials</h1>

                        <p class="text-gray-600 text-sm sm:text-base">Track your clinic's revenue and expenses.</p>

                    </div>



                    <!-- Finance Tab Navigation -->

                    <div class="mb-6 border-b border-gray-300">

                        <nav class="-mb-px flex gap-6" aria-label="Tabs">

                            <button id="finance-revenue-tab-btn" class="tab-btn-active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">

                                Revenue

                            </button>

                            <button id="finance-expenses-tab-btn" class="text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">

                                Expenses

                            </button>

                        </nav>

                    </div>



                    <!-- Revenue Page Content -->

                    <div id="finance-revenue-page" style="display: none;">

                        <div class="bg-white/80 backdrop-blur-sm p-4 sm:p-6 rounded-2xl shadow-xl border border-gray-100 mb-6">

                            <h2 class="text-lg sm:text-xl font-semibold text-gray-800 mb-4">Select Date Range</h2>

                            <div class="flex flex-wrap items-center gap-2 sm:gap-3 mb-4">

                                <button id="financials-today-btn" type="button" class="px-4 py-2.5 text-sm font-medium text-white bg-gradient-to-r from-blue-600 to-blue-700 border border-transparent rounded-xl hover:from-blue-700 hover:to-blue-800 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-all duration-200 shadow-md hover:shadow-lg transform hover:-translate-y-0.5 cursor-pointer">Today</button>

                                <button id="financials-week-btn" type="button" class="px-4 py-2.5 text-sm font-medium text-gray-700 bg-gray-100 border border-gray-200 rounded-xl hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 transition-all duration-200 cursor-pointer">This Week</button>

                                <button id="financials-month-btn" type="button" class="px-4 py-2.5 text-sm font-medium text-gray-700 bg-gray-100 border border-gray-200 rounded-xl hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 transition-all duration-200 cursor-pointer">This Month</button>

                                <button id="financials-custom-btn" type="button" class="px-4 py-2.5 text-sm font-medium text-gray-700 bg-gray-100 border border-gray-200 rounded-xl hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 transition-all duration-200 cursor-pointer">Custom Range</button>

                            </div>

                            <div id="financials-custom-range" class="flex flex-col sm:flex-row flex-wrap items-stretch sm:items-end gap-3 sm:gap-4 animate-fade-in" style="display: none;">

                                <div class="flex-1 min-w-[140px]">

                                    <label for="financials-start-date" class="block text-sm font-medium text-gray-700 mb-1.5">Start Date</label>

                                    <input type="date" id="financials-start-date" class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm transition-all duration-200">
                                </div>
                                <div class="flex-1 min-w-[140px]">
                                    <label for="financials-end-date" class="block text-sm font-medium text-gray-700 mb-1.5">End Date</label>
                                    <input type="date" id="financials-end-date" class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm transition-all duration-200">
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6 mb-6">
                            <div class="bg-gradient-to-br from-emerald-500 via-emerald-600 to-teal-600 text-white shadow-xl rounded-2xl p-5 sm:p-6 text-center transform hover:scale-105 transition-transform duration-200">
                                <h2 class="text-sm sm:text-base font-medium text-emerald-50 uppercase tracking-wider mb-2">Total Revenue</h2>
                                <p id="financials-total-revenue" class="text-4xl sm:text-5xl font-extrabold">₹0.00</p>
                            </div>
                            <div class="bg-gradient-to-br from-blue-500 via-blue-600 to-indigo-600 text-white shadow-xl rounded-2xl p-5 sm:p-6 text-center transform hover:scale-105 transition-transform duration-200">
                                <h2 class="text-sm sm:text-base font-medium text-blue-50 uppercase tracking-wider mb-2">Avg per Patient</h2>
                                <p id="financials-avg-revenue" class="text-4xl sm:text-5xl font-extrabold">₹0.00</p>
                            </div>
                            <div class="bg-gradient-to-br from-purple-500 via-purple-600 to-pink-600 text-white shadow-xl rounded-2xl p-5 sm:p-6 text-center transform hover:scale-105 transition-transform duration-200 sm:col-span-2 lg:col-span-1">
                                <h2 class="text-sm sm:text-base font-medium text-purple-50 uppercase tracking-wider mb-2">Transactions</h2>
                                <p id="financials-transaction-count" class="text-4xl sm:text-5xl font-extrabold">0</p>
                            </div>
                        </div>
                        
                        <div class="bg-white/80 backdrop-blur-sm shadow-xl rounded-2xl p-4 sm:p-6 border border-gray-100">
                            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-4">
                                <h2 class="text-xl sm:text-2xl font-bold text-gray-800">Transaction History</h2>
                                <button id="financials-export-btn" class="w-full sm:w-auto px-5 py-2.5 text-sm font-medium text-white bg-gradient-to-r from-emerald-600 to-teal-600 border border-transparent rounded-xl hover:from-emerald-700 hover:to-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500 transition-all duration-200 shadow-md hover:shadow-lg transform hover:-translate-y-0.5 flex items-center justify-center gap-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                    Export Revenue CSV
                                </button>
                            </div>
                            <ul id="financials-transactions-list" class="space-y-3 max-h-[60vh] overflow-y-auto custom-scrollbar">
                                <li class="text-center text-gray-500 py-8 text-sm sm:text-base">Select a date range to view transactions.</li>
                            </ul>
                        </div>
                    </div>

                    <div id="finance-expenses-page" style="display: none;">
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div class="lg:col-span-1 bg-white/80 backdrop-blur-sm p-5 rounded-2xl shadow-xl border border-gray-100 h-fit">
                                <h2 class="text-xl font-bold text-gray-800 mb-4">Add New Expense</h2>
                                <form id="expense-form" class="space-y-4">
                                    <div>
                                        <label for="expense-date" class="block text-sm font-medium text-gray-700">Date of Expense</label>
                                        <input type="date" id="expense-date" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                                    </div>
                                    <div>
                                        <label for="expense-category" class="block text-sm font-medium text-gray-700">Category</label>
                                        <select id="expense-category" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                                            <option value="">Select a category...</option>
                                            <option value="Salary">Salary</option>
                                            <option value="EB">EB (Electricity)</option>
                                            <option value="Rent">Rent</option>
                                            <option value="Telephone">Telephone / Internet</option>
                                            <option value="Misc">Miscellaneous</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="expense-amount" class="block text-sm font-medium text-gray-700">Amount (INR)</label>
                                        <input type="number" id="expense-amount" min="0.01" step="0.01" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., 15000" required>
                                    </div>
                                    <div>
                                        <label for="expense-description" class="block text-sm font-medium text-gray-700">Description (Optional)</label>
                                        <textarea id="expense-description" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., Staff salary for October"></textarea>
                                    </div>
                                    <button id="save-expense-btn" type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-xl shadow-lg text-sm font-medium text-white bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all transform hover:-translate-y-0.5">
                                        Save Expense
                                    </button>
                                    <p id="expense-status-msg" class="text-sm text-center" style="display: none;"></p>
                                </form>
                            </div>

                            <div class="lg:col-span-2 bg-white/80 backdrop-blur-sm p-5 rounded-2xl shadow-xl border border-gray-100">
                                <h2 class="text-xl font-bold text-gray-800 mb-4">Recent Expenses</h2>
                                <div id="expense-list-msg" class="text-center text-gray-500 py-12" style="display: none;">
                                    <svg class="w-12 h-12 mx-auto text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                    <p class="mt-2 text-sm font-medium">No expenses logged yet.</p>
                                </div>
                                <ul id="expense-list" class="space-y-3 max-h-[60vh] overflow-y-auto custom-scrollbar">
                                    </ul>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="doctor-page-settings" style="display: none;" class="px-4 sm:px-0 space-y-6">
                    <div class="mb-6">
                        <h1 class="text-3xl sm:text-4xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent mb-2">Clinic Settings</h1>
                        <p class="text-gray-600 text-sm sm:text-base">Configure your clinic's parameters and app settings.</p>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

                        <div class="space-y-6">
                            <div class="bg-white/80 backdrop-blur-sm p-5 sm:p-7 rounded-2xl shadow-xl border border-gray-100">
                                <div class="flex items-center gap-3 mb-6">
                                    <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center flex-shrink-0">
                                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                        </svg>
                                    </div>
                                    <div>
                                        <h2 class="text-xl font-bold text-gray-800">Location Configuration</h2>
                                        <p class="text-sm text-gray-500">Set clinic coordinates for patient check-in</p>
                                    </div>
                                </div>
                                <div class="space-y-5">
                                    <div>
                                        <label for="settings-lat-input" class="block text-sm font-semibold text-gray-700 mb-2">Clinic Latitude</label>
                                        <input type="number" id="settings-lat-input" step="any" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., 12.9432">
                                    </div>
                                    <div>
                                        <label for="settings-lon-input" class="block text-sm font-semibold text-gray-700 mb-2">Clinic Longitude</label>
                                        <input type="number" id="settings-lon-input" step="any" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., 80.1584">
                                    </div>
                                    <button id="settings-get-location-btn" type="button" class="w-full flex justify-center items-center gap-2 py-3 px-6 border-2 border-gray-300 rounded-xl shadow-sm text-sm font-semibold text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all duration-200">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                                        Use My Current Location
                                    </button>
                                    <div>
                                        <label for="settings-max-distance-input" class="block text-sm font-semibold text-gray-700 mb-2">Check-in Distance (meters)</label>
                                        <input type="number" id="settings-max-distance-input" min="0" step="1" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., 500">
                                    </div>
                                    <button id="settings-save-btn" class="w-full flex justify-center items-center gap-2 py-3.5 px-6 border border-transparent rounded-xl shadow-lg text-sm font-semibold text-white bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all duration-200 transform hover:-translate-y-0.5 hover:shadow-xl">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                        </svg>
                                        Save Location Settings
                                    </button>
                                    <p id="settings-status-msg" class="text-sm text-center" style="display: none;"></p>
                                </div>
                            </div>

                            <div class="bg-white/80 backdrop-blur-sm p-5 sm:p-7 rounded-2xl shadow-xl border border-gray-100">
                                <div class="flex items-center gap-3 mb-6">
                                    <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center flex-shrink-0">
                                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
                                    </div>
                                    <div>
                                        <h2 class="text-xl font-bold text-gray-800">App Settings</h2>
                                        <p class="text-sm text-gray-500">Install this portal as an app</p>
                                    </div>
                                </div>
                                <button id="install-pwa-btn" type="button" class="w-full hidden flex justify-center items-center gap-2 py-3 px-4 border border-transparent rounded-xl shadow-lg text-sm font-medium text-white bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all transform hover:-translate-y-0.5 mb-4">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                    Install App on this Device
                                </button>
                                <p class="text-xs text-gray-500 text-center">If the button does not appear, your browser does not support installation, or the app is already installed.</p>
                            </div>
                        </div>

                        <div class="space-y-6">
                            <div class="bg-white/80 backdrop-blur-sm p-5 sm:p-7 rounded-2xl shadow-xl border border-gray-100">
                                <div class="flex items-center gap-3 mb-6">
                                    <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-orange-500 to-red-500 flex items-center justify-center flex-shrink-0">
                                         <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                                    </div>
                                    <div>
                                        <h2 class="text-xl font-bold text-gray-800">Queue Configuration</h2>
                                        <p class="text-sm text-gray-500">Set daily limits and access</p>
                                    </div>
                                </div>
                                <div class="space-y-5">
                                    <div>
                                        <label for="daily-limit-input" class="block text-sm font-semibold text-gray-700 mb-2">Daily Patient Limit</label>
                                        <div class="flex flex-col sm:flex-row gap-3">
                                            <input type="number" id="daily-limit-input" min="0" step="1" class="flex-1 px-4 py-3 border-2 border-gray-200 rounded-xl shadow-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter limit">
                                            <button id="save-limit-btn" class="px-5 py-3 text-sm font-semibold text-white bg-gradient-to-r from-blue-600 to-indigo-600 border border-transparent rounded-xl hover:from-blue-700 hover:to-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all duration-200 shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
                                                Save Limit
                                            </button>
                                        </div>
                                        <p id="limit-save-status" class="text-sm text-green-600 mt-3" style="display: none;"></p>
                                    </div>

                                    <hr class="border-gray-200">

                                    <div class="text-center p-4 bg-gray-50 rounded-xl">
                                        <p class="text-sm text-gray-600 mb-2">Show this to patients to check in:</p>
                                        <canvas id="qr-code-canvas" class="mx-auto border border-gray-300 rounded-lg"></canvas>
                                        <p class="text-xl font-bold text-gray-800 mt-2">Passcode: <span id="daily-passcode" class="text-blue-600">...</span></p>
                                    </div>
                                    <div class="mt-4">
                                        <label for="remote-passcode-input" class="block text-sm font-semibold text-gray-700 mb-2">Set New Passcode</label>
                                        <div class="flex flex-col sm:flex-row gap-3">
                                            <input type="text" id="remote-passcode-input" class="flex-1 px-4 py-3 border-2 border-gray-200 rounded-xl shadow-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., BLUE42">
                                            <button id="save-passcode-btn" class="px-5 py-3 text-sm font-semibold text-white bg-gradient-to-r from-blue-600 to-indigo-600 border border-transparent rounded-xl hover:from-blue-700 hover:to-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all duration-200 shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
                                                Save Passcode
                                            </button>
                                        </div>
                                        <p id="passcode-save-status" class="text-sm text-green-600 mt-3" style="display: none;"></p>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
                
                 <div id="doctor-page-export" style="display: none;" class="px-4 sm:px-0">
                    <h1 class="text-3xl font-bold text-gray-900 mb-4">Export Patient Data</h1>
                    <div class="bg-white/80 backdrop-blur-sm p-6 rounded-2xl shadow-xl border border-gray-100 max-w-lg mx-auto text-center">
                        <p class="text-gray-600 mb-4">Select a date to export all live queue patient data (waiting and seen) to a CSV file.</p>
                        <input type="date" id="export-date" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm mb-4" required>
                        <button id="export-btn" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            Export Patients to CSV
                        </button>
                    </div>
                </div>

            </div>

        </div>
    </main>

    <nav id="mobile-doctor-nav" class="md:hidden fixed bottom-0 left-0 right-0 h-16 bg-white border-t border-gray-200 flex z-50" style="display: none;">
        <button id="mobile-nav-dashboard" class="flex-1 flex flex-col items-center justify-center p-2 text-sm font-medium text-gray-500 hover:text-blue-600">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
            <span class="text-xs">Dashboard</span>
        </button>
        <button id="mobile-nav-call" class="flex-1 flex flex-col items-center justify-center p-2 text-sm font-medium text-gray-500 hover:text-blue-600">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
            <span class="text-xs">Queue</span>
        </button>
        <button id="mobile-nav-appointments" class="flex-1 flex flex-col items-center justify-center p-2 text-sm font-medium text-gray-500 hover:text-blue-600">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
            <span class="text-xs">Bookings</span>
        </button>
        <button id="mobile-nav-finance" class="flex-1 flex flex-col items-center justify-center p-2 text-sm font-medium text-gray-500 hover:text-blue-600">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            <span class="text-xs">Finance</span>
        </button>
        <button id="mobile-nav-settings" class="flex-1 flex flex-col items-center justify-center p-2 text-sm font-medium text-gray-500 hover:text-blue-600">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
            <span class="text-xs">Settings</span>
        </button>
    </nav>


    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-white"></div>
    </div>

    <div id="modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 p-4" style="display: none;">
        <div class="bg-white p-6 rounded-2xl shadow-xl max-w-sm w-full mx-4 animate-fade-in">
            <h3 class="text-lg font-medium text-gray-900">Notification</h3>
            <p id="modal-message" class="mt-2 text-sm text-gray-600">This is an alert message.</p>
            <div class="mt-4 text-right">
                <button id="modal-close-btn" type="button" class="inline-flex justify-center px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    OK
                </button>
            </div>
        </div>
    </div>

    <div id="notes-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 p-4" style="display: none;">
        <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full overflow-hidden animate-fade-in">
            <div class="bg-gradient-to-r from-blue-600 to-indigo-600 px-6 py-5">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 rounded-full bg-white/20 flex items-center justify-center">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-xl sm:text-2xl font-bold text-white">Complete Patient Visit</h3>
                        <p class="text-sm text-blue-100 mt-0.5">Add notes and fee to finalize consultation</p>
                    </div>
                </div>
            </div>

            <form id="notes-form" class="p-6 sm:p-8">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-5">

                    <div class="md:col-span-2">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <span class="flex items-center gap-2">
                                <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M5 11v0"></path></svg>
                                Previous Visit History
                            </span>
                        </label>
                        <div class="w-full h-48 bg-gray-50 border-2 border-gray-200 rounded-xl p-3 custom-scrollbar overflow-y-auto">
                            <p id="previous-history-msg" class="text-sm text-gray-500 text-center p-4" style="display: none;">Loading history...</p>
                            <ul id="previous-history-list" class="space-y-3">
                                </ul>
                        </div>
                    </div>

                    <div class="md:col-span-1">
                        <label for="consultation-fee" class="block text-sm font-semibold text-gray-700 mb-2">
                            <span class="flex items-center gap-2">
                                <svg class="w-4 h-4 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                Consultation Fee (INR)
                            </span>
                        </label>
                        <input type="number" id="consultation-fee" min="0" step="0.01" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-base transition-all duration-200" placeholder="e.g., 500" required>
                    </div>

                    <div class="md:col-span-1">
                        <label for="next-visit-date" class="block text-sm font-semibold text-gray-700 mb-2">
                            <span class="flex items-center gap-2">
                                <svg class="w-4 h-4 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                Next Visit Date (Optional)
                            </span>
                        </label>
                        <input type="date" id="next-visit-date" min="" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-base transition-all duration-200">
                    </div>

                    <div class="md:col-span-2">
                        <label for="notes-text" class="block text-sm font-semibold text-gray-700 mb-2">
                            <span class="flex items-center gap-2">
                                <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                Current Visit Notes
                            </span>
                        </label>
                        <textarea id="notes-text" rows="4" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-base transition-all duration-200 resize-none" placeholder="Enter diagnosis, prescription, or visit summary..." required></textarea>
                        <p class="mt-1.5 text-xs text-gray-500">These notes will be saved to the patient's history</p>
                    </div>
                </div>
                
                <div class="mt-8 flex flex-col sm:flex-row justify-end gap-3 pt-6 border-t border-gray-200">
                    <button id="notes-cancel-btn" type="button" class="w-full sm:w-auto px-6 py-3 text-sm font-semibold text-gray-700 bg-gray-100 border-2 border-gray-200 rounded-xl hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 transition-all duration-200">
                        Cancel
                    </button>
                    <button id="notes-submit-btn" type="submit" class="w-full sm:w-auto px-6 py-3 text-sm font-semibold text-white bg-gradient-to-r from-blue-600 to-indigo-600 border border-transparent rounded-xl hover:from-blue-700 hover:to-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all duration-200 shadow-md hover:shadow-lg transform hover:-translate-y-0.5 flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        Complete & Dismiss
                    </button>
                </div>
            </form>
        </div>
    </div>

</body>
</html>

