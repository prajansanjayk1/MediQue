<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#3b82f6" />
    <!-- FIX: Use absolute paths -->
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icon-192x192.png">
    <title>MediQueue - Patient Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <!-- NEW: QR Scanner Library -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        .animate-spin-fast {
            animation: spin 0.8s linear infinite;
        }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: linear-gradient(to bottom, #3b82f6, #8b5cf6); border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: linear-gradient(to bottom, #2563eb, #7c3aed); }
        body {
            background-color: #f8fafc; /* A light, clean gray */
            min-height: 100vh;
        }
        .bottom-nav-active { color: #2563eb; }
        .bottom-nav-active svg { transform: scale(1.1); }

        /* QR Scanner Modal Style */
        #qr-scanner-modal {
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        #qr-reader {
            width: 90vw;
            max-width: 400px;
            background: white;
            border-radius: 1.5rem; /* 24px */
            overflow: hidden;
        }
        #qr-reader-region {
            border: none !important;
        }
    </style>

    <style>
        /* --- Mobile App-like Optimizations --- */
        body, html {
            overscroll-behavior-y: contain;
        }
        input[type="text"],
        input[type="tel"],
        input[type="date"],
        textarea,
        select {
            font-size: 16px !important;
        }
        button,
        #bottom-nav > button {
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            -webkit-user-select: none; /* Safari */
        }
    </style>
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            setPersistence,
            browserLocalPersistence,
            onAuthStateChanged,
            updateProfile,
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore,
            collection,
            addDoc,
            query,
            where,
            onSnapshot,
            serverTimestamp,
            doc,
            setDoc,
            getDoc,
            getDocs, // <-- Added getDocs
            updateDoc, // <-- Added updateDoc
            orderBy,
            Timestamp,
            collectionGroup
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- App Configuration ---
        const firebaseConfig = {
          apiKey: "",
          authDomain: "main-8c336.firebaseapp.com",
          projectId: "main-8c336",
          storageBucket: "main-8c336.firebasestorage.app",
          messagingSenderId: "507656529909",
          appId: "1:507656529909:web:ccea008f4a1178bf0da2bc",
          measurementId: "G-RX4KHQRQMJ"
        };
        const appId = firebaseConfig.projectId;
        
        // --- REMOVED GEOLOCATION CONFIG ---
        const ADMIN_EMAIL = "prajansanjayko@gmail.com";
        const DAILY_PASS_KEY = 'mediqueue_daily_pass'; // Key for localStorage

        // --- Initialization ---
        window.onload = async () => {
            // --- PWA Service Worker Registration ---
            if ('serviceWorker' in navigator) {
                try {
                    // FIX: Use an absolute path for the service worker
                    await navigator.serviceWorker.register('/sw.js');
                    console.log('Service Worker registered successfully');
                } catch (err) {
                    console.error('Service Worker registration failed:', err);
                }
            }
            // --- PWA Install Prompt ---
            let deferredInstallPrompt = null;

            // DOM Elements
            let app, db, auth;
            let patientApp;
            let patientPages = {};
            let mainNav, authControls, userDisplay, logoutBtn, welcomeHeader;
            let bottomNav, bottomNavDashboard, bottomNavAppointments, bottomNavHistory, bottomNavProfile;
            let bottomNavItems = []; 
            let dashboardWelcome, dashboardShortcuts, dashboardJoinQueueBtn, dashboardScanQRBtn; // <-- Added Scan Button
            let queueStatusSection, queueMessageEl, queueNumberEl, queueEstimateEl, queueClosedMsg;
            let queueScanCheckinBtn; // <-- NEW: Button on "En Route" card
            let joinQueueModal, joinQueueModalClose, joinQueueForm, joinQueueBtnModal, patientNameInput, patientMobileInput, patientIssueInput;
            let modalStepForm, modalStepError, modalErrorMsg;
            let historyList, historyMsg;
            let aptDateInput, aptTimeSelect, aptReasonInput, aptBookBtn, myAptList, myAptMsg;
            let profileNameInput, profileMobileInput, profileUpdateBtn, profileMsg, mobileLogoutBtn, installPwaBtn;
            let loadingOverlay, modal, modalMessage, modalCloseBtn;

            // --- NEW: QR Scanner Modal ---
            let qrScannerModal, qrScannerCloseBtn;
            let html5QrScanner; // This will hold the scanner object

            // App State
            let currentUserId = null, currentUserEmail = null, currentUserDisplayName = null;
            let isAuthReady = false;
            let myQueueUnsubscribe = null, historyUnsubscribe = null, clinicStatusUnsubscribe = null;
            let patientQueueCountUnsubscribe = null, myAppointmentsUnsubscribe = null, profileUnsubscribe = null;
            let currentDailyLimit = 999; 
            let hasPlayedSound = false;
            let notificationSynth = null;
            let clinicPasscode = null; 
            let joinMode = 'pre_registered'; // Default to 'pre_registered'
            let isScanning = false; // <-- *** NEW: Scanner Guard ***
            
            // --- Initialize Firebase ---
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                await setPersistence(auth, browserLocalPersistence);
            } catch (error) {
                console.error("Firebase Init Error:", error);
                showModal("Error initializing app. Please check your Firebase config and refresh.");
                return;
            }

            // --- 1. Passcode & QR Logic ---

            // --- *** FIX for html5QrScanner.stop is not a function *** ---
            function startScanner() {
                if (isScanning) return; // Don't start if already starting
                isScanning = true;
                if (qrScannerModal) qrScannerModal.style.display = 'flex';
                
                // Only create a new scanner if one doesn't exist
                if (!html5QrScanner) {
                    html5QrScanner = new Html5QrcodeScanner(
                        "qr-reader-region", 
                        { fps: 10, qrbox: { width: 250, height: 250 } },
                        /* verbose= */ false
                    );
                }
                
                html5QrScanner.render(onScanSuccess, onScanFailure);
            }

            async function stopScanner() {
                isScanning = false; // Set state immediately
                if (html5QrScanner) {
                    try {
                        // Check if scanner is in a scanning state before stopping
                        if (html5QrScanner.getState() === 2) { // 2 === Html5QrcodeScannerState.SCANNING
                            await html5QrScanner.stop(); // *** AWAIT the stop promise ***
                            console.log("Scanner stopped successfully.");
                        }
                        html5QrScanner.clear(); // Always clear after
                    } catch (err) {
                        console.warn("Error stopping/clearing scanner:", err);
                        html5QrScanner.clear(); // Fallback to clear
                    }
                }
                if (qrScannerModal) qrScannerModal.style.display = 'none';
            }
            
            async function onScanSuccess(decodedText, decodedResult) {
                if (!isScanning) return; // *** NEW: Guard against multiple calls ***
                isScanning = false; // Prevent re-entry

                console.log(`Scan result: ${decodedText}`, decodedResult);
                await stopScanner(); // *** AWAIT the stop *first* ***
                
                try {
                    // Try to parse as URL
                    const url = new URL(decodedText);
                    const pass = url.searchParams.get('pass');
                    if (pass) {
                        await checkPasscodeFromURL(pass); // Pass the code to the validator
                    } else {
                        showModal("Invalid QR Code. No passcode found.");
                    }
                } catch (err) {
                    // Not a URL, maybe it's just the code?
                    if(decodedText && decodedText.length < 10 && decodedText.length > 2) {
                         await checkPasscodeFromURL(decodedText); // Pass the raw text
                    } else {
                        showModal("Invalid QR Code scanned.");
                    }
                }
            }

            function onScanFailure(error) {
                // This is called continuously, so we only log if it's a real error
                if (!error.includes("No QR code found")) {
                    console.warn(`QR scan failure: ${error}`);
                }
            }
            
            // --- *** FIX: This function now ONLY verifies and saves the pass *** ---
            async function checkPasscodeFromURL(pass) {
                if (!pass) {
                    // This handles the initial page load check
                    const params = new URLSearchParams(window.location.search);
                    pass = params.get('pass');
                    if (!pass) return; // No pass in URL, do nothing
                }

                console.log("Verifying passcode:", pass);
                try {
                    const statusRef = doc(db, `artifacts/${appId}/public/data/clinicStatus/status`);
                    const docSnap = await getDoc(statusRef); // This will error if rules are not set

                    if (docSnap.exists() && docSnap.data().remotePasscode) {
                        const correctPasscode = docSnap.data().remotePasscode;
                        clinicPasscode = correctPasscode; 

                        if (pass.toUpperCase() === correctPasscode) {
                            // Valid pass! Store it for today.
                            const passData = {
                                pass: correctPasscode,
                                date: new Date().toLocaleDateString()
                            };
                            localStorage.setItem(DAILY_PASS_KEY, JSON.stringify(passData));
                            
                            // *** FIX: Call checkInPreRegisteredUser AFTER auth is ready ***
                            if (isAuthReady && currentUserId) {
                                const didCheckIn = await checkInPreRegisteredUser(); 
                                if (!didCheckIn) {
                                    // User scanned, is valid, but was not pre-registered.
                                    // Open the modal for them to join the 'waiting' queue.
                                    console.log("Valid pass, user not pre-registered. Opening modal for 'waiting' queue.");
                                    joinMode = 'waiting'; // Set mode to 'waiting'
                                    if (joinQueueModal) joinQueueModal.style.display = 'flex';
                                    if (modalStepForm) modalStepForm.style.display = 'block';
                                    if (modalStepError) modalStepError.style.display = 'none';
                                } else {
                                    showModal("Pass verified. You have been checked in!");
                                }
                            } else {
                                showModal("Pass verified successfully! Please log in to continue.");
                            }

                        } else {
                            showModal("Invalid or expired passcode provided.");
                        }
                    } else {
                        showModal("Could not verify passcode. Clinic status not found.");
                    }
                } catch (error) {
                    console.error("Error verifying passcode:", error);
                    // This is where your "Missing or insufficient permissions" error appears
                    showModal("Error verifying passcode. Please ensure you have an internet connection.");
                }
                // Clean the URL if it was in the query params
                if (window.location.search.includes('pass=')) {
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            }
            
            // --- UPDATED: Now returns a boolean ---
            async function checkInPreRegisteredUser() {
                if (!currentUserId) return false;

                console.log("Checking in pre-registered user...");
                const queueCollectionPath = `artifacts/${appId}/public/data/queue`;
                const q = query(collection(db, queueCollectionPath),
                                where("patientId", "==", currentUserId),
                                where("status", "==", "pre_registered"));
                
                try {
                    const querySnapshot = await getDocs(q);
                    
                    if (!querySnapshot.empty) {
                        // User is pre-registered. Let's check them in.
                        const userDocRef = querySnapshot.docs[0].ref;
                        await updateDoc(userDocRef, {
                            status: "waiting", // Move to the live queue
                            joinedAt: serverTimestamp() // Put them at the end of the line
                        });
                        console.log("User successfully checked in from pre_registered.");
                        return true; // <-- Return true
                    } else {
                        console.log("User has a pass, but is not pre-registered. No check-in needed.");
                        return false; // <-- Return false
                    }
                } catch (error) {
                     console.error("Error during check-in:", error);
                     return false; // <-- Return false
                }
            }

            // Checks localStorage and Firestore for a valid pass
            async function verifyDailyPass() {
                const passDataString = localStorage.getItem(DAILY_PASS_KEY);
                if (!passDataString) {
                    return false; // No pass stored
                }

                const passData = JSON.parse(passDataString);
                const today = new Date().toLocaleDateString();

                // Check if pass is from today
                if (passData.date !== today) {
                    localStorage.removeItem(DAILY_PASS_KEY); // Stale pass
                    return false;
                }

                // Pass is from today. Now, double-check it with Firestore.
                try {
                    if (!clinicPasscode) { // Fetch if not already in memory
                        const statusRef = doc(db, `artifacts/${appId}/public/data/clinicStatus/status`);
                        const docSnap = await getDoc(statusRef);
                        if (docSnap.exists() && docSnap.data().remotePasscode) {
                            clinicPasscode = docSnap.data().remotePasscode;
                        }
                    }
                    
                    if (passData.pass === clinicPasscode) {
                        return true; // Pass is valid and matches Firestore
                    } else {
                        localStorage.removeItem(DAILY_PASS_KEY); // Pass is stale/mismatched
                        return false;
                    }
                } catch (error) {
                    console.error("Error cross-checking passcode:", error);
                    return false;
                }
            }
            
            // --- *** THIS IS THE FIX: "Join from Home" button logic *** ---
            async function handleJoinQueueClick() {
                // This button is for "Join from Home"
                // It should ALWAYS register them as 'pre_registered'.
                
                if (joinQueueModal) joinQueueModal.style.display = 'flex';
                
                // Hide error step, show form step
                if (modalStepForm) modalStepForm.style.display = 'block';
                if (modalStepError) modalStepError.style.display = 'none';

                // Set the mode to pre_registered
                joinMode = 'pre_registered';
                console.log("Join from Home button clicked. Join mode set to: pre_registered");
            }


            // --- 2. Authentication Logic ---
            async function handleLogout() {
                await signOut(auth);
                localStorage.removeItem(DAILY_PASS_KEY); // Clear pass on logout
                // FIX: Use absolute path
                window.location.href = '/index.html'; 
            }
 
            // --- 3. Page Navigation Logic (UPDATED) ---
            function showPatientView(pageId) {
                if (!patientApp) return;
                patientApp.style.display = 'block';

                Object.values(patientPages).forEach(page => page.style.display = 'none');
                if (patientPages[pageId]) {
                    patientPages[pageId].style.display = 'block';
                }

                bottomNavItems.forEach(btn => btn?.classList.remove('bottom-nav-active'));

                // Stop all listeners
                if (clinicStatusUnsubscribe) clinicStatusUnsubscribe();
                if (patientQueueCountUnsubscribe) patientQueueCountUnsubscribe();
                if (myQueueUnsubscribe) myQueueUnsubscribe();
                if (historyUnsubscribe) historyUnsubscribe();
                if (myAppointmentsUnsubscribe) myAppointmentsUnsubscribe();
                if (profileUnsubscribe) profileUnsubscribe();

                if (pageId === 'dashboard') { 
                    bottomNavDashboard?.classList.add('bottom-nav-active');
                    requestNotificationPermission();
                    attachClinicStatusListener();
                    attachPatientQueueListener();
                } else if (pageId === 'history') {
                    bottomNavHistory?.classList.add('bottom-nav-active');
                    attachHistoryListener(); 
                } else if (pageId === 'appointments') {
                    bottomNavAppointments?.classList.add('bottom-nav-active');
                    attachMyAppointmentListener(); 
                } else if (pageId === 'profile') {
                    bottomNavProfile?.classList.add('bottom-nav-active');
                    attachProfileListener(); 
                }
            }

            // --- 4. Patient: Live Queue (Book) Logic ---

            function requestNotificationPermission() {
                if ("Notification" in window && Notification.permission !== "denied") {
                    Notification.requestPermission();
                }
            }

            function playNotificationSound() {
                if (hasPlayedSound) return;
                if (!notificationSynth) {
                    notificationSynth = new Tone.Synth().toDestination();
                }
                Tone.start().then(() => {
                    notificationSynth.triggerAttackRelease("C5", "8n", Tone.now());
                    notificationSynth.triggerAttackRelease("G5", "8n", Tone.now() + 0.2);
                });
                hasPlayedSound = true;
            }

            function showTurnNotification() {
                if (Notification.permission === "granted") {
                    new Notification("It's your turn at MediQueue!", {
                        body: "Please proceed to the doctor's room.",
                        icon: "icon-192x192.png" 
                    });
                }
            }

            function attachClinicStatusListener() {
                if (!isAuthReady || !db) return;
                const statusRef = doc(db, `artifacts/${appId}/public/data/clinicStatus/status`);
                if (clinicStatusUnsubscribe) clinicStatusUnsubscribe(); 
                clinicStatusUnsubscribe = onSnapshot(statusRef, (docSnap) => {
                    if (docSnap.exists()) {
                        clinicPasscode = docSnap.data().remotePasscode; // Store the passcode
                        currentDailyLimit = (docSnap.data().dailyLimit !== undefined) ? parseInt(docSnap.data().dailyLimit) : 999;
                        if(isNaN(currentDailyLimit)) currentDailyLimit = 999;
                    }
                    attachPatientQueueCountListener();
                }, (error) => {
                    console.error("[Patient] Error listening to clinic status:", error);
                    currentDailyLimit = 999;
                    attachPatientQueueCountListener();
                });
            }

            // --- This function's ONLY job is to check if the clinic is full.
            function attachPatientQueueCountListener() {
                if (!isAuthReady || !db) return;
                if (patientQueueCountUnsubscribe) patientQueueCountUnsubscribe();

                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const tomorrow = new Date(today);
                tomorrow.setDate(tomorrow.getDate() + 1);

                const q = query(collection(db, `artifacts/${appId}/public/data/queue`),
                                where("joinedAt", ">=", Timestamp.fromDate(today)),
                                where("joinedAt", "<", Timestamp.fromDate(tomorrow))
                                );
                patientQueueCountUnsubscribe = onSnapshot(q, (querySnapshot) => {
                    const currentCount = querySnapshot.size;
                    
                    if (currentCount >= currentDailyLimit) {
                        // Queue is full
                        if (dashboardJoinQueueBtn) dashboardJoinQueueBtn.style.display = 'none';
                        if (dashboardScanQRBtn) dashboardScanQRBtn.style.display = 'none';
                        if (queueStatusSection) queueStatusSection.style.display = 'none';
                        if (dashboardWelcome) dashboardWelcome.style.display = 'none';
                        if (dashboardShortcuts) dashboardShortcuts.style.display = 'none';
                        
                        if (queueClosedMsg) {
                            queueClosedMsg.textContent = `The clinic has reached its daily limit of ${currentDailyLimit} patients. Please check back tomorrow.`;
                            queueClosedMsg.style.display = 'block';
                        }
                    } else {
                        // Queue is open
                        if (queueClosedMsg) queueClosedMsg.style.display = 'none';
                        // attachPatientQueueListener will handle showing the join button
                    }
                }, (error) => {
                    console.error("[Patient] Error getting patient queue count:", error);
                    if (queueClosedMsg) queueClosedMsg.style.display = 'none';
                });
            }

            // --- UPDATED: This now uses the 'joinMode' variable ---
            async function joinQueue(e) {
                e.preventDefault();
                const name = patientNameInput.value.trim();
                const mobile = patientMobileInput.value.trim();
                const issue = patientIssueInput.value.trim();

                if (!name || !issue || !mobile) {
                    showModal("Please fill in your name, mobile, and reason for visit.");
                    return;
                }

                if (joinQueueBtnModal) {
                    joinQueueBtnModal.disabled = true;
                    joinQueueBtnModal.textContent = 'Joining...';
                }

                try {
                    await Tone.start();
                    const queueCollectionPath = `artifacts/${appId}/public/data/queue`;
                    await addDoc(collection(db, queueCollectionPath), {
                        name: name,
                        mobile: mobile,
                        issue: issue,
                        patientId: currentUserId,
                        status: joinMode, // <-- *** DYNAMIC STATUS ***
                        joinedAt: serverTimestamp()
                    });
                    
                    if (patientIssueInput) patientIssueInput.value = '';
                    hasPlayedSound = false;
                    if (joinQueueModal) joinQueueModal.style.display = 'none'; // Close modal on success

                } catch (error) {
                    console.error("Error joining queue:", error);
                    showModal("Could not join the queue. Please try again.");
                } finally {
                    if (joinQueueBtnModal) {
                        joinQueueBtnModal.disabled = false;
                        joinQueueBtnModal.textContent = 'Confirm & Join Queue';
                    }
                }
            }
            
            // --- UPDATED: This function now controls the dashboard UI ---
            function attachPatientQueueListener() {
                if (!isAuthReady || !db || !currentUserId) return;
                const queueCollectionPath = `artifacts/${appId}/public/data/queue`;
                
                // --- MODIFIED: Query for *both* statuses ---
                const q = query(collection(db, queueCollectionPath),
                                where("patientId", "==", currentUserId),
                                where("status", "in", ["waiting", "pre_registered"]),
                                orderBy("joinedAt", "asc"));

                if (myQueueUnsubscribe) myQueueUnsubscribe(); 
                myQueueUnsubscribe = onSnapshot(q, (querySnapshot) => {
                    if (!isAuthReady) return;
                    
                    if (querySnapshot.empty) {
                        // --- USER IS NOT IN ANY QUEUE ---
                        if (queueStatusSection) queueStatusSection.style.display = 'none';
                        if (dashboardWelcome) dashboardWelcome.style.display = 'block';
                        if (dashboardShortcuts) dashboardShortcuts.style.display = 'block';
                        hasPlayedSound = false;
                        return;
                    }

                    // --- USER IS IN A QUEUE ---
                    const myDoc = querySnapshot.docs[0]; // User can only be in one queue
                    const myData = myDoc.data();
                    
                    // Show status card, hide dashboard
                    if (queueStatusSection) queueStatusSection.style.display = 'block';
                    if (dashboardWelcome) dashboardWelcome.style.display = 'none';
                    if (dashboardShortcuts) dashboardShortcuts.style.display = 'none';
                    if (queueClosedMsg) queueClosedMsg.style.display = 'none';
                    if (queueScanCheckinBtn) queueScanCheckinBtn.style.display = 'none'; // Hide by default

                    if (myData.status === 'pre_registered') {
                        // --- USER IS "EN ROUTE" ---
                        if (queueMessageEl) queueMessageEl.textContent = "You are Pre-Registered!";
                        if (queueNumberEl) queueNumberEl.textContent = "En Route";
                        if (queueEstimateEl) queueEstimateEl.textContent = "Please check in upon arrival.";
                        if (queueStatusSection) {
                            queueStatusSection.classList.add('from-purple-500', 'to-pink-600'); // Different color
                            queueStatusSection.classList.remove('from-emerald-500', 'to-teal-600', 'animate-pulse', 'from-blue-500', 'to-indigo-600');
                        }
                        if (queueScanCheckinBtn) queueScanCheckinBtn.style.display = 'block'; // <-- SHOW CHECK-IN BTN
                        hasPlayedSound = false;

                    } else if (myData.status === 'waiting') {
                        // --- USER IS IN "LIVE" QUEUE ---
                        // Need to find their *actual* position
                        const qWaiting = query(collection(db, queueCollectionPath),
                                where("status", "==", "waiting"),
                                orderBy("joinedAt", "asc"));
                        
                        // We must re-fetch *only* the waiting list to get the position
                        getDocs(qWaiting).then(waitingSnapshot => {
                            let patientQueue = [];
                            waitingSnapshot.forEach((doc) => patientQueue.push(doc.id));
                            const myIndex = patientQueue.findIndex(id => id === myDoc.id);
                            
                            if (myIndex === -1) return; // Should not happen

                            const myQueueNumber = myIndex + 1;
                            const estimate = myIndex * 5; 
                            if (queueEstimateEl) queueEstimateEl.textContent = `~ ${estimate} min wait`;

                            if (myQueueNumber === 1) {
                                if (queueMessageEl) queueMessageEl.textContent = "It's your turn!";
                                if (queueNumberEl) queueNumberEl.textContent = "Proceed to Doctor";
                                if (queueEstimateEl) queueEstimateEl.textContent = "You are next!";
                                if (queueStatusSection) {
                                    queueStatusSection.classList.remove('from-blue-500', 'to-indigo-600', 'from-purple-500', 'to-pink-600');
                                    queueStatusSection.classList.add('from-emerald-500', 'to-teal-600', 'animate-pulse');
                                }
                                playNotificationSound();
                                showTurnNotification();
                            } else {
                                if (queueMessageEl) queueMessageEl.textContent = "Your position in queue:";
                                if (queueNumberEl) queueNumberEl.textContent = `#${myQueueNumber}`;
                                if (queueStatusSection) {
                                    queueStatusSection.classList.add('from-blue-500', 'to-indigo-600');
                                    queueStatusSection.classList.remove('from-emerald-500', 'to-teal-600', 'animate-pulse', 'from-purple-500', 'to-pink-600');
                                }
                                hasPlayedSound = false;
                            }
                        });
                    }
                }, (error) => {
                    console.error("Error with patient queue snapshot:", error);
                });
            }


            // --- 5. Patient: Visit History Logic (UPDATED) ---
            function attachHistoryListener() {
                if (!isAuthReady || !db || !currentUserId) return;
                const historyCollectionPath = `artifacts/${appId}/users/${currentUserId}/visits`;
                const q = query(collection(db, historyCollectionPath), orderBy("visitedAt", "desc"));

                historyUnsubscribe = onSnapshot(q, (querySnapshot) => {
                    if (historyList) historyList.innerHTML = '';
                    if (querySnapshot.empty) {
                        if (historyMsg) historyMsg.style.display = 'block';
                    } else {
                        if (historyMsg) historyMsg.style.display = 'none';
                        querySnapshot.forEach((doc) => {
                            const visit = doc.data();
                            const visitDate = visit.visitedAt?.toDate().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) || 'Unknown Date';
                            
                            let nextVisitHtml = '';
                            if (visit.nextVisitDate) {
                                const nextDate = visit.nextVisitDate.toDate().toLocaleDateString('en-US', {
                                    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
                                });
                                nextVisitHtml = `
                                    <div class="mt-4 pt-4 border-t border-gray-100">
                                        <p class="text-sm font-semibold text-gray-700">Next Recommended Visit:</p>
                                        <p class="text-purple-700 font-medium mt-1">${nextDate}</p>
                                    </div>
                                `;
                            }

                            const li = document.createElement('li');
                            li.className = 'bg-white shadow-lg rounded-xl p-5 mb-4 animate-fade-in border border-gray-100';
                            li.innerHTML = `
                                <div class="flex justify-between items-start">
                                    <div>
                                        <h3 class="text-lg font-semibold text-blue-600">${visitDate}</h3>
                                        <p class="text-gray-600 mt-1"><span class="font-medium">Reason:</span> ${visit.issue || 'N/A'}</p>
                                    </div>
                                    ${visit.fee ? `<p class="text-lg font-bold text-emerald-600">â‚¹${parseFloat(visit.fee).toFixed(2)}</p>` : ''}
                                </div>
                                <div class="mt-4 pt-4 border-t border-gray-100">
                                    <p class="text-sm font-semibold text-gray-700">Doctor's Notes:</p>
                                    <p class="text-gray-700 bg-gray-50 p-3 rounded-md mt-2 whitespace-pre-wrap">${visit.notes || 'No notes provided.'}</p>
                                </div>
                                ${nextVisitHtml} `;
                            if (historyList) historyList.appendChild(li);
                        });
                    }
                }, (error) => {
                    console.error("Error getting visit history:", error);
                    if (historyMsg) historyMsg.textContent = 'Could not load your visit history.';
                    if (historyMsg) historyMsg.style.display = 'block';
                });
            }

            // --- 6. Patient: Appointments Logic ---

            function populateTimeSlots() {
                if (!aptTimeSelect) return;
                aptTimeSelect.innerHTML = '<option value="">Select a time</option>';
                for (let hour = 9; hour < 17; hour++) {
                    aptTimeSelect.innerHTML += `<option value="${hour}:00">${hour}:00</option>`;
                    aptTimeSelect.innerHTML += `<option value="${hour}:30">${hour}:30</option>`;
                }
            }

            async function handleBookAppointment(e) {
                e.preventDefault();
                const dateStr = aptDateInput.value;
                const timeStr = aptTimeSelect.value;
                const reason = aptReasonInput.value.trim();

                if (!dateStr || !timeStr || !reason) {
                    showModal("Please select a date, time, and provide a reason.");
                    return;
                }

                const [year, month, day] = dateStr.split('-');
                const [hour, minute] = timeStr.split(':');
                const aptDateTime = new Date(year, month - 1, day, hour, minute);

                if (aptDateTime < new Date()) {
                    showModal("You cannot book an appointment in the past.");
                    return;
                }

                if (aptBookBtn) {
                    aptBookBtn.disabled = true;
                    aptBookBtn.textContent = 'Sending Request...';
                }

                try {
                    await Tone.start();
                    const aptCollectionPath = `artifacts/${appId}/public/data/appointments`;
                    await addDoc(collection(db, aptCollectionPath), {
                        patientId: currentUserId,
                        patientName: currentUserDisplayName,
                        reason: reason,
                        appointmentAt: Timestamp.fromDate(aptDateTime),
                        status: "pending" 
                    });
                    showModal("Appointment request sent successfully! The doctor will confirm it shortly.");
                    aptReasonInput.value = '';
                    aptTimeSelect.value = '';
                    aptDateInput.value = '';
                } catch (error) {
                    console.error("Error booking appointment:", error);
                    showModal("Could not book appointment. Please try again.");
                } finally {
                    if (aptBookBtn) {
                        aptBookBtn.disabled = false;
                        aptBookBtn.textContent = 'Send Request';
                    }
                }
            }
            
            function attachMyAppointmentListener() {
                if (!isAuthReady || !db || !currentUserId) return;

                const q = query(collectionGroup(db, "appointments"),
                                where("patientId", "==", currentUserId),
                                orderBy("appointmentAt", "asc"));

                myAppointmentsUnsubscribe = onSnapshot(q, (querySnapshot) => {
                    if (myAptList) myAptList.innerHTML = '';
                    if (querySnapshot.empty) {
                        if (myAptMsg) myAptMsg.style.display = 'block';
                    } else {
                        if (myAptMsg) myAptMsg.style.display = 'none';
                        querySnapshot.forEach((doc) => {
                            const apt = doc.data();
                            const aptDate = apt.appointmentAt?.toDate().toLocaleString('en-US', { dateStyle: 'medium', timeStyle: 'short' }) || 'Unknown Date';
                            const li = document.createElement('li');
                            
                            let statusHTML = '';
                            if (apt.status === 'confirmed') {
                                li.className = 'bg-white shadow-lg rounded-xl p-5 mb-4 animate-fade-in border-l-4 border-emerald-500';
                                statusHTML = `<div class="mt-3 text-sm font-medium text-emerald-600">Status: Confirmed</div>`;
                            } else if (apt.status === 'declined') {
                                li.className = 'bg-white shadow-lg rounded-xl p-5 mb-4 animate-fade-in border-l-4 border-red-500 opacity-70';
                                statusHTML = `<div class="mt-3 text-sm">
                                    <p class="font-medium text-red-600">Status: Declined</p>
                                    <p class="text-gray-600 mt-1"><span class="font-medium">Reason:</span> ${apt.declineReason || 'No reason provided.'}</p>
                                </div>`;
                            } else {
                                li.className = 'bg-white shadow-lg rounded-xl p-5 mb-4 animate-fade-in border-l-4 border-yellow-500';
                                statusHTML = `<div class="mt-3 text-sm font-medium text-yellow-600">Status: Pending Confirmation</div>`;
                            }
                            
                            li.innerHTML = `
                                <h3 class="text-lg font-semibold text-blue-600">${aptDate}</h3>
                                <p class="text-gray-600 mt-1"><span class="font-medium">Reason:</span> ${apt.reason || 'N/A'}</p>
                                ${statusHTML}
                            `;
                            if (myAptList) myAptList.appendChild(li);
                        });
                    }
                }, (error) => {
                    console.error("Error getting my appointments:", error);
                    if (myAptMsg) myAptMsg.textContent = 'Could not load your appointments. Check console for errors.';
                    if (myAptMsg) myAptMsg.style.display = 'block';
                });
            }

            // --- 7. Patient: Profile Logic ---

            function attachProfileListener() {
                if (!isAuthReady || !db || !currentUserId) return;
                const profileRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile/details`);
                profileUnsubscribe = onSnapshot(profileRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        if (profileNameInput) profileNameInput.value = data.name || '';
                        if (profileMobileInput) profileMobileInput.value = data.mobile || '';
                    } else {
                        if (profileNameInput) profileNameInput.value = currentUserDisplayName || '';
                    }
                }, (error) => {
                    console.error("Error getting profile:", error);
                    if (profileMsg) {
                        profileMsg.textContent = "Error loading profile.";
                        profileMsg.className = "text-sm text-red-600";
                        profileMsg.style.display = 'block';
                    }
                });
            }

            async function handleProfileUpdate(e) {
                e.preventDefault();
                if (!profileNameInput || !profileMobileInput) return;
                const newName = profileNameInput.value.trim();
                const newMobile = profileMobileInput.value.trim();

                if (!newName || !newMobile) {
                    showModal("Please fill in both name and mobile number.");
                    return;
                }

                if (profileUpdateBtn) {
                    profileUpdateBtn.disabled = true;
                    profileUpdateBtn.textContent = 'Updating...';
                }

                try {
                    await updateProfile(auth.currentUser, { displayName: newName });
                    const profileRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile/details`);
                    await setDoc(profileRef, {
                        name: newName,
                        mobile: newMobile
                    }, { merge: true });

                    if (profileMsg) {
                        profileMsg.textContent = "Profile updated successfully!";
                        profileMsg.className = "text-sm text-emerald-600";
                        profileMsg.style.display = 'block';
                    }
                    setTimeout(() => { if (profileMsg) profileMsg.style.display = 'none'; }, 3000);

                } catch (error) {
                    console.error("Error updating profile:", error);
                    if (profileMsg) {
                        profileMsg.textContent = `Error: ${error.message}`;
                        profileMsg.className = "text-sm text-red-600";
                        profileMsg.style.display = 'block';
                    }
                } finally {
                    if (profileUpdateBtn) {
                        profileUpdateBtn.disabled = false;
                        profileUpdateBtn.textContent = 'Update Profile';
                    }
                }
            }
            
            // --- Global Utilities ---
            function showModal(message) {
                if (modalMessage) modalMessage.textContent = message;
                if (modal) modal.style.display = 'flex';
            }

            function closeModal() {
                if (modal) modal.style.display = 'none';
            }

            // --- Get All DOM Elements ---
            patientApp = document.getElementById('patient-app');

            patientPages['dashboard'] = document.getElementById('patient-page-dashboard'); // <-- Renamed
            patientPages['history'] = document.getElementById('patient-page-history');
            patientPages['appointments'] = document.getElementById('patient-page-appointments');
            patientPages['profile'] = document.getElementById('patient-page-profile');

            // Top Navbar
            mainNav = document.getElementById('main-nav');
            authControls = document.getElementById('auth-controls');
            userDisplay = document.getElementById('user-display');
            logoutBtn = document.getElementById('logout-btn');
            welcomeHeader = document.getElementById('welcome-header'); // <-- NEW

            // Bottom Navbar
            bottomNav = document.getElementById('bottom-nav');
            bottomNavDashboard = document.getElementById('bottom-nav-dashboard'); // <-- Renamed
            bottomNavAppointments = document.getElementById('bottom-nav-appointments');
            bottomNavHistory = document.getElementById('bottom-nav-history');
            bottomNavProfile = document.getElementById('bottom-nav-profile');
            bottomNavItems = [bottomNavDashboard, bottomNavAppointments, bottomNavHistory, bottomNavProfile];

            // Patient: Dashboard (Replaces 'Book')
            dashboardWelcome = document.getElementById('dashboard-welcome');
            dashboardShortcuts = document.getElementById('dashboard-shortcuts');
            dashboardJoinQueueBtn = document.getElementById('dashboard-join-queue-btn');
            dashboardScanQRBtn = document.getElementById('dashboard-scan-qr-btn'); // <-- NEW
            queueStatusSection = document.getElementById('queue-status-section');
            queueMessageEl = document.getElementById('queue-message');
            queueNumberEl = document.getElementById('queue-number');
            queueEstimateEl = document.getElementById('queue-estimate');
            queueClosedMsg = document.getElementById('queue-closed-msg'); 
            queueScanCheckinBtn = document.getElementById('queue-scan-checkin-btn'); // <-- NEW

            // Join Queue Modal
            joinQueueModal = document.getElementById('join-queue-modal');
            joinQueueModalClose = document.getElementById('join-queue-modal-close');
            joinQueueForm = document.getElementById('join-queue-form');
            joinQueueBtnModal = document.getElementById('join-queue-btn-modal');
            patientNameInput = document.getElementById('patient-name');
            patientMobileInput = document.getElementById('patient-mobile');
            patientIssueInput = document.getElementById('patient-issue');
            modalStepForm = document.getElementById('modal-step-form');
            modalStepError = document.getElementById('modal-step-error');
            modalErrorMsg = document.getElementById('modal-error-msg');

            // --- *** 3. SCANNER JAVASCRIPT: Get Modal Elements *** ---
            qrScannerModal = document.getElementById('qr-scanner-modal');
            qrScannerCloseBtn = document.getElementById('qr-scanner-close-btn');

            // Patient: History
            historyList = document.getElementById('history-list');
            historyMsg = document.getElementById('history-msg');

            // Patient: Appointments
            aptDateInput = document.getElementById('apt-date');
            aptTimeSelect = document.getElementById('apt-time');
            aptReasonInput = document.getElementById('apt-reason');
            aptBookBtn = document.getElementById('apt-book-btn');
            myAptList = document.getElementById('my-apt-list');
            myAptMsg = document.getElementById('my-apt-msg');

            // Patient: Profile
            profileNameInput = document.getElementById('profile-name');
            profileMobileInput = document.getElementById('profile-mobile');
            profileUpdateBtn = document.getElementById('profile-update-btn');
            profileMsg = document.getElementById('profile-msg');
            mobileLogoutBtn = document.getElementById('mobile-logout-btn');
            installPwaBtn = document.getElementById('install-pwa-btn'); 
            
            // Global
            loadingOverlay = document.getElementById('loading-overlay');
            modal = document.getElementById('modal');
            modalMessage = document.getElementById('modal-message');
            modalCloseBtn = document.getElementById('modal-close-btn');

            // --- Add Event Listeners ---
            if (logoutBtn) logoutBtn.addEventListener('click', handleLogout); 
            if (mobileLogoutBtn) mobileLogoutBtn.addEventListener('click', handleLogout);

            // --- *** 3. SCANNER JAVASCRIPT: Add Listeners *** ---
            if (dashboardJoinQueueBtn) dashboardJoinQueueBtn.addEventListener('click', handleJoinQueueClick); 
            if (dashboardScanQRBtn) dashboardScanQRBtn.addEventListener('click', startScanner);
            if (queueScanCheckinBtn) queueScanCheckinBtn.addEventListener('click', startScanner);
            if (qrScannerCloseBtn) qrScannerCloseBtn.addEventListener('click', stopScanner);

            if (joinQueueModalClose) joinQueueModalClose.addEventListener('click', () => {
                if (joinQueueModal) joinQueueModal.style.display = 'none';
            });
            if (joinQueueForm) joinQueueForm.addEventListener('submit', joinQueue);


            if (aptDateInput) aptDateInput.min = new Date().toISOString().split('T')[0];
            if (aptDateInput) aptDateInput.valueAsDate = new Date();
            if (aptTimeSelect) populateTimeSlots();
            if (aptBookBtn) aptBookBtn.addEventListener('click', handleBookAppointment);

            if (profileUpdateBtn) profileUpdateBtn.addEventListener('click', handleProfileUpdate);

            if (modalCloseBtn) modalCloseBtn.addEventListener('click', closeModal);
            
            // --- PWA Install Prompt Logic ---
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredInstallPrompt = e;
                if (installPwaBtn) {
                    installPwaBtn.classList.remove('hidden');
                }
            });

            if (installPwaBtn) {
                installPwaBtn.addEventListener('click', async () => {
                    if (!deferredInstallPrompt) return;
                    deferredInstallPrompt.prompt();
                    const { outcome } = await deferredInstallPrompt.userChoice;
                    deferredInstallPrompt = null;
                    installPwaBtn.classList.add('hidden');
                });
            }

            window.addEventListener('appinstalled', () => {
                deferredInstallPrompt = null;
                if (installPwaBtn) {
                    installPwaBtn.classList.add('hidden');
                }
            });
            // --- END OF PWA BLOCK ---

            // Page Navigation Listeners (Bottom Nav)
            if (bottomNavDashboard) bottomNavDashboard.addEventListener('click', () => showPatientView('dashboard'));
            if (bottomNavAppointments) bottomNavAppointments.addEventListener('click', () => showPatientView('appointments'));
            if (bottomNavHistory) bottomNavHistory.addEventListener('click', () => showPatientView('history'));
            if (bottomNavProfile) bottomNavProfile.addEventListener('click', () => showPatientView('profile'));

            // --- Auth State Change Listener (Auth Guard) ---
            onAuthStateChanged(auth, async (user) => {
                isAuthReady = true;
                if (user) {
                    if (user.email === ADMIN_EMAIL) {
                        // FIX: Use absolute path
                        window.location.href = '/doctor.html';
                        return;
                    }
                    
                    // --- Valid Patient ---
                    currentUserId = user.uid;
                    currentUserEmail = user.email;
                    currentUserDisplayName = user.displayName || user.email.split('@')[0];

                    if (userDisplay) userDisplay.textContent = currentUserDisplayName;
                    if (welcomeHeader) welcomeHeader.textContent = `Welcome, ${currentUserDisplayName}!`; // <-- NEW
                    if (authControls) authControls.style.display = 'flex';
                    if (mainNav) mainNav.style.display = 'flex';
                    if (bottomNav) bottomNav.style.display = 'flex'; 
                    
                    // *** FIX: This block now runs AFTER auth is confirmed ***
                    await checkPasscodeFromURL(); // Check for URL pass first
                    const hasPass = await verifyDailyPass(); // Check localStorage
                    if (hasPass) {
                        // If they have a valid pass, check them in
                        await checkInPreRegisteredUser(); 
                    }
                    // *** END FIX ***

                    if (patientNameInput) patientNameInput.value = user.displayName || '';
                    const profileRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile/details`);
                    getDoc(profileRef).then(docSnap => {
                        if (docSnap.exists()) {
                            if (patientMobileInput) patientMobileInput.value = docSnap.data().mobile || '';
                        }
                    });

                    showPatientView('dashboard'); // <-- Default to new dashboard

                } else {
                    // --- Not Logged In ---
                    isAuthReady = false;
                    
                    // *** NEW: Check for pass *before* redirecting ***
                    // This allows a new user to scan the QR and get the pass
                    await checkPasscodeFromURL();
                    
                    // If they are still not logged in, redirect.
                    if (!auth.currentUser) {
                         window.location.href = '/index.html'; // FIX: Use absolute path
                    }
                }
            });

        }; // <-- End of window.onload
    </script>
</head>
<body class="bg-gray-100 font-sans">

    <nav class="bg-white shadow-md sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div id="main-nav" class="flex items-center justify-between h-16" style="display: none;">
                
                <div class="flex-shrink-0 flex items-center gap-2">
                    <!-- FIX: Use absolute path and correct .jpg extension -->
                    <img class="h-8 w-auto" src="/logo.jpg" alt="MediQueue Logo" onerror="this.style.display='none'">
                    <span class="font-bold text-xl text-blue-600">MediQueue</span>
                </div>
 
                <div id="auth-controls" class="hidden md:flex items-center" style="display: none;">
                    <span id="user-display" class="text-gray-700 text-sm font-medium mr-4">user@example.com</span>
                    <button id="logout-btn" class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-md text-sm font-medium">Logout</button>
                </div>

            </div>
        </div>
    </nav>

    <main class="pb-20">
        <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">

            <div id="patient-app" style="display: none;">

                <!-- =================================================================== -->
                <!-- NEW DASHBOARD PAGE (REPLACES 'patient-page-book') -->
                <!-- =================================================================== -->
                <div id="patient-page-dashboard" style="display: none;" class="px-4 space-y-6">
                    
                    <!-- Welcome Header -->
                    <div id="dashboard-welcome">
                        <h1 id="welcome-header" class="text-3xl font-bold text-gray-900">Welcome!</h1>
                        <p class="text-gray-600 mt-1">How can we help you today?</p>
                    </div>
                    
                    <!-- Queue Status Card (Shows *instead* of dashboard when active) -->
                    <div id="queue-status-section" class="mt-2 text-center p-6 sm:p-8 bg-gradient-to-br from-blue-500 to-indigo-600 text-white rounded-2xl shadow-xl" style="display: none;">
                        <h2 id="queue-message" class="text-xl sm:text-2xl font-bold mb-3">Your position in queue:</h2>
                        <p id="queue-number" class="text-7xl font-extrabold my-4">#0</p>
                        <p id="queue-estimate" class="text-lg font-medium opacity-80">~ 0 min wait</p>

                        <!-- *** 2. THE HTML: Button for "En Route" users to scan *** -->
                        <button id="queue-scan-checkin-btn" type="button" class="mt-4 w-full flex justify-center items-center gap-2 py-3 px-4 border border-white/50 rounded-xl shadow-lg text-sm font-medium text-white bg-white/20 hover:bg-white/30 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-white transition-all transform hover:-translate-y-0.5" style="display: none;">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                            Scan at Clinic to Check In
                        </button>
                    </div>

                    <!-- Queue Closed Message (Shows *instead* of dashboard when full) -->
                    <div id="queue-closed-msg" class="text-center p-5 bg-gradient-to-r from-orange-100 to-red-100 text-orange-800 rounded-xl border border-orange-200" style="display: none;">
                        <svg class="w-8 h-8 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                        <p class="font-semibold">The live queue is currently closed.</p>
                    </div>
                    
                    <!-- Dashboard Shortcuts (Hidden when in queue or queue is full) -->
                    <div id="dashboard-shortcuts" class="space-y-6">
                        <!-- Join Queue Button -->
                        <div class="grid grid-cols-2 gap-4">
                            <button id="dashboard-join-queue-btn" type="button" class="w-full flex flex-col items-center justify-center p-6 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-2xl shadow-lg transition-all transform hover:scale-105 hover:shadow-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                                <svg class="w-10 h-10 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                                <h2 class="text-lg font-bold">Join Live Queue</h2>
                                <p class="text-xs opacity-80">(From Home)</p>
                            </button>
                            <!-- *** 2. THE HTML: Button to open scanner *** -->
                            <button id="dashboard-scan-qr-btn" type="button" class="w-full flex flex-col items-center justify-center p-6 bg-gradient-to-r from-emerald-500 to-green-600 text-white rounded-2xl shadow-lg transition-all transform hover:scale-105 hover:shadow-xl focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-2">
                                <svg class="w-10 h-10 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                                <h2 class="text-lg font-bold">Scan at Clinic</h2>
                                <p class="text-xs opacity-80">(Check In)</p>
                            </button>
                        </div>

                        <!-- Shortcut Cards -->
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <button onclick="document.getElementById('bottom-nav-appointments').click()" class="flex items-center gap-4 p-4 bg-white/80 backdrop-blur-sm rounded-2xl shadow-lg border border-gray-100 transition-all transform hover:scale-105 hover:shadow-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                                <div class="flex-shrink-0 w-10 h-10 rounded-lg bg-blue-100 text-blue-600 flex items-center justify-center">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                </div>
                                <p class="font-semibold text-gray-800">Book Appointment</p>
                            </button>
                            <button onclick="document.getElementById('bottom-nav-history').click()" class="flex items-center gap-4 p-4 bg-white/80 backdrop-blur-sm rounded-2xl shadow-lg border border-gray-100 transition-all transform hover:scale-105 hover:shadow-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                                <div class="flex-shrink-0 w-10 h-10 rounded-lg bg-blue-100 text-blue-600 flex items-center justify-center">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H7a3 3 0 00-3 3v8a3 3 0 003 3z"></path></svg>
                                </div>
                                <p class="font-semibold text-gray-800">View My History</p>
                            </button>
                        </div>
                    </div>

                </div>
                
                <div id="patient-page-appointments" style="display: none;" class="px-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="bg-white/80 backdrop-blur-sm p-5 sm:p-6 rounded-2xl shadow-xl border border-gray-100">
                            <h2 class="text-2xl font-bold text-gray-900 mb-4 flex items-center gap-3">
                                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                Book a Future Slot
                            </h2>
                            <form id="apt-form" class="space-y-4">
                                <div>
                                    <label for="apt-date" class="block text-sm font-medium text-gray-700">Select Date</label>
                                    <input type="date" id="apt-date" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required>
                                </div>
                                <div>
                                    <label for="apt-time" class="block text-sm font-medium text-gray-700">Select Time</label>
                                    <select id="apt-time" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required>
                                        <option value="">Select a time</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="apt-reason" class="block text-sm font-medium text-gray-700">Reason for Appointment</label>
                                    <textarea id="apt-reason" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="e.g., Annual checkup..." required></textarea>
                                </div>
                                <button id="apt-book-btn" type="button" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-xl shadow-lg text-sm font-medium text-white bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all transform hover:-translate-y-0.5">
                                    Send Request
                                </button>
                            </form>
                        </div>
                        
                        <div class="bg-white/80 backdrop-blur-sm p-5 sm:p-6 rounded-2xl shadow-xl border border-gray-100">
                            <h2 class="text-2xl font-bold text-gray-900 mb-4 flex items-center gap-3">
                                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                My Bookings
                            </h2>
                            <div id="my-apt-msg" class="text-center p-4 bg-gray-100 text-gray-700 rounded-lg" style="display: none;">
                                You have no upcoming appointments.
                            </div>
                            <ul id="my-apt-list" class="space-y-4 max-h-96 overflow-y-auto custom-scrollbar">
                            </ul>
                        </div>
                    </div>
                </div>

                <div id="patient-page-history" style="display: none;" class="px-4">
                    <div class="bg-white/80 backdrop-blur-sm p-5 sm:p-6 rounded-2xl shadow-xl border border-gray-100 max-w-3xl mx-auto">
                        <h2 class="text-2xl font-bold text-gray-900 mb-4 flex items-center gap-3">
                            <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H7a3 3 0 00-3 3v8a3 3 0 003 3z"></path></svg>
                            My Visit History
                        </h2>
                        <div id="history-msg" class="text-center p-4 bg-gray-100 text-gray-700 rounded-lg" style="display: none;">
                            You have no visit history. Notes from your completed visits will appear here.
                        </div>
                        <ul id="history-list" class="space-y-4">
                        </ul>
                    </div>
                </div>
                
                <div id="patient-page-profile" style="display: none;" class="px-4">
                    <div class="bg-white/80 backdrop-blur-sm p-5 sm:p-6 rounded-2xl shadow-xl border border-gray-100 max-w-lg mx-auto">
                        <h2 class="text-2xl font-bold text-gray-900 mb-4 flex items-center gap-3">
                            <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                            My Profile
                        </h2>
                        <form id="profile-form" class="space-y-4">
                            <div>
                                <label for="profile-name" class="block text-sm font-medium text-gray-700">Your Name</label>
                                <input type="text" id="profile-name" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required>
                            </div>
                            <div>
                                <label for="profile-mobile" class="block text-sm font-medium text-gray-700">Mobile No.</label>
                                <input type="tel" id="profile-mobile" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Your 10-digit mobile number" required>
                            </div>
                            <button id="profile-update-btn" type="button" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-xl shadow-lg text-sm font-medium text-white bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all transform hover:-translate-y-0.5">
                                Update Profile
                            </button>
                            <div id="profile-msg" class="text-sm text-center" style="display: none;"></div>
                        </form>
                        <hr class="my-6">

                        <button id="install-pwa-btn" type="button" class="w-full hidden flex justify-center items-center gap-2 py-3 px-4 border border-transparent rounded-xl shadow-lg text-sm font-medium text-white bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all transform hover:-translate-y-0.5 mb-4">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                            Install App on this Phone
                        </button>
                        <button id="mobile-logout-btn" class="w-full flex justify-center items-center gap-2 py-3 px-4 border border-transparent rounded-xl shadow-lg text-sm font-medium text-white bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-all transform hover:-translate-y-0.5 md:hidden">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                            Logout
                        </button>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <nav id="bottom-nav" class="fixed bottom-0 left-0 right-0 h-16 bg-white/90 backdrop-blur-md border-t border-gray-200 flex md:hidden z-40" style="display: none;">
        <button id="bottom-nav-dashboard" class="flex-1 flex flex-col items-center justify-center p-2 text-sm font-medium text-gray-500 hover:text-blue-600 transition-all duration-150">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
            <span class="text-xs">Dashboard</span>
        </button>
        <button id="bottom-nav-appointments" class="flex-1 flex flex-col items-center justify-center p-2 text-sm font-medium text-gray-500 hover:text-blue-600 transition-all duration-150">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
            <span class="text-xs">Bookings</span>
        </button>
        <button id="bottom-nav-history" class="flex-1 flex flex-col items-center justify-center p-2 text-sm font-medium text-gray-500 hover:text-blue-600 transition-all duration-150">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H7a3 3 0 00-3 3v8a3 3 0 003 3z"></path></svg>
            <span class="text-xs">History</span>
        </button>
        <button id="bottom-nav-profile" class="flex-1 flex flex-col items-center justify-center p-2 text-sm font-medium text-gray-500 hover:text-blue-600 transition-all duration-150">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
            <span class="text-xs">Profile</span>
        </button>
    </nav>

    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-white"></div>
    </div>

    <!-- General Purpose Modal -->
    <div id="modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 p-4" style="display: none;">
        <div class="bg-white p-6 rounded-2xl shadow-xl max-w-sm w-full mx-4 animate-fade-in">
            <h3 class="text-lg font-medium text-gray-900">Notification</h3>
            <p id="modal-message" class="mt-2 text-sm text-gray-600">This is an alert message.</p>
            <div class="mt-4 text-right">
                <button id="modal-close-btn" type="button" class="inline-flex justify-center px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    OK
                </button>
            </div>
        </div>
    </div>

    <!-- *** Join Queue Modal *** -->
    <div id="join-queue-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50 p-4" style="display: none;">
        <div class="bg-white p-6 rounded-2xl shadow-xl max-w-md w-full mx-4 animate-fade-in">
            
            <!-- Error Step -->
            <div id="modal-step-error" style="display: none;">
                <div class="flex flex-col items-center justify-center py-8">
                    <svg class="w-16 h-16 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <p id="modal-error-msg" class="text-gray-700 font-medium mt-4 text-center">Please scan the QR code at the clinic to join.</p>
                    <button id="join-queue-modal-close" type="button" class="mt-6 inline-flex justify-center px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        OK
                    </button>
                </div>
            </div>

            <!-- Form Step -->
            <div id="modal-step-form" style="display: none;">
                <h3 class="text-2xl font-bold text-gray-900 mb-4">Join Live Queue</h3>
                <form id="join-queue-form" class="space-y-4">
                    <div>
                        <label for="patient-name" class="block text-sm font-semibold text-gray-700 mb-2">Your Name</label>
                        <input type="text" id="patient-name" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 bg-gray-50" readonly>
                    </div>
                    <div>
                        <label for="patient-mobile" class="block text-sm font-semibold text-gray-700 mb-2">Mobile No.</label>
                        <input type="tel" id="patient-mobile" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200" placeholder="Your 10-digit mobile number" required>
                    </div>
                    <div>
                        <label for="patient-issue" class="block text-sm font-semibold text-gray-700 mb-2">Reason for Visit</label>
                        <textarea id="patient-issue" rows="3" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 resize-none" placeholder="e.g., Fever, checkup..." required></textarea>
                    </div>
                    <button id="join-queue-btn-modal" type="submit" class="w-full flex justify-center items-center gap-2 py-3.5 px-6 border border-transparent rounded-xl shadow-lg text-base font-semibold text-white bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 disabled:from-gray-400 disabled:to-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all duration-200 transform hover:-translate-y-0.5 hover:shadow-xl">
                        Confirm & Join Queue
                    </button>
                </form>
            </div>

        </div>
    </div>

    <!-- *** 2. THE HTML: The Modal for the Scanner *** -->
    <div id="qr-scanner-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4" style="display: none;">
        <!-- Close button (backdrop) -->
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="document.getElementById('qr-scanner-close-btn').click()"></div>
        
        <div id="qr-reader" class="relative z-10 w-full max-w-md bg-white rounded-2xl shadow-xl overflow-hidden animate-fade-in">
            <button id="qr-scanner-close-btn" type="button" class="absolute top-2 right-2 z-20 p-2 bg-white/50 rounded-full text-gray-700 hover:bg-white">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <div class="p-4 bg-gray-100 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-center text-gray-800">Scan Clinic QR Code</h3>
            </div>
            <!-- This div is where the camera feed will appear -->
            <div id="qr-reader-region" class="w-full"></div>
            <p class="text-center text-sm text-gray-500 p-4">Align the QR code within the frame to check in.</p>
        </div>
    </div>

</body>
</html>

